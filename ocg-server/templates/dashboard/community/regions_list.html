{% import "macros/dashboard.html" as dashboard -%}

{# Regions header -#}
{{ dashboard::form_title(title = "Regions") -}}

<div class="flex justify-between items-end my-5">
  <div class="text-sm text-stone-600">
    {{ regions.len() }} region
    {% if regions.len() != 1 %}s{% endif %}
  </div>
  <div>
    <button id="add-region-button"
            hx-get="/dashboard/community/regions/add"
            hx-target="#dashboard-content"
            hx-indicator="#dashboard-spinner"
            class="btn-primary">Add Region</button>
  </div>
  <script type="module">
    const addRegionButton = document.getElementById('add-region-button');
    if (addRegionButton) {
      addRegionButton.addEventListener('htmx:afterRequest', () => {
        history.pushState({}, 'Regions list', '/dashboard/community?tab=regions');
      });
    }
  </script>
</div>

{# Regions table -#}
<div class="relative overflow-visible mt-5">
  <table class="table-auto w-full text-xs lg:text-sm text-left text-stone-500 mb-8">
    <thead class="text-xs text-stone-700 uppercase bg-stone-100 border-b border-stone-200">
      <tr>
        <th scope="col" class="px-3 xl:px-5 py-3">Name</th>
        <th scope="col" class="hidden xl:table-cell px-3 xl:px-5 py-3">Groups</th>
        <th scope="col" class="px-3 xl:px-5 py-3 w-27"></th>
      </tr>
    </thead>
    <tbody id="regions-list">
      {% if regions.is_empty() -%}
        <tr class="bg-white border-b border-stone-200">
          <td class="px-8 py-12 text-center text-stone-500" colspan="3">No regions found for this community yet.</td>
        </tr>
      {% else -%}
        {% for region in regions -%}
          {% let groups_count = region.groups_count.unwrap_or(0) -%}
          <tr class="odd:bg-white even:bg-stone-50/50 border-b border-stone-200">
            <td class="px-3 xl:px-5 py-4">
              <div class="font-medium text-stone-900">{{ region.name }}</div>
              <div class="xl:hidden text-xs text-stone-500 mt-1">
                {{ groups_count }} group
                {% if groups_count != 1 %}s{% endif %}
              </div>
            </td>
            <td class="hidden xl:table-cell px-3 xl:px-5 py-4">{{ groups_count }}</td>
            <td class="px-3 xl:px-5 py-4 w-32 xl:w-40">
              <div class="flex items-center gap-x-3">
                <button hx-get="/dashboard/community/regions/{{ region.region_id }}/update"
                        hx-target="#dashboard-content"
                        hx-indicator="#dashboard-spinner"
                        hx-swap="innerHTML show:body:top"
                        hx-disabled-elt="this"
                        class="btn-tertiary p-2"
                        aria-label="Edit region: {{ region.name }}">
                  <div class="svg-icon size-4 icon-pencil"></div>
                </button>
                <button id="delete-region-{{ region.region_id }}"
                        hx-delete="/dashboard/community/regions/{{ region.region_id }}/delete"
                        hx-target="#dashboard-content"
                        hx-indicator="#dashboard-spinner"
                        hx-trigger="confirmed"
                        class="btn-tertiary p-2
                               {% if groups_count > 0 -%}
                                 opacity-50 cursor-not-allowed
                               {% endif -%}"
                        {% if groups_count > 0 -%}
                          disabled title="This region is in use by one or more groups."
                        {% endif -%}
                        aria-label="Delete region: {{ region.name }}">
                  <div class="svg-icon size-4 icon-trash"></div>
                </button>
                <script type="module">
                  import {
                    showConfirmAlert,
                    handleHtmxResponse,
                  } from '/static/js/common/alerts.js';

                  const deleteButton = document.getElementById('delete-region-{{ region.region_id }}');
                  if (deleteButton && !deleteButton.disabled) {
                    deleteButton.addEventListener('click', () => {
                      showConfirmAlert(
                        'Are you sure you would like to delete this region?',
                        'delete-region-{{ region.region_id }}',
                        'Yes',
                      );
                    });

                    deleteButton.addEventListener('htmx:afterRequest', (e) => {
                      const xhr = e.detail?.xhr;
                      handleHtmxResponse({
                        xhr,
                        successMessage: 'You have successfully deleted the region.',
                        errorMessage: 'Something went wrong deleting this region. Please try again later.'
                      });
                    });
                  }
                </script>
              </div>
            </td>
          </tr>
        {% endfor -%}
      {% endif -%}
    </tbody>
  </table>
</div>
