{% import "macros/dashboard.html" as dashboard -%}
{% import "macros/badges.html" as badges -%}
{% import "macros/pagination.html" as pagination -%}

{{ dashboard::form_title(title = "Session proposals",
description = "Create reusable session proposals to submit to events.") -}}

{% if !pending_co_speaker_invitations.is_empty() -%}
  <div class="mt-8 mb-10">
    <div class="overflow-hidden bg-white">
      <div class="flex flex-col gap-2 border-b border-b-amber-600 border-t-4 border-t-amber-600 bg-amber-50 px-4 xl:px-5 py-3 md:flex-row md:items-center md:justify-between">
        <div class="flex items-center gap-2.5">
          <h2 class="text-lg font-semibold text-amber-900">Co-speaker invitations</h2>
          <span class="inline-flex min-w-8 items-center justify-center rounded-full border border-amber-500 bg-amber-500 px-2 py-0.5 text-xs font-semibold text-white">
            {{ pending_co_speaker_invitations.len() }}
          </span>
        </div>
        <p class="text-sm italic text-amber-800">Waiting for your response</p>
      </div>
      <div class="relative overflow-visible">
        <table class="table-auto w-full text-xs lg:text-sm text-left text-stone-500">
          <thead class="text-xs text-stone-700 uppercase bg-stone-100 border-b border-stone-200">
            <tr>
              <th scope="col" class="px-3 xl:px-5 py-3">Proposal</th>
              <th scope="col" class="px-3 xl:px-5 py-3">Invited by</th>
              <th scope="col" class="px-3 xl:px-5 py-3">Updated</th>
              <th scope="col" class="px-3 xl:px-5 py-3 w-28"></th>
            </tr>
          </thead>
          <tbody>
            {% for invitation in pending_co_speaker_invitations -%}
              <tr class="odd:bg-white even:bg-stone-50/50 border-b border-stone-200">
                <td class="px-3 xl:px-5 py-4">
                  <div class="font-medium text-stone-900 line-clamp-1">{{ invitation.session_proposal.title }}</div>
                </td>
                <td class="px-3 xl:px-5 py-4 whitespace-nowrap">{{ invitation.speaker_name }}</td>
                <td class="px-3 xl:px-5 py-4 whitespace-nowrap">
                  {% if let Some(updated_at) = invitation.session_proposal.updated_at -%}
                    {{ updated_at.format("%b %d, %Y") }}
                  {% else -%}
                    {{ invitation.session_proposal.created_at.format("%b %d, %Y") }}
                  {% endif -%}
                </td>
                <td class="px-3 xl:px-5 py-4">
                  <div class="flex items-center justify-end gap-2">
                    <button type="button"
                            class="btn-tertiary p-2"
                            data-action="view-pending-session-proposal"
                            data-session-proposal-id="{{ invitation.session_proposal.session_proposal_id }}"
                            data-session-proposal-title="{{ invitation.session_proposal.title }}"
                            aria-label="View proposal"
                            title="View proposal">
                      <div class="svg-icon size-3 md:size-4 icon-eye"></div>
                    </button>
                    <button type="button"
                            class="btn-tertiary p-2"
                            data-action="accept-co-speaker-invitation"
                            hx-put="/dashboard/user/session-proposals/{{ invitation.session_proposal.session_proposal_id }}/co-speaker-invitation/accept"
                            hx-indicator="#dashboard-spinner"
                            hx-disabled-elt="this"
                            aria-label="Accept invitation"
                            title="Accept invitation">
                      <div class="svg-icon size-3 md:size-4 icon-check"></div>
                    </button>
                    <button id="reject-co-speaker-invitation-{{ invitation.session_proposal.session_proposal_id }}"
                            type="button"
                            class="btn-tertiary p-2"
                            data-action="reject-co-speaker-invitation"
                            data-session-proposal-id="{{ invitation.session_proposal.session_proposal_id }}"
                            hx-put="/dashboard/user/session-proposals/{{ invitation.session_proposal.session_proposal_id }}/co-speaker-invitation/reject"
                            hx-trigger="confirmed"
                            hx-indicator="#dashboard-spinner"
                            hx-disabled-elt="this"
                            aria-label="Decline invitation"
                            title="Decline invitation">
                      <div class="svg-icon size-2.5 md:size-3.5 icon-cancel"></div>
                    </button>
                  </div>
                </td>
              </tr>
            {% endfor -%}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endif -%}

<div class="flex justify-between items-end my-5">
  <div class="text-sm text-stone-600">
    {{ pagination::range_display(offset = offset.unwrap_or(0) , count = session_proposals.len(), total = total, label = "session proposal") }}
  </div>
  <div>
    <button id="open-session-proposal-modal" type="button" class="btn-primary">New proposal</button>
  </div>
</div>

<div>
  <div class="relative overflow-visible">
    <table class="table-auto w-full text-xs lg:text-sm text-left text-stone-500">
      <thead class="text-xs text-stone-700 uppercase bg-stone-100 border-b border-stone-200">
        <tr>
          <th scope="col" class="px-3 xl:px-5 py-3">Proposal</th>
          <th scope="col" class="px-3 xl:px-5 py-3">Co-speaker</th>
          <th scope="col" class="px-3 xl:px-5 py-3">Updated</th>
          <th scope="col" class="px-3 xl:px-5 py-3">Status</th>
          <th scope="col" class="px-3 xl:px-5 py-3 w-28"></th>
        </tr>
      </thead>
      <tbody>
        {% if session_proposals.is_empty() -%}
          <tr class="bg-white border-b border-stone-200">
            <td class="px-8 py-16 text-center" colspan="5">
              <div class="flex flex-col items-center justify-center min-h-[125px]">
                <div class="text-lg lg:text-xl">You don't have any session proposals yet.</div>
              </div>
            </td>
          </tr>
        {% else -%}
          {% for session_proposal in session_proposals -%}
            <tr class="odd:bg-white even:bg-stone-50/50 border-b border-stone-200">
              <td class="px-3 xl:px-5 py-4">
                <div class="font-medium text-stone-900 line-clamp-1">{{ session_proposal.title }}</div>
              </td>
              <td class="px-3 xl:px-5 py-4">
                {% if let Some(co_speaker) = &session_proposal.co_speaker -%}
                  <div class="flex items-center space-x-3">
                    <logo-image
                    {% if let Some(photo_url) = &co_speaker.photo_url -%}
                      image-url="{{ photo_url }}"
                    {% endif -%}
                    size="size-8" placeholder="{{ self::user_initials(co_speaker.name.as_deref() , co_speaker.username.as_str()) }}">
                    </logo-image>
                    <div class="font-medium text-stone-900">
                      {{ co_speaker.name.as_deref().unwrap_or(&co_speaker.username) }}
                    </div>
                  </div>
                {% endif -%}
              </td>
              <td class="px-3 xl:px-5 py-4 whitespace-nowrap">
                {% if let Some(updated_at) = &session_proposal.updated_at -%}
                  {{ updated_at.format("%b %d, %Y") }}
                {% else -%}
                  {{ session_proposal.created_at.format("%b %d, %Y") }}
                {% endif -%}
              </td>
              <td class="px-3 xl:px-5 py-4">
                {% if session_proposal.linked_session_id.is_some() -%}
                  {{ badges::status_badge(label = "Linked", published = true, extra_styles = Some("px-2.5 py-0.5 uppercase") , title = "This session proposal has been approved and linked to an event's session.") -}}
                {% else if session_proposal.has_submissions -%}
                  {{ badges::status_badge(label = "Submitted", extra_styles = Some("px-2.5 py-0.5 uppercase") , title = "This proposal has already been submitted to at least one event call for speakers.") -}}
                {% else if session_proposal.session_proposal_status_id == "ready-for-submission" -%}
                  {{ badges::status_badge(label = session_proposal.status_name.as_str() , published = true, extra_styles = Some("px-2.5 py-0.5 uppercase") , title = "This proposal can be submitted to event call for speakers.") -}}
                {% else if session_proposal.session_proposal_status_id == "declined-by-co-speaker" -%}
                  {{ badges::status_badge(label = session_proposal.status_name.as_str() , canceled = true, extra_styles = Some("px-2.5 py-0.5 uppercase") , title = "The invited co-speaker declined this proposal.") -}}
                {% else -%}
                  {{ badges::status_badge(label = session_proposal.status_name.as_str() , extra_styles = Some("px-2.5 py-0.5 uppercase") , title = "This proposal is waiting for co-speaker response.") -}}
                {% endif -%}
              </td>
              <td class="px-3 xl:px-5 py-4">
                <div class="flex items-center justify-end gap-2">
                  {% set edit_disabled = session_proposal.linked_session_id.is_some() -%}
                  <button type="button"
                          class="btn-tertiary p-2
                                 {% if edit_disabled %}opacity-50 cursor-not-allowed{% endif %}"
                          data-session-proposal='{{ session_proposal|json }}'
                          data-proposal-description-html='{{ session_proposal.description|md_to_html|json }}'
                          data-action="edit-session-proposal"
                          {% if edit_disabled %}
                            disabled title="Linked proposals cannot be edited"
                          {% else %}
                            title="Edit proposal"
                          {% endif %}>
                    <div class="svg-icon size-3 md:size-4 icon-pencil"></div>
                  </button>
                  <button type="button"
                          class="btn-tertiary p-2"
                          data-session-proposal='{{ session_proposal|json }}'
                          data-proposal-description-html='{{ session_proposal.description|md_to_html|json }}'
                          data-action="view-session-proposal"
                          title="View proposal">
                    <div class="svg-icon size-3 md:size-4 icon-eye"></div>
                  </button>
                  {% set delete_disabled = session_proposal.has_submissions
                                    || session_proposal.linked_session_id.is_some() -%}
                  <button type="button"
                          class="btn-tertiary p-2
                                 {% if delete_disabled %}opacity-50 cursor-not-allowed{% endif %}"
                          data-action="delete-session-proposal"
                          data-session-proposal-id="{{ session_proposal.session_proposal_id }}"
                          hx-delete="/dashboard/user/session-proposals/{{ session_proposal.session_proposal_id }}"
                          hx-trigger="confirmed"
                          hx-indicator="#dashboard-spinner"
                          hx-disabled-elt="this"
                          {% if delete_disabled %}
                            disabled title="Submitted proposals cannot be deleted"
                          {% else %}
                            title="Delete proposal"
                          {% endif %}>
                    <div class="svg-icon size-3 md:size-4 icon-trash"></div>
                  </button>
                </div>
              </td>
            </tr>
          {% endfor -%}
        {% endif -%}
      </tbody>
    </table>
  </div>
</div>

{% if total > session_proposals.len() -%}
  {{ pagination::navigation_links(links = navigation_links, hx_target = "#dashboard-content", hx_indicator = "#dashboard-spinner") }}
{% endif -%}

{# Session proposal modal -#}
<session-proposal-modal id="session-proposal-modal-component" session-proposal-levels='{{ session_proposal_levels|json }}' title-max-length="{{ crate::validation::MAX_LEN_ENTITY_NAME }}" description-max-length="{{ crate::validation::MAX_LEN_DESCRIPTION }}" duration-max="{{ crate::validation::MAX_SESSION_PROPOSAL_DURATION_MINUTES }}"></session-proposal-modal>
