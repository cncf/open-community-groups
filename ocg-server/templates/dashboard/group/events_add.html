{% import "macros/dashboard.html" as dashboard -%}

{# Events form -#}
<div class="space-y-12">
  <div class="space-y-3 w-full">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <label for="copy-event-selector" class="form-label m-0">
        Choose an event to copy <span class="font-semibold">from</span> (optional)
      </label>
      <div data-copy-indicator
           id="copy-event-feedback"
           class="hidden items-center gap-2 text-sm text-primary-600"
           aria-live="polite">
        <svg-spinner size="size-4" label="Copying event">
        </svg-spinner>
        <span>Copying event...</span>
      </div>
    </div>
    <event-selector button-id="copy-event-selector" group-id="{{ group_id }}"></event-selector>
    <p class="form-legend mt-3">
      Start and end dates, as well as session times, are left blank so you can set the
      new schedule. Meeting links are not carried over. When copying from events imported from the previous community platform,
      some fields like event's hosts and speakers won't be copied. Note that this only
      applies to events that have not been created from Open Community Groups.
    </p>
  </div>

  <ul class="flex flex-wrap space-x-2 -mb-px text-xs lg:text-sm font-medium text-center border-b border-stone-900/10 w-full mb-10">
    <li>
      <button type="button"
              data-section="details"
              data-active="true"
              class="w-20 lg:w-28 xl:w-40 cursor-pointer inline-flex items-center justify-center p-4 pt-0 border-b-2 border-transparent rounded-t-lg hover:text-stone-600 hover:border-stone-300 active data-[active=true]:text-primary-500 data-[active=true]:border-primary-500 group text-nowrap">
        <div class="svg-icon size-3 me-2 icon-event bg-stone-400 group-hover:bg-stone-500 group-[.active]:bg-primary-500 shrink-0">
        </div>
        Details
      </button>
    </li>
    <li>
      <button type="button"
              data-section="date-venue"
              data-active="false"
              class="w-20 lg:w-28 xl:w-40 cursor-pointer inline-flex items-center justify-center p-4 pt-0 border-b-2 border-transparent rounded-t-lg hover:text-stone-600 hover:border-stone-300 data-[active=true]:text-primary-500 data-[active=true]:border-primary-500 group text-nowrap">
        <div class="svg-icon size-3 me-2 icon-calendar bg-stone-400 group-hover:bg-stone-500 group-[.active]:bg-primary-500 shrink-0">
        </div>
        <span class="hidden lg:inline">Date & Venue</span>
        <span class="lg:hidden">Schedule</span>
      </button>
    </li>
    <li>
      <button type="button"
              data-section="hosts-sponsors"
              data-active="false"
              class="w-20 lg:w-28 xl:w-40 cursor-pointer inline-flex items-center justify-center p-4 pt-0 border-b-2 border-transparent rounded-t-lg hover:text-stone-600 hover:border-stone-300 data-[active=true]:text-primary-500 data-[active=true]:border-primary-500 group text-nowrap">
        <div class="svg-icon size-3 me-2 icon-user-plus bg-stone-400 group-hover:bg-stone-500 group-[.active]:bg-primary-500 shrink-0">
        </div>
        <span class="hidden xl:inline">Hosts & Speakers</span>
        <span class="xl:hidden">Hosts</span>
      </button>
    </li>
    <li>
      <button type="button"
              data-section="sessions"
              data-active="false"
              class="w-20 lg:w-28 xl:w-40 cursor-pointer inline-flex items-center justify-center p-4 pt-0 border-b-2 border-transparent rounded-t-lg hover:text-stone-600 hover:border-stone-300 data-[active=true]:text-primary-500 data-[active=true]:border-primary-500 group text-nowrap">
        <div class="svg-icon size-3 me-2 icon-presentation bg-stone-400 group-hover:bg-stone-500 group-[.active]:bg-primary-500 shrink-0">
        </div>
        Sessions
      </button>
    </li>
  </ul>

  <div>
    <div class="space-y-12">
      {# Event Details Tab -#}
      <div data-content="details">
        <form id="details-form">
          <div class="pb-12">
            <p class="mt-1 text-sm/6 text-stone-500">Please add as many details about this event as possible.</p>

            <div class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 md:grid-cols-6 max-w-5xl">
              {# Event name -#}
              <div class="col-span-full lg:col-span-3">
                <label for="name" class="form-label">
                  Name <span class="asterisk">*</span>
                </label>
                <div class="mt-2">
                  <input type="text"
                         name="name"
                         id="name"
                         maxlength="{{ crate::validation::MAX_LEN_ENTITY_NAME }}"
                         class="input-primary"
                         autocomplete="off"
                         autocorrect="off"
                         autocapitalize="off"
                         spellcheck="false"
                         required>
                </div>
                <p class="form-legend">
                  Display name of the event (e.g. Kubernetes Amsterdam Meetup). Max {{ crate::validation::MAX_LEN_ENTITY_NAME }} characters.
                </p>
              </div>
              {# End Event name -#}

              <div class="col-span-3"></div>

              {# Event kind -#}
              <div class="col-span-full lg:col-span-3">
                <label for="kind_id" class="form-label">
                  Event Type <span class="asterisk">*</span>
                </label>
                <div class="mt-2 grid grid-cols-1">
                  <select id="kind_id" name="kind_id" class="select-primary" required>
                    <option value="">Select an event type</option>
                    {% for kind in event_kinds %}
                      <option value="{{ kind.event_kind_id }}">{{ kind.display_name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <p class="form-legend">Whether this is an in-person, virtual, or hybrid event.</p>
              </div>
              {# End Event kind -#}

              {# Event category -#}
              <div class="col-span-full lg:col-span-3">
                <label for="category_id" class="form-label">
                  Category <span class="asterisk">*</span>
                </label>
                <div class="mt-2 grid grid-cols-1">
                  <select id="category_id" name="category_id" class="select-primary" required>
                    <option value="">Select a category</option>
                    {% for category in categories %}
                      <option value="{{ category.event_category_id }}">{{ category.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <p class="form-legend">Type of event or meetup.</p>
              </div>
              {# End Event category -#}

              {# Logo URL -#}
              <div class="col-span-full lg:col-span-4">
                <image-field class="w-full block" label="Logo" name="logo_url" image-kind="logo" target="logo" legend="If this logo isn't provided, we'll fall back to the group logo, then the community logo if needed.">
              </image-field>
            </div>
            {# End Logo URL -#}

            {# Banner URL -#}
            <div class="col-span-full">
              <image-field class="w-full block" label="Banner" name="banner_url" image-kind="banner" help-prefix-text="Size required 2428 x 192 px." target="banner" legend="If this banner isn't provided, we'll fall back to the group banner, then the community banner if needed.">
            </image-field>
          </div>
          {# End Banner URL -#}

          {# Banner Mobile URL -#}
          <div class="col-span-full">
            <image-field class="w-full block" label="Banner Mobile" name="banner_mobile_url" image-kind="banner" help-prefix-text="Size required 1220 x 192 px." target="banner_mobile" legend="If this banner isn't provided, we'll fall back to the group banner, then the community banner if needed.">
          </image-field>
        </div>
        {# End Banner Mobile URL -#}

        {# Short Description -#}
        <div class="col-span-full">
          <label for="description_short" class="form-label">Short Description</label>
          <div class="mt-2">
            <input type="text"
                   id="description_short"
                   name="description_short"
                   class="input-primary"
                   maxlength="{{ crate::validation::MAX_LEN_DESCRIPTION_SHORT }}" />
          </div>
          <p class="form-legend">
            Brief description used in event listings and previews. Max {{ crate::validation::MAX_LEN_DESCRIPTION_SHORT }} characters.
          </p>
        </div>
        {# End Short Description -#}

        {# Event Description -#}
        <div class="col-span-full">
          <label for="description" class="form-label">
            Description <span class="asterisk">*</span>
          </label>
          <div class="mt-2">
            <markdown-editor id="description" name="description" maxlength="{{ crate::validation::MAX_LEN_DESCRIPTION }}" required></markdown-editor>
          </div>
          <p class="form-legend">
            Full description of the event and its purpose. Max {{ crate::validation::MAX_LEN_DESCRIPTION }} characters.
          </p>
        </div>
        {# End Event Description -#}
      </div>
    </div>

    {# Call for Speakers section -#}
    <div class="border-t border-stone-900/10 py-12">
      {{ dashboard::form_title(title = "Call for Speakers", description = "Collect session proposals ahead of the event.") -}}

      <div class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 md:grid-cols-6 max-w-5xl">
        {# Enable CFS toggle -#}
        <div class="col-span-full lg:col-span-3">
          <label class="inline-flex items-center cursor-pointer">
            <input id="toggle_cfs_enabled"
                   name="toggle_cfs_enabled"
                   value="enabled"
                   type="checkbox"
                   class="sr-only peer">
            <input type="hidden" id="cfs_enabled" name="cfs_enabled" value="false">
            <div class="relative w-11 h-6 bg-stone-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-stone-300 after:border after:border-stone-200 after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-500">
            </div>
            <span class="ms-3 text-sm font-medium text-stone-900">Enable Call for Speakers</span>
          </label>
          <p class="form-legend">Allow speakers to submit session proposals.</p>
        </div>
        {# End Enable CFS toggle -#}

        <div class="col-span-3"></div>

        {# Opens at -#}
        <div class="col-span-full lg:col-span-3">
          <label for="cfs_starts_at" class="form-label">Opens at</label>
          <div class="mt-2">
            <input type="datetime-local"
                   name="cfs_starts_at"
                   id="cfs_starts_at"
                   class="input-primary">
          </div>
          <p class="form-legend">When submissions open.</p>
        </div>
        {# End Opens at -#}

        {# Closes at -#}
        <div class="col-span-full lg:col-span-3">
          <label for="cfs_ends_at" class="form-label">Closes at</label>
          <div class="mt-2">
            <input type="datetime-local"
                   name="cfs_ends_at"
                   id="cfs_ends_at"
                   class="input-primary">
          </div>
          <p class="form-legend">When submissions close.</p>
        </div>
        {# End Closes at -#}

        {# CFS description -#}
        <div class="col-span-full">
          <label for="cfs_description" class="form-label">CFS description</label>
          <div class="mt-2">
            <markdown-editor id="cfs_description" name="cfs_description" maxlength="{{ crate::validation::MAX_LEN_DESCRIPTION }}"></markdown-editor>
          </div>
          <p class="form-legend">Shown on the event page to invite speakers.</p>
        </div>
        {# End CFS description -#}
      </div>
    </div>
    {# End Call for Speakers section -#}

    {# Additional Information section -#}
    <div class="border-t border-stone-900/10 pt-12">
      {{ dashboard::form_title(title = "Additional Information", description = "Optional event settings and external links.") -}}

      <div class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 md:grid-cols-6 max-w-5xl">
        {# Capacity -#}
        <div class="col-span-full lg:col-span-4">
          <label for="capacity" class="form-label">
            Capacity
            {%- if meetings_enabled %}
              <span class="asterisk">* <sup class="text-xs font-normal">(required when requesting automatic meeting creation)</sup></span>
            {%- endif -%}
          </label>
          <div class="mt-2">
            <input type="number"
                   name="capacity"
                   id="capacity"
                   min="1"
                   class="input-primary"
                   placeholder="100">
          </div>
          <p class="form-legend">
            Maximum number of attendees.
            {%- if meetings_enabled %}
              <br />
              Note: Meeting providers have participant limits. If capacity exceeds your provider
              limit, attendees may be unable to join the meeting.
            {%- endif -%}
          </p>
        </div>
        {# End Capacity -#}

        {# Registration required -#}
        <div class="col-span-full lg:col-span-3">
          <label class="inline-flex items-center cursor-pointer">
            <input id="toggle_registration_required"
                   name="toggle_registration_required"
                   value="required"
                   type="checkbox"
                   class="sr-only peer">
            <input type="hidden"
                   id="registration_required"
                   name="registration_required"
                   value="false">
            <div class="relative w-11 h-6 bg-stone-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-stone-300 after:border after:border-stone-200 after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-500">
            </div>
            <span class="ms-3 text-sm font-medium text-stone-900">Registration Required</span>
          </label>
          <p class="form-legend">Whether attendees must register in advance.</p>
        </div>
        {# End Registration required -#}

        {# Meetup URL -#}
        <div class="col-span-full lg:col-span-3">
          <label for="meetup_url" class="form-label">Meetup.com URL</label>
          <div class="mt-2">
            <input type="url"
                   name="meetup_url"
                   id="meetup_url"
                   class="input-primary"
                   placeholder="https://meetup.com/group/events/123456">
          </div>
          <p class="form-legend">Link to the Meetup.com event page.</p>
        </div>
        {# End Meetup URL -#}

        <div class="col-span-3"></div>

        {# Photos -#}
        <div class="col-span-full">
          <gallery-field field-name="photos_urls" legend="Optional photos related to the event." max-images="0" label="Photos"></gallery-field>
        </div>
        {# End Photos -#}

        {# Tags -#}
        <div class="col-span-3">
          <label for="tags" class="form-label">Tags</label>
          <div class="mt-2">
            <multiple-inputs field-name="tags" input-type="text" label="Tag" legend="Optional tags to help categorize and find the event.">
            </multiple-inputs>
          </div>
        </div>
        {# End Tags -#}
      </div>
    </div>
    {# End additional information section -#}
  </form>
</div>
{# End Event Details Tab -#}

{# Date & Venue Tab -#}
<div data-content="date-venue" class="hidden">
  <form id="date-venue-form">
    <div class="space-y-12">
      {# Date and Time section -#}
      <div>
        <p class="mt-1 text-sm/6 text-stone-500">When will this event take place?</p>
        <div class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 md:grid-cols-6 max-w-5xl">
          {# Timezone -#}
          <div class="col-span-full lg:col-span-3">
            <label class="form-label">
              Timezone <span class="asterisk">*</span>
            </label>
            <div class="mt-2">
              <timezone-selector name="timezone" timezones="{{ timezones|json }}" required></timezone-selector>
            </div>
            <p class="form-legend">Timezone for event times (e.g. America/New_York, Europe/Amsterdam).</p>
          </div>
          {# End Timezone -#}

          <div class="col-span-3"></div>

          {# Start date/time -#}
          <div class="col-span-full lg:col-span-3">
            <label for="starts_at" class="form-label">Start Date & Time</label>
            <div class="mt-2">
              <input type="datetime-local"
                     name="starts_at"
                     id="starts_at"
                     class="input-primary">
            </div>
            <p class="form-legend">When the event starts.</p>
          </div>
          {# End Start date/time -#}

          {# End date/time -#}
          <div class="col-span-full lg:col-span-3">
            <label for="ends_at" class="form-label">End Date & Time</label>
            <div class="mt-2">
              <input type="datetime-local"
                     name="ends_at"
                     id="ends_at"
                     class="input-primary">
            </div>
            <p class="form-legend">When the event ends.</p>
          </div>
          {# End End date/time -#}
        </div>
      </div>
      {# End date and time section -#}

      {# Venue Information section -#}
      <div id="venue-information-section"
           class="border-t border-stone-900/10 pt-12">
        {{ dashboard::form_title(title = "Venue Information",
                description = "Location details for in-person and hybrid events.",
                button = "<button id='clear-location-fields'
                type='button'
                class='btn-primary-outline btn-mini whitespace-nowrap'
                aria-label='Clear location details'>Clear location</button>") -}}

        <div class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 md:grid-cols-6 max-w-5xl">
          {# Location search -#}
          <div class="col-span-full">
            <location-search-field placeholder-text="Search for a venue or address..." venue-name-field-name="venue_name" venue-address-field-name="venue_address" venue-city-field-name="venue_city" venue-zip-code-field-name="venue_zip_code" latitude-field-name="latitude" longitude-field-name="longitude" map-enabled>
            </location-search-field>
          </div>
          {# End location search -#}
        </div>
      </div>
      {# End venue information section -#}

      {# Online Event Details section -#}
      <div id="online-event-details-section"
           class="border-t border-stone-900/10 pt-12">
        {{ dashboard::form_title(title = "Online Event Details", description = "Meeting information for virtual and hybrid events.") -}}
        <div class="mt-10 max-w-5xl">
          {% if meetings_enabled %}
            <online-event-details id="online-event-details" kind="virtual" meeting-max-participants="{{ meetings_max_participants|json }}"></online-event-details>
          {% else %}
            <div class="space-y-6">
              <div class="grid grid-cols-1 gap-6">
                <div class="space-y-2">
                  <label for="meeting_join_url" class="form-label">Meeting URL</label>
                  <div class="mt-2">
                    <input type="url"
                           id="meeting_join_url"
                           name="meeting_join_url"
                           class="input-primary"
                           placeholder="https://meet.example.com/123456789">
                  </div>
                  <p class="form-legend">Teams, Meet, or any other video link.</p>
                </div>
                <div class="space-y-2">
                  <label for="meeting_recording_url" class="form-label">Recording URL (optional)</label>
                  <div class="mt-2">
                    <input type="url"
                           id="meeting_recording_url"
                           name="meeting_recording_url"
                           class="input-primary"
                           placeholder="https://youtube.com/watch?v=...">
                  </div>
                  <p class="form-legend">Add a recording link now or after the event.</p>
                </div>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
      {# End online event details section -#}
    </div>
  </form>
</div>
{# End Date & Venue Tab -#}

{# Sessions Tab -#}
<div data-content="sessions" class="hidden">
  <form id="sessions-form">
    <div class="pb-12">
      <div class="mt-10">
        <sessions-section session-kinds="{{ session_kinds|json }}" meeting-max-participants="{{ meetings_max_participants|json }}" description-max-length="{{ crate::validation::MAX_LEN_DESCRIPTION }}"
        {% if meetings_enabled %}meetings-enabled{% endif %}
        ></sessions-section>
      </div>
    </div>
  </form>
</div>
{# End Sessions Tab -#}

{# Hosts & Speakers Tab -#}
<div data-content="hosts-sponsors" class="hidden">
  <form id="hosts-sponsors-form">
    <div class="space-y-12">
      {# Hosts Section -#}
      <div class="border-b border-stone-900/10 pb-12">
        <div class="text-xl lg:text-2xl font-medium text-stone-900">Event Hosts</div>
        <div class="mt-5">
          <user-search-selector field-name="hosts" dashboard-type="group" label="host" legend="Search for event organizers or hosts by their username"></user-search-selector>
        </div>
      </div>
      {# End Hosts Section -#}

      {# Event Speakers Section -#}
      <div class="border-b border-stone-900/10 pb-12">
        <div class="text-xl lg:text-2xl font-medium text-stone-900">Event Speakers</div>
        <div class="mt-5">
          <speakers-selector dashboard-type="group" field-name-prefix="speakers" show-add-button label="Speakers" help-text="Add speakers or presenters for this event."></speakers-selector>
        </div>
      </div>
      {# End Event Speakers Section -#}

      {# Sponsors Section -#}
      <div class="pb-12">
        <div class="text-xl lg:text-2xl font-medium text-stone-900">Event Sponsors</div>
        <div class="mt-5">
          <sponsors-section sponsors="{{ sponsors|json }}"></sponsors-section>
        </div>
      </div>
      {# End Sponsors Section -#}
    </div>
  </form>
</div>
{# End Hosts & Speakers Tab -#}

</div>

{# Form buttons -#}
<div class="flex items-center justify-end space-x-5 mt-6">
  {# Cancel button -#}
  <div>
    <button id="cancel-button"
            type="button"
            hx-get="/dashboard/group?tab=events"
            hx-target="body"
            hx-indicator="#dashboard-spinner"
            class="btn-primary-outline w-24">Cancel</button>
  </div>
  {# End cancel button -#}

  {# Save button -#}
  <div>
    <button id="add-event-button"
            type="button"
            class="btn-primary w-24 text-nowrap"
            hx-post="/dashboard/group/events/add"
            hx-ext="no-empty-vals"
            hx-include="#details-form, #date-venue-form, #sessions-form, #hosts-sponsors-form"
            hx-target="#dashboard-content"
            hx-indicator="#dashboard-spinner"
            hx-disabled-elt="#add-event-button, #cancel-button"
            hx-exclude="[name=toggle_registration_required], [name=toggle_meeting_requested], [name=toggle_cfs_enabled]">
      Add
    </button>
  </div>
  {# End save button -#}
</div>
{# End form buttons -#}
</div>
</div>

<script type="module">
  import {
    convertDateTimeLocalToISO
  } from '/static/js/common/common.js';
  import {
    handleHtmxResponse
  } from '/static/js/common/alerts.js';
  import {
    validateMeetingRequest,
    hasVenueData,
    clearVenueFields,
    confirmVenueDataDeletion,
    updateSectionVisibility
  } from '/static/js/dashboard/group/meeting-validations.js';
  import {
    parseLocalDate,
    validateCfsWindow,
    validateEventDates,
    validateSessionDateBounds
  } from '/static/js/common/form-validation.js';

  const addEventButton = document.getElementById('add-event-button');
  const cancelButton = document.getElementById('cancel-button');
  const kindSelect = document.getElementById('kind_id');
  const onlineEventDetails = document.getElementById('online-event-details');

  // Tab switching functionality
  function displayActiveSection(sectionName) {
    // Update tab buttons
    const tabButtons = document.querySelectorAll('[data-section]');
    tabButtons.forEach(btn => {
      if (btn.getAttribute('data-section') === sectionName) {
        btn.setAttribute('data-active', 'true');
        btn.classList.add('active');
      } else {
        btn.setAttribute('data-active', 'false');
        btn.classList.remove('active');
      }
    });

    // Update content sections
    const contentSections = document.querySelectorAll('[data-content]');
    contentSections.forEach(section => {
      if (section.getAttribute('data-content') === sectionName) {
        section.classList.remove('hidden');
      } else {
        section.classList.add('hidden');
      }
    });
  }

  // Validate multiple forms
  function validateEventForms() {
    const formSections = ['details', 'date-venue', 'sessions', 'hosts-sponsors'];

    for (const formName of formSections) {
      const formElement = document.getElementById(`${formName}-form`);

      if (formElement && !formElement.checkValidity()) {
        displayActiveSection(formName);
        requestAnimationFrame(() => setTimeout(() => formElement.reportValidity(), 0));
        return false;
      }
    }

    return true;
  }

  function validateSessionOnlineDetails() {
    const sessionsSection = document.querySelector('sessions-section');
    if (!sessionsSection) {
      return true;
    }

    const sessionOnlineDetails = sessionsSection.querySelectorAll('online-event-details');
    const displaySessionsSection = () => displayActiveSection('sessions');

    for (const component of sessionOnlineDetails) {
      if (!component.validate(displaySessionsSection)) {
        displaySessionsSection();
        return false;
      }
    }

    return true;
  }

  // Add event listeners to tab buttons
  const sectionsBtn = document.querySelectorAll('[data-section]');
  sectionsBtn.forEach((btn) => {
    btn.addEventListener('click', () => {
      const section = btn.getAttribute('data-section');
      displayActiveSection(section);
    });
  });

  // Handle registration required toggle
  const toggleRegistrationRequired = document.getElementById('toggle_registration_required');
  if (toggleRegistrationRequired) {
    toggleRegistrationRequired.addEventListener('change', () => {
      document.getElementById('registration_required').value = toggleRegistrationRequired.checked;
    });
  }

  const toggleCfsEnabled = document.getElementById('toggle_cfs_enabled');
  const cfsEnabledInput = document.getElementById('cfs_enabled');
  const cfsStartsAtInput = document.getElementById('cfs_starts_at');
  const cfsEndsAtInput = document.getElementById('cfs_ends_at');
  const cfsDescriptionInput = document.getElementById('cfs_description');

  const updateCfsFields = (enabled) => {
    if (cfsEnabledInput) {
      cfsEnabledInput.value = enabled ? 'true' : 'false';
    }
    if (cfsStartsAtInput) {
      cfsStartsAtInput.disabled = !enabled;
      cfsStartsAtInput.required = enabled;
    }
    if (cfsEndsAtInput) {
      cfsEndsAtInput.disabled = !enabled;
      cfsEndsAtInput.required = enabled;
    }
    if (cfsDescriptionInput) {
      cfsDescriptionInput.disabled = !enabled;
      cfsDescriptionInput.required = enabled;
    }
  };

  if (toggleCfsEnabled) {
    updateCfsFields(toggleCfsEnabled.checked);
    toggleCfsEnabled.addEventListener('change', () => {
      updateCfsFields(toggleCfsEnabled.checked);
    });
  }

  // Update component kind when event kind changes
  if (kindSelect) {
    let previousKindValue = kindSelect.value;
    updateSectionVisibility(kindSelect.value || '');
    if (onlineEventDetails) {
      onlineEventDetails.kind = kindSelect.value;
    }

    kindSelect.addEventListener('change', async () => {
      const newValue = kindSelect.value;

      if (newValue === 'virtual' && hasVenueData()) {
        const confirmed = await confirmVenueDataDeletion();
        if (!confirmed) {
          kindSelect.value = previousKindValue;
          updateSectionVisibility(kindSelect.value || '');
          if (onlineEventDetails) {
            onlineEventDetails.kind = kindSelect.value;
          }
          return;
        }
        clearVenueFields();
      }

      // Check if change would disable automatic meetings
      if (onlineEventDetails) {
        const accepted = await onlineEventDetails.trySetKind(newValue);
        if (!accepted) {
          kindSelect.value = previousKindValue;
          updateSectionVisibility(kindSelect.value || '');
          return;
        }
      }

      previousKindValue = newValue;
      updateSectionVisibility(newValue);
    });
  } else {
    updateSectionVisibility('');
  }

  // Update component starts/ends times when they change for validation
  const startsAtInput = document.getElementById('starts_at');
  const endsAtInput = document.getElementById('ends_at');
  let previousStartsAt = startsAtInput?.value || '';
  let previousEndsAt = endsAtInput?.value || '';

  if (startsAtInput) {
    startsAtInput.addEventListener('change', () => {
      startsAtInput.setCustomValidity('');
    });
  }
  if (endsAtInput) {
    endsAtInput.addEventListener('change', () => {
      endsAtInput.setCustomValidity('');
    });
  }

  if (startsAtInput && onlineEventDetails) {
    startsAtInput.addEventListener('change', async () => {
      const accepted = await onlineEventDetails.trySetStartsAt(startsAtInput.value);
      if (!accepted) {
        startsAtInput.value = previousStartsAt;
        return;
      }
      previousStartsAt = startsAtInput.value;
    });
  }
  if (endsAtInput && onlineEventDetails) {
    endsAtInput.addEventListener('change', async () => {
      const accepted = await onlineEventDetails.trySetEndsAt(endsAtInput.value);
      if (!accepted) {
        endsAtInput.value = previousEndsAt;
        return;
      }
      previousEndsAt = endsAtInput.value;
    });
  }

  if (cancelButton) {
    cancelButton.addEventListener('htmx:afterRequest', () => {
      history.pushState({}, "Events list", '/dashboard/group?tab=events');
    });
  }

  if (addEventButton) {
    // Validation before form submission
    addEventButton.addEventListener('htmx:beforeRequest', (e) => {
      if (e.detail.elt.id === 'add-event-button') {
        // Use multiple form validation
        const isValid = validateEventForms();
        const eventStartsAt = parseLocalDate(startsAtInput?.value);
        const eventEndsAt = parseLocalDate(endsAtInput?.value);
        const datesValid = validateEventDates({
          startsInput: startsAtInput,
          endsInput: endsAtInput,
          allowPastDates: false,
          onDateSection: () => displayActiveSection('date-venue'),
        });
        const cfsValid = validateCfsWindow({
          cfsEnabledInput,
          cfsStartsInput: cfsStartsAtInput,
          cfsEndsInput: cfsEndsAtInput,
          eventStartsInput: startsAtInput,
          onDateSection: () => displayActiveSection('date-venue'),
        });

        if (!datesValid || !cfsValid) {
          e.preventDefault();
          e.stopImmediatePropagation();
          return false;
        }

        // Validate online event details component
        let onlineValid = true;
        if (onlineEventDetails) {
          onlineEventDetails.startsAt = startsAtInput?.value || '';
          onlineEventDetails.endsAt = endsAtInput?.value || '';
          onlineValid = onlineEventDetails.validate(displayActiveSection);
        }

        const sessionsOnlineValid = validateSessionOnlineDetails();
        const sessionBoundsValid = datesValid ?
          validateSessionDateBounds({
            eventStartsAt,
            eventEndsAt,
            sessionForm: document.getElementById('sessions-form'),
            onSessionsSection: () => displayActiveSection('sessions'),
          }) :
          true;

        if (
          !isValid ||
          !datesValid ||
          !cfsValid ||
          !onlineValid ||
          !sessionsOnlineValid ||
          !sessionBoundsValid
        ) {
          // Prevent form submission
          e.preventDefault();
          e.stopImmediatePropagation();
          return false;
        }
      }
    });

    // Convert datetime-local values to proper ISO format for PostgreSQL
    addEventButton.addEventListener('htmx:configRequest', (e) => {
      if (e.detail.elt.id === 'add-event-button') {
        const isValid = validateEventForms();
        if (!isValid) {
          e.preventDefault();
          e.stopPropagation();
          return;
        }
        Object.keys(e.detail.parameters).forEach((key) => {
          const isEventDate = key.match(/^(starts_at|ends_at|cfs_starts_at|cfs_ends_at)$/);
          const isSessionDate = key.match(/^sessions\[\d+\]\[(starts_at|ends_at)\]$/);
          if (isEventDate || isSessionDate) {
            if (e.detail.parameters[key]) {
              e.detail.parameters[key] = convertDateTimeLocalToISO(e.detail.parameters[key]);
            }
          }
        });
      }
    });

    addEventButton.addEventListener('htmx:afterRequest', (e) => {
      if (e.detail.elt.id === 'add-event-button') {
        const xhr = e.detail?.xhr;
        handleHtmxResponse({
          xhr,
          successMessage: 'You have successfully created the event.',
          errorMessage: 'Something went wrong creating the event. Please try again later.',
        });
      }
    });
  }
</script>
{# End Events form -#}
