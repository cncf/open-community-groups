{% import "common.html" as common -%}
{% import "dashboard/dashboard_macros.html" as macros -%}

{# Events form -#}
<div class="space-y-12">
  <div class="space-y-3 w-full">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <label for="copy-event-selector" class="form-label m-0">Copy from existing event (optional)</label>
      <div data-copy-indicator
           id="copy-event-feedback"
           class="hidden items-center gap-2 text-sm text-primary-600"
           aria-live="polite">
        <svg-spinner size="size-4" label="Copying event">
        </svg-spinner>
        <span>Copying event...</span>
      </div>
    </div>
    <event-selector button-id="copy-event-selector" group-id="{{ group_id }}" mode="copy"></event-selector>
    <p class="form-legend mt-2">
      Start and end dates, as well as session times, are left blank so you can set the
      new schedule. When copying from events imported from the previous community platform,
      some fields like event's hosts and speakers won't be copied. Note that this only
      applies to events that have not been created from Open Community Groups.
    </p>
  </div>

  <div class="flex flex-col xl:flex-row xl:justify-between xl:space-x-10">
    <ul class="flex flex-wrap space-x-2 -mb-px text-sm font-medium text-center border-b border-stone-900/10 w-full xl:w-auto">
      <li>
        <button type="button"
                data-section="details"
                data-active="true"
                class="lg:w-36 xl:w-40 cursor-pointer inline-flex items-center justify-center p-4 pt-0 border-b-2 border-transparent rounded-t-lg hover:text-stone-600 hover:border-stone-300 active data-[active=true]:text-primary-500 data-[active=true]:border-primary-500 group text-nowrap">
          <div class="svg-icon size-3 me-2 icon-event bg-stone-400 group-hover:bg-stone-500 group-[.active]:bg-primary-500 shrink-0">
          </div>
          Details
        </button>
      </li>
      <li>
        <button type="button"
                data-section="date-venue"
                data-active="false"
                class="lg:w-36 xl:w-40 cursor-pointer inline-flex items-center justify-center p-4 pt-0 border-b-2 border-transparent rounded-t-lg hover:text-stone-600 hover:border-stone-300 data-[active=true]:text-primary-500 data-[active=true]:border-primary-500 group text-nowrap">
          <div class="svg-icon size-3 me-2 icon-calendar bg-stone-400 group-hover:bg-stone-500 group-[.active]:bg-primary-500 shrink-0">
          </div>
          Date & Venue
        </button>
      </li>
      <li>
        <button type="button"
                data-section="sessions"
                data-active="false"
                class="lg:w-36 xl:w-40 cursor-pointer inline-flex items-center justify-center p-4 pt-0 border-b-2 border-transparent rounded-t-lg hover:text-stone-600 hover:border-stone-300 data-[active=true]:text-primary-500 data-[active=true]:border-primary-500 group text-nowrap">
          <div class="svg-icon size-3 me-2 icon-presentation bg-stone-400 group-hover:bg-stone-500 group-[.active]:bg-primary-500 shrink-0">
          </div>
          Sessions
        </button>
      </li>
      <li>
        <button type="button"
                data-section="hosts-sponsors"
                data-active="false"
                class="lg:w-36 xl:w-40 cursor-pointer inline-flex items-center justify-center p-4 pt-0 border-b-2 border-transparent rounded-t-lg hover:text-stone-600 hover:border-stone-300 data-[active=true]:text-primary-500 data-[active=true]:border-primary-500 group text-nowrap">
          <div class="svg-icon size-3 me-2 icon-user-plus bg-stone-400 group-hover:bg-stone-500 group-[.active]:bg-primary-500 shrink-0">
          </div>
          <span class="hidden lg:inline">People & Sponsors</span>
          <span class="lg:hidden">People</span>
        </button>
      </li>
    </ul>

    <div class="flex items-center justify-end space-x-5 mt-6 xl:-mt-2">
      {# Cancel button -#}
      <div>
        <button id="cancel-button"
                type="button"
                hx-get="/dashboard/group?tab=events"
                hx-target="body"
                hx-indicator="#dashboard-spinner"
                class="btn-primary-outline w-24">Cancel</button>
      </div>
      {# End cancel button -#}

      {# Save button -#}
      <div>
        <button id="add-event-button"
                type="button"
                class="btn-primary w-24 text-nowrap"
                hx-post="/dashboard/group/events/add"
                hx-ext="no-empty-vals"
                hx-include="#details-form, #date-venue-form, #sessions-form, #hosts-sponsors-form"
                hx-target="#dashboard-content"
                hx-indicator="#dashboard-spinner"
                hx-disabled-elt="#add-event-button, #cancel-button"
                hx-exclude="[name=toggle_registration_required]">Add</button>
      </div>
      {# End save button -#}
    </div>
  </div>

  <div>
    <div class="space-y-12">
      {# Event Details Tab -#}
      <div data-content="details">
        <form id="details-form">
          <div class="pb-12">
            <p class="mt-1 text-sm/6 text-stone-500">Please add as many details about this event as possible.</p>

            <div class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 md:grid-cols-6 max-w-5xl">
              {# Event name -#}
              <div class="col-span-full lg:col-span-3">
                <label for="name" class="form-label">
                  Name <span class="asterisk">*</span>
                </label>
                <div class="mt-2">
                  <input type="text"
                         name="name"
                         id="name"
                         maxlength="100"
                         class="input-primary"
                         autocomplete="off"
                         autocorrect="off"
                         autocapitalize="off"
                         spellcheck="false"
                         required>
                </div>
                <p class="form-legend">Display name of the event (e.g. Kubernetes Amsterdam Meetup).</p>
              </div>
              {# End Event name -#}

              <div class="col-span-3"></div>

              {# Event category -#}
              <div class="col-span-full lg:col-span-3">
                <label for="category_id" class="form-label">
                  Category <span class="asterisk">*</span>
                </label>
                <div class="mt-2 grid grid-cols-1">
                  <select id="category_id" name="category_id" class="select-primary" required>
                    <option value="">Select a category</option>
                    {% for category in categories %}
                      <option value="{{ category.event_category_id }}">{{ category.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <p class="form-legend">Type of event or meetup.</p>
              </div>
              {# End Event category -#}

              {# Event kind -#}
              <div class="col-span-full lg:col-span-3">
                <label for="kind_id" class="form-label">
                  Event Type <span class="asterisk">*</span>
                </label>
                <div class="mt-2 grid grid-cols-1">
                  <select id="kind_id" name="kind_id" class="select-primary" required>
                    <option value="">Select an event type</option>
                    {% for kind in event_kinds %}
                      <option value="{{ kind.event_kind_id }}">{{ kind.display_name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <p class="form-legend">Whether this is an in-person, virtual, or hybrid event.</p>
              </div>
              {# End Event kind -#}

              {# Logo URL -#}
              <div class="col-span-full lg:col-span-3">
                <image-field class="w-full block" label="Logo" name="logo_url" image-kind="avatar">
              </image-field>
            </div>
            {# End Logo URL -#}

            {# Banner URL -#}
            <div class="col-span-full">
              <image-field class="w-full block" label="Banner" name="banner_url" image-kind="banner">
            </image-field>
          </div>
          {# End Banner URL -#}

          {# Short Description -#}
          <div class="col-span-full">
            <label for="description_short" class="form-label">Short Description</label>
            <div class="mt-2">
              <textarea id="description_short"
                        name="description_short"
                        rows="2"
                        class="input-primary"
                        maxlength="200"></textarea>
            </div>
            <p class="form-legend">Brief description used in event listings and previews (max 200 characters).</p>
          </div>
          {# End Short Description -#}

          {# Event Description -#}
          <div class="col-span-full">
            <label for="description" class="form-label">
              Description <span class="asterisk">*</span>
            </label>
            <div class="mt-2">
              <markdown-editor id="description" name="description" required></markdown-editor>
            </div>
            <p class="form-legend">Full description of the event and its purpose.</p>
          </div>
          {# End Event Description -#}
        </div>
      </div>

      {# Additional Information section -#}
      <div class="border-t border-stone-900/10 pt-12">
        {% call macros::form_title(title = "Additional Information", description = "Optional event settings and external links.") -%}

        <div class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 md:grid-cols-6 max-w-5xl">
          {# Capacity -#}
          <div class="col-span-full lg:col-span-2">
            <label for="capacity" class="form-label">Capacity</label>
            <div class="mt-2">
              <input type="number"
                     name="capacity"
                     id="capacity"
                     min="1"
                     class="input-primary"
                     placeholder="100">
            </div>
            <p class="form-legend">Maximum number of attendees.</p>
          </div>
          {# End Capacity -#}

          <div class="col-span-4"></div>

          {# Registration required -#}
          <div class="col-span-full lg:col-span-3">
            <label class="inline-flex items-center cursor-pointer">
              <input id="toggle_registration_required"
                     name="toggle_registration_required"
                     value="required"
                     type="checkbox"
                     class="sr-only peer">
              <input type="hidden"
                     id="registration_required"
                     name="registration_required"
                     value="false">
              <div class="relative w-11 h-6 bg-stone-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-stone-300 after:border after:border-stone-200 after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-500">
              </div>
              <span class="ms-3 text-sm font-medium text-stone-900">Registration Required</span>
            </label>
            <p class="form-legend">Whether attendees must register in advance.</p>
          </div>
          {# End Registration required -#}

          <div class="col-span-3"></div>

          {# Meetup URL -#}
          <div class="col-span-full lg:col-span-3">
            <label for="meetup_url" class="form-label">Meetup.com URL</label>
            <div class="mt-2">
              <input type="url"
                     name="meetup_url"
                     id="meetup_url"
                     class="input-primary"
                     placeholder="https://meetup.com/group/events/123456">
            </div>
            <p class="form-legend">Link to the Meetup.com event page.</p>
          </div>
          {# End Meetup URL -#}

          <div class="col-span-3"></div>

          {# Photos -#}
          <div class="col-span-full">
            <gallery-field field-name="photos_urls" legend="Optional photos related to the event." max-images="0" label="Photos"></gallery-field>
          </div>
          {# End Photos -#}

          {# Tags -#}
          <div class="col-span-3">
            <label for="tags" class="form-label">Tags</label>
            <div class="mt-2">
              <multiple-inputs field-name="tags" input-type="text" label="Tag" legend="Optional tags to help categorize and find the event.">
              </multiple-inputs>
            </div>
          </div>
          {# End Tags -#}
        </div>
      </div>
      {# End additional information section -#}
    </form>
  </div>
  {# End Event Details Tab -#}

  {# Date & Venue Tab -#}
  <div data-content="date-venue" class="hidden">
    <form id="date-venue-form">
      <div class="space-y-12">
        {# Date and Time section -#}
        <div class="border-b border-stone-900/10 pb-12">
          <p class="mt-1 text-sm/6 text-stone-500">When will this event take place?</p>
          <div class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 md:grid-cols-6 max-w-5xl">
            {# Timezone -#}
            <div class="col-span-full lg:col-span-3">
              <label for="timezone" class="form-label">
                Timezone <span class="asterisk">*</span>
              </label>
              <div class="mt-2 grid grid-cols-1">
                <select id="timezone" name="timezone" class="select-primary" required>
                  <option value="">Select a timezone</option>
                  {% for timezone in timezones %}<option value="{{ timezone }}">{{ timezone }}</option>{% endfor %}
                </select>
              </div>
              <p class="form-legend">Timezone for event times (e.g. America/New_York, Europe/Amsterdam).</p>
            </div>
            {# End Timezone -#}

            <div class="col-span-4"></div>

            {# Start date/time -#}
            <div class="col-span-full lg:col-span-3">
              <label for="starts_at" class="form-label">Start Date & Time</label>
              <div class="mt-2">
                <input type="datetime-local"
                       name="starts_at"
                       id="starts_at"
                       class="input-primary">
              </div>
              <p class="form-legend">When the event starts.</p>
            </div>
            {# End Start date/time -#}

            {# End date/time -#}
            <div class="col-span-full lg:col-span-3">
              <label for="ends_at" class="form-label">End Date & Time</label>
              <div class="mt-2">
                <input type="datetime-local"
                       name="ends_at"
                       id="ends_at"
                       class="input-primary">
              </div>
              <p class="form-legend">When the event ends.</p>
            </div>
            {# End End date/time -#}
          </div>
        </div>
        {# End date and time section -#}

        {# Venue Information section -#}
        <div class="border-b border-stone-900/10 pb-12">
          {% call macros::form_title(title = "Venue Information", description = "Location details for in-person and hybrid events.") -%}

          <div class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 md:grid-cols-6 max-w-5xl">
            {# Venue name -#}
            <div class="col-span-full lg:col-span-3">
              <label for="venue_name" class="form-label">Venue Name</label>
              <div class="mt-2">
                <input type="text"
                       name="venue_name"
                       id="venue_name"
                       class="input-primary"
                       placeholder="Conference Center Amsterdam">
              </div>
              <p class="form-legend">Name of the venue where the event takes place.</p>
            </div>
            {# End Venue name -#}

            <div class="col-span-3"></div>

            {# Venue address -#}
            <div class="col-span-full lg:col-span-4">
              <label for="venue_address" class="form-label">Address</label>
              <div class="mt-2">
                <input type="text"
                       name="venue_address"
                       id="venue_address"
                       class="input-primary"
                       placeholder="123 Main Street">
              </div>
              <p class="form-legend">Street address of the venue.</p>
            </div>
            {# End Venue address -#}

            <div class="col-span-2"></div>

            {# Venue city -#}
            <div class="col-span-full lg:col-span-2">
              <label for="venue_city" class="form-label">City</label>
              <div class="mt-2">
                <input type="text"
                       name="venue_city"
                       id="venue_city"
                       class="input-primary"
                       placeholder="Amsterdam">
              </div>
              <p class="form-legend">City where the venue is located.</p>
            </div>
            {# End Venue city -#}

            {# Venue zip code -#}
            <div class="col-span-full lg:col-span-2">
              <label for="venue_zip_code" class="form-label">Zip Code</label>
              <div class="mt-2">
                <input type="text"
                       name="venue_zip_code"
                       id="venue_zip_code"
                       class="input-primary"
                       placeholder="1012 AB">
              </div>
              <p class="form-legend">Postal/zip code of the venue.</p>
            </div>
            {# End Venue zip code -#}

            <div class="col-span-2"></div>
          </div>
        </div>
        {# End venue information section -#}

        {# Online Event Details section -#}
        <div class="pb-12">
          {% call macros::form_title(title = "Online Event Details", description = "Meeting information for virtual and hybrid events.") -%}

          <div class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 md:grid-cols-6 max-w-5xl">
            {# Meeting URL -#}
            <div class="col-span-full lg:col-span-3">
              <label for="meeting_join_url" class="form-label">Meeting URL</label>
              <div class="mt-2">
                <input type="url"
                       name="meeting_join_url"
                       id="meeting_join_url"
                       class="input-primary"
                       placeholder="https://zoom.us/j/123456789">
              </div>
              <p class="form-legend">URL to join the meeting.</p>
            </div>
            {# End Meeting URL -#}

            {# Meeting recording URL -#}
            <div class="col-span-full lg:col-span-3">
              <label for="meeting_recording_url" class="form-label">Meeting recording URL</label>
              <div class="mt-2">
                <input type="url"
                       name="meeting_recording_url"
                       id="meeting_recording_url"
                       class="input-primary"
                       placeholder="https://youtube.com/watch?v=...">
              </div>
              <p class="form-legend">URL of the meeting recording (can be added after the event).</p>
            </div>
            {# End Meeting recording URL -#}
          </div>
        </div>
        {# End online event details section -#}
      </div>
    </form>
  </div>
  {# End Date & Venue Tab -#}

  {# Sessions Tab -#}
  <div data-content="sessions" class="hidden">
    <form id="sessions-form">
      <div class="pb-12">
        <div class="mt-10">
          <sessions-section session-kinds="{{ session_kinds|json }}"></sessions-section>
        </div>
      </div>
    </form>
  </div>
  {# End Sessions Tab -#}

  {# People & Sponsors Tab -#}
  <div data-content="hosts-sponsors" class="hidden">
    <form id="hosts-sponsors-form">
      <div class="space-y-12">
        {# Hosts Section -#}
        <div class="border-b border-stone-900/10 pb-12">
          <div class="text-xl lg:text-2xl font-medium text-stone-900">Event Hosts</div>
          <div class="mt-5">
            <user-search-selector field-name="hosts" dashboard-type="group" label="host" legend="Search for event organizers or hosts by their username"></user-search-selector>
          </div>
        </div>
        {# End Hosts Section -#}

        {# Event Speakers Section -#}
        <div class="border-b border-stone-900/10 pb-12">
          <div class="text-xl lg:text-2xl font-medium text-stone-900">Event Speakers</div>
          <div class="mt-5">
            <speakers-selector dashboard-type="group" field-name-prefix="speakers" show-add-button label="Speakers" help-text="Add speakers or presenters for this event."></speakers-selector>
          </div>
        </div>
        {# End Event Speakers Section -#}

        {# Sponsors Section -#}
        <div class="pb-12">
          <div class="text-xl lg:text-2xl font-medium text-stone-900">Event Sponsors</div>
          <div class="mt-5">
            <sponsors-section sponsors="{{ sponsors|json }}"></sponsors-section>
          </div>
        </div>
        {# End Sponsors Section -#}
      </div>
    </form>
  </div>
  {# End People & Sponsors Tab -#}

</div>
</div>
</div>

<script type="module">
  import {
    isSuccessfulXHRStatus,
    convertDateTimeLocalToISO
  } from '/static/js/common/common.js';
  import {
    showErrorAlert,
    showSuccessAlert
  } from '/static/js/common/alerts.js';
  import {
    generateSlug
  } from '/static/js/dashboard/common.js';
  import '/static/js/common/user-search-selector.js';
  import '/static/js/common/speakers-selector.js';

  const addEventButton = document.getElementById('add-event-button');
  const cancelButton = document.getElementById('cancel-button');
  const kindSelect = document.getElementById('kind_id');
  const venueSection = document.getElementById('venue-section');
  const onlineSection = document.getElementById('online-section');

  // Tab switching functionality
  function displayActiveSection(sectionName) {
    // Update tab buttons
    const tabButtons = document.querySelectorAll('[data-section]');
    tabButtons.forEach(btn => {
      if (btn.getAttribute('data-section') === sectionName) {
        btn.setAttribute('data-active', 'true');
        btn.classList.add('active');
      } else {
        btn.setAttribute('data-active', 'false');
        btn.classList.remove('active');
      }
    });

    // Update content sections
    const contentSections = document.querySelectorAll('[data-content]');
    contentSections.forEach(section => {
      if (section.getAttribute('data-content') === sectionName) {
        section.classList.remove('hidden');
      } else {
        section.classList.add('hidden');
      }
    });
  }

  // Validate multiple forms
  function validateEventForms() {
    const formSections = ['details', 'date-venue', 'sessions', 'hosts-sponsors'];

    for (const formName of formSections) {
      const formElement = document.getElementById(`${formName}-form`);

      if (formElement && !formElement.checkValidity()) {
        displayActiveSection(formName);
        formElement.reportValidity();
        return false;
      }
    }

    return true;
  }

  // Add event listeners to tab buttons
  const sectionsBtn = document.querySelectorAll('[data-section]');
  sectionsBtn.forEach((btn) => {
    btn.addEventListener('click', () => {
      const section = btn.getAttribute('data-section');
      displayActiveSection(section);
    });
  });

  // Handle registration required toggle
  const toggleRegistrationRequired = document.getElementById('toggle_registration_required');
  if (toggleRegistrationRequired) {
    toggleRegistrationRequired.addEventListener('change', () => {
      document.getElementById('registration_required').value = toggleRegistrationRequired.checked;
    });
  }

  if (cancelButton) {
    cancelButton.addEventListener('htmx:afterRequest', () => {
      history.pushState({}, "Events list", '/dashboard/group?tab=events');
    });
  }

  if (addEventButton) {
    // Validation before form submission
    addEventButton.addEventListener('htmx:beforeRequest', (e) => {
      if (e.detail.elt.id === 'add-event-button') {
        // Use multiple form validation
        const isValid = validateEventForms();

        if (!isValid) {
          // Prevent form submission
          e.preventDefault();
          return false;
        }
      }
    });

    // Generate slug and add to request parameters
    addEventButton.addEventListener('htmx:configRequest', (e) => {
      if (e.detail.elt.id === 'add-event-button') {
        const nameInput = document.getElementById('name');

        if (nameInput && nameInput.value.trim()) {
          const slug = generateSlug(nameInput.value);
          e.detail.parameters.slug = slug;
        }

        // Convert datetime-local values to proper ISO format for PostgreSQL
        Object.keys(e.detail.parameters).forEach(key => {
          if (key.match(/^(starts_at|ends_at)$/) || key.match(/^sessions\[\d+\]\[(starts_at|ends_at)\]$/)) {
            if (e.detail.parameters[key]) {
              e.detail.parameters[key] = convertDateTimeLocalToISO(e.detail.parameters[key]);
            }
          }
        });
      }
    });

    addEventButton.addEventListener('htmx:afterRequest', (e) => {
      if (e.detail.elt.id === 'add-event-button') {
        if (isSuccessfulXHRStatus(e.detail.xhr.status)) {
          showSuccessAlert('You have successfully created the event.');
        } else {
          showErrorAlert('Something went wrong creating the event, please try again later.');
        }
      }
    });
  }
</script>
{# End Events form -#}
