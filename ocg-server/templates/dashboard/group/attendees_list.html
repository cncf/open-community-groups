{% import "macros/ui.html" as ui -%}
{% import "macros/dashboard.html" as dashboard -%}
{% import "macros/pagination.html" as pagination -%}

<div class="flex flex-col lg:flex-row lg:items-center justify-between my-5">
  <div class="flex text-sm text-stone-600 mb-4 lg:mb-0">
    <div>Total attendees:</div>
    <div class="font-semibold ms-1 text-end">
      {% if total == 0 -%}
        -
      {% else %}
        {{ total }}
      {% endif -%}
    </div>
  </div>
  <div class="shrink-0 w-auto mb-1.5 flex gap-3 flex-row">
    <button id="open-event-qr-code-modal"
            type="button"
            class="btn-primary-outline w-full lg:w-auto"
            data-event-id="{{ event.event_id }}"
            data-event-name="{{ event.name }}"
            data-group-name="{{ event.group_name }}"
            data-event-slug="{{ event.slug }}"
            data-check-in-url="/{{ event.community_name }}/check-in/{{ event.event_id }}"
            data-qr-code-url="/dashboard/group/check-in/{{ event.event_id }}/qr-code"
            {% if let Some(start_time) = &event.starts_at -%}
              data-event-start="{{ start_time.with_timezone(event.timezone).format("%b %e Â· %I:%M %p %Z") }}"
            {% endif -%}>Show QR Code</button>
    <button id="open-attendee-notification-modal"
            type="button"
            class="btn-primary-outline w-full lg:w-auto"
            {% if total == 0 -%}
              disabled title="No attendees to send emails to."
            {% endif -%}
            data-event-id="{{ event.event_id }}">Send email</button>
  </div>
</div>

{# Attendees table -#}
<div class="relative overflow-visible pb-12">
  <table class="table-fixed w-full text-xs lg:text-sm text-left rtl:text-right text-stone-500"
         role="table"
         aria-label="Attendees list">
    <thead class="text-xs text-stone-700 uppercase bg-stone-100 border-b border-stone-200"
           role="rowgroup">
      <tr>
        <th scope="col" class="px-3 xl:px-5 py-3">Attendee</th>
        <th scope="col" class="px-3 xl:px-5 py-3">Position</th>
        <th scope="col" class="hidden xl:table-cell px-3 xl:px-5 py-3 w-40">RSVP Date</th>
        <th scope="col" class="px-3 xl:px-5 py-3 w-30">Checked In</th>
      </tr>
    </thead>
    <tbody id="attendees-list" role="rowgroup">
      {% if attendees.is_empty() -%}
        <tr class="bg-white border-b border-stone-200">
          {# Mobile: 3 columns (Attendee, Position, Checked In) -#}
          <td class="xl:hidden px-8 py-12 text-center" colspan="3">
            {% include "dashboard/placeholders/group_attendees_empty.html" -%}
          </td>
          {# xl: 4 columns (adds RSVP Date) -#}
          <td class="hidden xl:table-cell px-8 py-12 text-center" colspan="4">
            {% include "dashboard/placeholders/group_attendees_empty.html" -%}
          </td>
        </tr>
      {% else -%}
        {% for attendee in attendees -%}
          <tr class="odd:bg-white even:bg-stone-50/50 border-b border-stone-200 last:border-b-0">
            {# Attendee -#}
            <td class="px-3 xl:px-5 py-4">
              <div class="flex items-center space-x-5">
                <avatar-image
                {% if let Some(photo_url) = &attendee.photo_url -%}
                  image-url="{{ photo_url }}"
                {% endif -%}
                size="size-10" placeholder="{{ self::user_initials(attendee.name.as_deref() , attendee.username.as_str()) }}">
                </avatar-image>
                <div class="min-w-0">
                  <div class="font-medium text-stone-900 truncate mb-1">
                    {{ attendee.name|assigned_or(attendee.username) }}
                  </div>
                  {% if attendee.name.is_some() -%}
                    <div class="text-xs text-stone-600 truncate">{{ attendee.username }}</div>
                  {% endif -%}
                </div>
              </div>
            </td>
            {# End attendee -#}

            {# Position -#}
            <td class="px-3 xl:px-5 py-4">
              <div class="flex flex-col space-y-1">
                <div class="font-medium text-stone-900 truncate">{{ attendee.company|assigned_or("-") }}</div>
                {% if let Some(title) = &attendee.title -%}
                  <div class="text-xs text-stone-600 truncate">{{ title }}</div>
                {% endif -%}
              </div>
            </td>
            {# End Position -#}

            {# RSVP Date -#}
            <td class="hidden xl:table-cell px-3 xl:px-5 py-4 whitespace-nowrap w-40">
              {{ attendee.created_at.format("%b %d, %Y") }}
            </td>
            {# End RSVP date -#}

            {# Checked In Toggle -#}
            <td class="px-3 xl:px-5 py-4 w-30">
              <label class="inline-flex items-center
                            {% if attendee.checked_in %}
                              cursor-not-allowed
                            {% else %}
                              cursor-pointer
                            {% endif %}">
                <input type="checkbox"
                       class="sr-only peer check-in-toggle"
                       aria-label="{% if attendee.checked_in %}
                                     Checked in
                                   {% else %}
                                     Check in attendee
                                   {% endif %}"
                       data-url="/dashboard/group/events/{{ event.event_id }}/attendees/{{ attendee.user_id }}/check-in"
                       {% if attendee.checked_in %}checked disabled{% endif %}>
                <div class="relative w-11 h-6 bg-stone-200 rounded-full peer peer-checked:bg-primary-500 peer-disabled:opacity-70 after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-stone-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white">
                </div>
              </label>
            </td>
            {# End checked in toggle -#}
          </tr>
        {% endfor -%}
      {% endif -%}
    </tbody>
  </table>
</div>
{# End attendees table -#}

{# Pagination -#}
{% if total > attendees.len() -%}
  {{ pagination::navigation_links(links = navigation_links, hx_target = "#attendees-content", hx_swap = "innerHTML") }}
{% endif -%}
{# End pagination -#}

{# Notification modal -#}
<div id="attendee-notification-modal"
     role="dialog"
     aria-modal="true"
     aria-labelledby="attendee-notification-modal-title"
     class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 max-h-full flex z-[1000]">
  <div id="overlay-attendee-notification-modal"
       class="modal-overlay absolute w-full h-full bg-stone-950 opacity-[0.35]"></div>
  <div class="relative p-4 w-full max-w-2xl max-h-full">
    <div class="relative bg-white rounded-lg shadow">
      {# Modal header -#}
      <div class="flex items-center justify-between p-4 md:p-5 border-b border-stone-200 rounded-t">
        <h3 id="attendee-notification-modal-title"
            class="text-xl font-semibold text-stone-900">Send email</h3>
        <button id="close-attendee-notification-modal"
                type="button"
                class="group text-stone-400 bg-transparent hover:bg-stone-200 hover:text-stone-900 transition-colors rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center">
          <div class="svg-icon w-5 h-5 bg-stone-500 group-hover:bg-stone-900 transition-colors icon-close"></div>
          <span class="sr-only">Close modal</span>
        </button>
      </div>
      {# Modal body -#}
      <div class="p-4 md:p-8">
        <div class="bg-stone-50 border border-stone-200 text-stone-800 rounded-lg p-4 mb-5 text-sm">
          <p class="font-medium">
            This email will be sent to <span class="font-semibold">all event attendees</span>.
          </p>
        </div>
        <form id="attendee-notification-form"
              hx-indicator="#attendee-notification-spinner"
              hx-disabled-elt="#submit-attendee-notification">
          <div class="mb-4">
            <label for="attendee-title" class="form-label">
              Title <span class="asterisk">*</span>
            </label>
            <div class="mt-2">
              <input type="text"
                     id="attendee-title"
                     name="title"
                     required
                     maxlength="{{ crate::validation::MAX_LEN_M }}"
                     class="input-primary"
                     placeholder="Enter notification title">
            </div>
          </div>
          <div class="mb-6">
            <label for="attendee-body" class="form-label">
              Body <span class="asterisk">*</span>
            </label>
            <div class="mt-2">
              <textarea id="attendee-body"
                        name="body"
                        required
                        rows="6"
                        maxlength="{{ crate::validation::MAX_LEN_XL }}"
                        class="input-primary"
                        placeholder="Enter notification body (plain text only)"></textarea>
              <p class="mt-1 text-xs text-stone-500">Plain text only. No HTML formatting.</p>
            </div>
          </div>
          <div class="flex justify-end gap-3 pt-6 border-t border-stone-200">
            <button id="cancel-attendee-notification"
                    type="button"
                    class="btn-primary-outline">Cancel</button>
            <button id="submit-attendee-notification"
                    type="submit"
                    class="btn-primary relative">
              {{ ui::btn_spinner(id = "attendee-notification-spinner", spinner_type = "2") -}}
              Send email
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{# QR code modal -#}
<div id="event-qr-code-modal"
     role="dialog"
     aria-modal="true"
     aria-labelledby="event-qr-code-modal-title"
     class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 max-h-full flex z-[1000]">
  <div id="overlay-event-qr-code-modal"
       class="modal-overlay absolute w-full h-full bg-stone-950 opacity-[0.35]"></div>
  <div class="relative p-4 w-full max-w-4xl max-h-full">
    <div class="relative bg-white rounded-lg shadow" data-qr-print-root="true">
      <div class="flex items-center justify-between p-4 md:p-5 border-b border-stone-200 rounded-t">
        <h3 id="event-qr-code-modal-title"
            class="text-xl font-semibold text-stone-900">Event check-in QR code</h3>
        <button id="close-event-qr-code-modal"
                type="button"
                class="group text-stone-400 bg-transparent hover:bg-stone-200 hover:text-stone-900 transition-colors rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center">
          <div class="svg-icon w-5 h-5 bg-stone-500 group-hover:bg-stone-900 transition-colors icon-close"></div>
          <span class="sr-only">Close modal</span>
        </button>
      </div>
      <div class="px-4 py-6 md:px-8 md:py-10">
        <div id="event-qr-code-print-area"
             class="flex flex-col lg:flex-row gap-6 bg-white border border-stone-200 rounded-lg p-4 md:p-6">
          <div class="flex-1 flex flex-col items-center text-center">
            <div id="event-qr-code-container"
                 class="relative w-full flex items-center justify-center">
              <img id="event-qr-code-image"
                   src=""
                   height="auto"
                   width="auto"
                   alt="Event check-in QR code"
                   class="max-w-[320px] w-full h-auto" />
            </div>
            <p class="text-xs text-stone-500">Scan to open the attendee check-in page.</p>
          </div>
          <div class="flex-1 space-y-4">
            <div class="mt-7">
              <p class="text-xs text-stone-500 uppercase tracking-wide mb-1">Group</p>
              <p id="event-qr-code-group-name"
                 class="text-base font-semibold text-stone-900 wrap-break-word line-clamp-2"></p>
            </div>
            <div>
              <p class="text-xs text-stone-500 uppercase tracking-wide mb-1">Event</p>
              <p id="event-qr-code-name"
                 class="text-base font-semibold text-stone-900 wrap-break-word line-clamp-3"></p>
            </div>
            <div>
              <p class="text-xs text-stone-500 uppercase tracking-wide mb-1">Date</p>
              <p id="event-qr-code-start"
                 class="text-base font-medium text-stone-700 wrap-break-word"></p>
            </div>
            <div>
              <p class="text-xs text-stone-500 uppercase tracking-wide mb-1">Check-in link</p>
              <a id="event-qr-code-link"
                 href="#"
                 class="text-sm font-medium text-primary-600 hover:underline break-all"
                 hx-boost="true"
                 target="_blank"
                 rel="noopener">/check-in/</a>
            </div>
          </div>
        </div>
        <div class="mt-8 md:mt-10 pt-6 md:pt-10 border-t border-stone-200"
             data-qr-print-actions="true">
          <button id="print-event-qr-code" type="button" class="btn-primary w-full">Print QR Code</button>
        </div>
      </div>
    </div>
  </div>
</div>
