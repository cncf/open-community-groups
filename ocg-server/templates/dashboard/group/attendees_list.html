{% import "common.html" as common -%}
{% import "dashboard/dashboard_macros.html" as macros -%}

{# Attendees header -#}
{% call macros::form_title(title = "Attendees") -%}

{# Filters: Event selector -#}
<div class="flex flex-col my-10">
  <label for="event-btn" class="form-label mb-2">Event</label>
  <div class="relative w-full">
    {% if filters_options.events.is_empty() -%}
      <button id="event-btn"
              class="select select-primary w-3/4 max-w-[90vw] opacity-50 cursor-not-allowed text-left"
              aria-label="No events"
              disabled>
        <div class="flex items-center relative">
          <div class="min-w-0">
            <div class="max-w-full truncate text-stone-500">No events</div>
            <div class="text-xs text-stone-500 truncate">Create an event to view attendees</div>
          </div>
        </div>
      </button>
    {% else -%}
      {# Event selector button -#}
      <button id="event-btn"
              class="cursor-pointer select select-primary w-3/4 max-w-[90vw] text-left"
              aria-label="Select event">
        <div class="flex items-center relative">
          {% if let Some(selected_id) = filters.event_id -%}
            {% for event in filters_options.events -%}
              {% if selected_id == &event.event_id -%}
                {% call event_content_list(event) -%}
              {% endif -%}
            {% endfor -%}
          {% else -%}
            <div class="min-w-0">
              <div class="max-w-full truncate">Select event</div>
              <div class="text-xs text-stone-500 truncate">Choose an event to view attendees</div>
            </div>
          {% endif -%}
        </div>
        <div class="absolute inset-y-0 end-0 flex items-center pe-3 pointer-events-none">
          <div class="svg-icon size-3 icon-caret-down bg-stone-600"></div>
        </div>
      </button>

      {# Dropdown events -#}
      <div id="dropdown-events"
           class="hidden absolute top-10 start-0 w-[520px] max-w-[90vw] z-10 bg-white rounded-lg shadow-sm border border-stone-200">
        <ul class="max-h-64 overflow-y-auto text-stone-700">
          {% for event in filters_options.events -%}
            {% let is_selected = filters.event_id.is_some() && filters.event_id.as_ref().unwrap() == &event.event_id -%}
            <li>
              <button id="select-event-{{ event.event_id }}"
                      hx-get="/dashboard/group/attendees?event_id={{ event.event_id }}"
                      hx-target="#dashboard-content"
                      hx-indicator="#dashboard-spinner"
                      hx-swap="innerHTML show:body:top"
                      hx-disabled-elt=".event-button"
                      class="event-button cursor-pointer w-full flex items-center justify-between px-4 py-2 text-sm/6 hover:bg-stone-100
                             {% if is_selected -%}bg-stone-100{%- endif %}"
                      {% if is_selected %}disabled{% endif %}>
                <div class="flex items-center min-w-0">{% call event_content_list(event) -%}</div>
              </button>
            </li>
          {% endfor -%}
        </ul>
      </div>
      {# End dropdown events -#}
    {% endif -%}
  </div>
</div>
{# End filters -#}

{# Attendees table -#}
<div class="relative overflow-visible">
  <table class="table-fixed w-full text-xs lg:text-sm text-left rtl:text-right text-stone-500"
         role="table"
         aria-label="Attendees list">
    <thead class="text-xs text-stone-700 uppercase bg-stone-100 border-b border-stone-200"
           role="rowgroup">
      <tr>
        <th scope="col" class="px-3 xl:px-5 py-3">Attendee</th>
        <th scope="col" class="hidden xl:table-cell px-3 xl:px-5 py-3">RSVP Date</th>
        <th scope="col" class="px-3 xl:px-5 py-3">Checked In</th>
      </tr>
    </thead>
    <tbody id="attendees-list" role="rowgroup">
      {% if filters.event_id.is_none() -%}
        <tr class="bg-white border-b border-stone-200">
          <td class="px-8 py-12 text-center" colspan="3">
            {% if filters_options.events.is_empty() -%}
              <div class="text-xl lg:text-2xl mb-6">It looks like you haven't created any events yet.</div>
              <p class="text-sm lg:text-md text-stone-700 mb-8">
                Create your first event to start tracking attendees for this group.
              </p>
              <button id="add-event-button"
                      hx-get="/dashboard/group/events/add"
                      hx-target="#dashboard-content"
                      hx-indicator="#dashboard-spinner"
                      class="btn-primary">Add Event</button>
            {% else -%}
              <div class="text-xl lg:text-2xl mb-6">Select an event to view attendees.</div>
              <p class="text-sm lg:text-md text-stone-700">
                Use the <span class="italic">Event</span> dropdown above to pick an event
                and load its attendees.
              </p>
            {% endif -%}
          </td>
        </tr>
      {% else -%}
        {% if attendees.is_empty() -%}
          <tr class="bg-white border-b border-stone-200">
            <td class="px-8 py-12 text-center" colspan="3">
              <div class="text-xl lg:text-2xl mb-6">No attendees found for this event.</div>
              <p class="text-sm lg:text-md text-stone-700">Try a different event.</p>
            </td>
          </tr>
        {% else -%}
          {% for attendee in attendees -%}
            <tr class="odd:bg-white even:bg-stone-50/50 border-b border-stone-200">
              {# Attendee -#}
              <td class="px-3 xl:px-5 py-4">
                <div class="flex items-center space-x-5">
                  <avatar-image
                  {% if let Some(photo_url) = attendee.photo_url -%}
                    image-url="{{ photo_url }}"
                  {% endif -%}
                  size="size-10" placeholder="{{ self::user_initials(attendee.name.as_deref() , attendee.username.as_str()) }}">
                  </avatar-image>
                  <div class="min-w-0">
                    <div class="font-medium text-stone-900 truncate">{{ attendee.name|display_some_or(attendee.username) }}</div>
                    {% if attendee.name.is_some() -%}
                      <div class="text-xs text-stone-600 truncate">{{ attendee.username }}</div>
                    {% endif -%}
                  </div>
                </div>
              </td>
              {# End attendee -#}

              {# RSVP Date -#}
              <td class="hidden xl:table-cell px-3 xl:px-5 py-4 whitespace-nowrap min-w-[150px] max-w-[200px]">
                {{ attendee.created_at.format("%b %d, %Y") }}
              </td>
              {# End RSVP date -#}

              {# Checked In -#}
              <td class="px-3 xl:px-5 py-4 w-24">
                {% if attendee.checked_in -%}
                  <div class="svg-icon size-4 icon-check bg-primary-500"
                       aria-label="Checked in"></div>
                {% else -%}
                  <span class="text-stone-400">-</span>
                {% endif -%}
              </td>
              {# End checked in -#}
            </tr>
          {% endfor -%}
        {% endif -%}
      {% endif -%}
    </tbody>
  </table>
</div>
{# End attendees table -#}

{% macro event_content_list(event) -%}
  <div class="mr-3">
    {% call common::logo(logo_url = event.logo_url, classes = "size-8", size = 40, color = event.group_color, border = false) -%}
  </div>
  <div class="flex flex-col min-w-0 items-start">
    <div class="max-w-full truncate">{{ event.name }}</div>
    <div class="flex items-center gap-x-2 text-xs text-stone-500">
      {% if let Some(start_time) = event.starts_at -%}
        <span class="me-3">{{ start_time.with_timezone(event.timezone).format("%B %e Â· %l:%M %p %Z") }}</span>
      {% endif -%}
      {% call common::event_badge(kind = event.kind, canceled = event.canceled) -%}
    </div>
  </div>
{% endmacro event_content_list -%}

<script type="module">
  const eventBtn = document.getElementById('event-btn');
  const dropdownEvents = document.getElementById('dropdown-events');
  if (eventBtn && dropdownEvents) {
    eventBtn.addEventListener('click', () => {
      const isOpen = dropdownEvents.classList.contains('hidden');
      dropdownEvents.classList.toggle('hidden');

      if (isOpen) {
        document.addEventListener('click', (event) => {
          if (!dropdownEvents.contains(event.target) && !eventBtn.contains(event.target)) {
            dropdownEvents.classList.add('hidden');
          }
        });
      } else {
        document.removeEventListener('click', () => {});
      }
    });
  }

  const dropdownEventBtns = document.querySelectorAll('button.event-button');
  dropdownEventBtns.forEach((btn) => {
    btn.addEventListener('htmx:beforeRequest', () => {
      if (dropdownEvents) dropdownEvents.classList.add('hidden');
    });
  });
</script>
