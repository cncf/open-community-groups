{% import "common.html" as common -%}
{% import "dashboard/dashboard_macros.html" as macros -%}

<div class="flex justify-between items-center mb-5">
  <div>
    {# Members header -#}
    {% call macros::form_title(title = "Members") -%}

    <div class="flex text-sm text-stone-600">
      <div>Total members:</div>
      <div class="font-semibold ms-1 text-end">
        {% if members.is_empty() -%}
          -
        {% else %}
          {{ members.len() }}
        {% endif -%}
      </div>
    </div>
  </div>
  <div>
    <button id="open-notification-modal"
            type="button"
            class="btn-secondary"
            {% if members.is_empty() -%}
              disabled title="Add members to enable sending notifications."
            {% endif -%}>Send Notification</button>
  </div>
</div>

{# Members table -#}
<div class="relative overflow-visible">
  <table class="table-fixed w-full text-xs lg:text-sm text-left rtl:text-right text-stone-500"
         role="table"
         aria-label="Members list">
    <thead class="text-xs text-stone-700 uppercase bg-stone-100 border-b border-stone-200"
           role="rowgroup">
      <tr>
        <th scope="col" class="px-3 xl:px-5 py-3">Member</th>
        <th scope="col" class="px-3 xl:px-5 py-3">Position</th>
        <th scope="col" class="hidden xl:table-cell px-3 xl:px-5 py-3 w-40">Joined</th>
      </tr>
    </thead>
    <tbody id="members-list" role="rowgroup">
      {% if members.is_empty() -%}
        <tr class="bg-white border-b border-stone-200">
          {# Mobile: 2 columns (Member, Position) -#}
          <td class="xl:hidden px-8 py-12 text-center" colspan="2">
            {% include "dashboard/placeholders/group_members_table.html" -%}
          </td>
          {# xl: 3 columns (adds Joined) -#}
          <td class="hidden xl:table-cell px-8 py-12 text-center" colspan="3">
            {% include "dashboard/placeholders/group_members_table.html" -%}
          </td>
        </tr>
      {% else -%}
        {% for member in members -%}
          <tr class="odd:bg-white even:bg-stone-50/50 border-b border-stone-200">
            {# Member -#}
            <td class="px-3 xl:px-5 py-4">
              <div class="flex items-center space-x-5">
                <avatar-image
                {% if let Some(photo_url) = member.photo_url -%}
                  image-url="{{ photo_url }}"
                {% endif -%}
                size="size-10" placeholder="{{ self::user_initials(member.name.as_deref() , member.username.as_str()) }}">
                </avatar-image>
                <div class="min-w-0">
                  <div class="font-medium text-stone-900 truncate mb-1">
                    {{ member.name|display_some_or(member.username) }}
                  </div>
                  {% if member.name.is_some() -%}
                    <div class="text-xs text-stone-600 truncate">{{ member.username }}</div>
                  {% endif -%}
                </div>
              </div>
            </td>
            {# End member -#}

            {# Position -#}
            <td class="px-3 xl:px-5 py-4">
              <div class="flex flex-col space-y-1">
                <div class="font-medium text-stone-900 truncate">{{ member.company|display_some_or("-") }}</div>
                {% if let Some(title) = member.title -%}
                  <div class="text-xs text-stone-600 truncate">{{ title }}</div>
                {% endif -%}
              </div>
            </td>
            {# End Position -#}

            {# Joined -#}
            <td class="hidden xl:table-cell px-3 xl:px-5 py-4 whitespace-nowrap w-40">
              {{ member.created_at.format("%b %d, %Y") }}
            </td>
            {# End joined -#}
          </tr>
        {% endfor -%}
      {% endif -%}
    </tbody>
  </table>
  {# End table -#}
</div>

{# Notification modal -#}
<div id="notification-modal"
     role="dialog"
     aria-modal="true"
     aria-labelledby="notification-modal-title"
     class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 max-h-full flex z-1000">
  <div id="overlay-notification-modal"
       class="modal-overlay absolute w-full h-full bg-stone-950 opacity-[0.35]"></div>
  <div class="relative p-4 w-full max-w-2xl max-h-full">
    <div class="relative bg-white rounded-lg shadow">
      {# Modal header -#}
      <div class="flex items-center justify-between p-4 md:p-5 border-b border-stone-200 rounded-t">
        <h3 id="notification-modal-title"
            class="text-xl font-semibold text-stone-900">Send Notification</h3>
        <button id="close-notification-modal"
                type="button"
                class="group text-stone-400 bg-transparent hover:bg-stone-200 hover:text-stone-900 transition-colors rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center">
          <div class="svg-icon w-5 h-5 bg-stone-500 group-hover:bg-stone-900 transition-colors icon-close"></div>
          <span class="sr-only">Close modal</span>
        </button>
      </div>
      {# Modal body -#}
      <div class="p-4 md:p-5">
        <div class="bg-blue-50 border border-blue-200 text-blue-800 rounded-lg p-4 mb-5 text-sm">
          <p class="font-medium">This notification will be sent to all group members.</p>
        </div>
        <form id="notification-form"
              hx-post="/dashboard/group/notifications"
              hx-indicator="#notification-spinner"
              hx-disabled-elt="#submit-notification">
          <div class="mb-4">
            <label for="subject" class="form-label">
              Subject <span class="asterisk">*</span>
            </label>
            <div class="mt-2">
              <input type="text"
                     id="subject"
                     name="subject"
                     required
                     maxlength="200"
                     class="input-primary"
                     placeholder="Enter notification subject">
            </div>
          </div>
          <div class="mb-4">
            <label for="body" class="form-label">
              Body <span class="asterisk">*</span>
            </label>
            <div class="mt-2">
              <textarea id="body"
                        name="body"
                        required
                        rows="6"
                        maxlength="5000"
                        class="input-primary"
                        placeholder="Enter notification body (plain text only)"></textarea>
              <p class="mt-1 text-xs text-stone-500">Plain text only. No HTML formatting.</p>
            </div>
          </div>
          <div class="flex justify-end gap-3 pt-4 border-t border-stone-200">
            <button id="cancel-notification" type="button" class="btn-primary-outline">Cancel</button>
            <button id="submit-notification" type="submit" class="btn-primary">Send Notification</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
