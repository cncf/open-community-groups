{% import "common.html" as common -%}
{% import "dashboard/dashboard_macros.html" as macros -%}

{# Events list header with title -#}
{% call macros::form_title(title = "Events") -%}

<div class="flex justify-between my-10">
  <div class="flex items-center gap-x-6">
    {# Search events input (display only) -#}
    <div class="relative">
      <div class="absolute inset-y-0 rtl:inset-r-0 start-0 flex items-center ps-3 pointer-events-none">
        <div class="svg-icon size-4 icon-search bg-stone-300"></div>
      </div>
      <input id="search_events"
             name="search_events"
             type="text"
             value=""
             class="input-primary peer ps-9 w-96"
             placeholder="Search events"
             autocomplete="off"
             autocorrect="off"
             autocapitalize="off"
             spellcheck="false"
             disabled>
      <div class="absolute end-1.5 top-1.5 peer-placeholder-shown:hidden">
        <button id="clean-search-events"
                type="button"
                class="cursor-pointer mt-[2px]"
                disabled>
          <div class="svg-icon size-5 bg-stone-400 hover:bg-stone-700 icon-close"></div>
        </button>
      </div>
    </div>
    {# End search events input -#}
  </div>

  {# Add event button -#}
  <div>
    <button id="add-event-button"
            hx-get="/dashboard/group/events/add"
            hx-target="#dashboard-content"
            hx-indicator="#dashboard-spinner"
            class="btn-primary">Add Event</button>
  </div>
  {# End add event button -#}

  <script type="module">
    const addEventButton = document.getElementById('add-event-button');
    if (addEventButton) {
      addEventButton.addEventListener('htmx:afterRequest', () => {
        try {
          history.pushState({}, "Events list", '/dashboard/group?tab=events');
        } catch (error) {
          console.warn('Failed to update browser history:', error);
        }
      });
    }
  </script>
</div>

{# Events Table -#}
<div class="relative overflow-visible">
  <table class="table-auto w-full text-xs lg:text-sm text-left rtl:text-right text-stone-500"
         role="table"
         aria-label="Events list">
    <thead class="text-xs text-stone-700 uppercase bg-stone-100 border-b border-stone-200"
           role="rowgroup">
      {# Header -#}
      <tr>
        <th scope="col" class="px-3 xl:px-5 py-3">Name</th>
        <th scope="col" class="hidden xl:table-cell px-3 xl:px-5 py-3">Type</th>
        <th scope="col" class="hidden xl:table-cell px-3 xl:px-5 py-3">Date & Time</th>
        <th scope="col" class="hidden 2xl:table-cell px-3 xl:px-5 py-3">Location</th>
        <th scope="col" class="px-3 xl:px-5 py-3 w-27"></th>
      </tr>
    </thead>
    <tbody id="events-list" role="rowgroup">
      {% if events.is_empty() -%}
        <tr class="bg-white border-b border-stone-200">
          <td class="px-8 py-20 text-center" colspan="5">
            <div class="text-xl lg:text-2xl mb-10">It looks like you haven't created any events yet.</div>

            <p class="text-sm lg:text-md text-stone-700">
              Events created for this group will be listed here. You can create a new event by clicking on the <span class="italic">Add Event</span> button in the top right corner.
            </p>
          </td>
        </tr>
      {% else -%}
        {% for event in events -%}
          <tr class="odd:bg-white even:bg-stone-50/50 border-b border-stone-200">
            <th scope="row"
                class="px-3 xl:px-5 py-4 font-medium text-stone-900 min-w-[100px] max-w-[200px] xl:max-w-auto">
              <div class="flex items-center">
                {# Event logo/icon -#}
                <div class="mr-3">
                  {% call common::logo(logo_url = event.logo_url, classes = "h-10 w-10 min-w-10", size = 40, color = event.group_color) -%}
                </div>
                {# End event logo/icon -#}

                <div class="min-w-0">
                  {# Event name -#}
                  <div class="max-w-full truncate">{{ event.name }}</div>
                  {# End event name -#}

                  {# Mobile type and date -#}
                  <div class="block xl:hidden text-xs text-stone-500">
                    <div class="max-w-full truncate">{{ event.kind }}</div>
                    {% if let Some(start_time) = event.starts_at -%}
                      <div class="max-w-full truncate">
                        {{ start_time.with_timezone(event.timezone).format("%b %d, %Y at %I:%M %p") }}
                      </div>
                    {% endif -%}
                  </div>
                  {# End mobile type and date -#}
                </div>
              </div>
            </th>

            {# Event Type -#}
            <td class="hidden xl:table-cell px-3 xl:px-5 py-4 whitespace-nowrap min-w-[100px] max-w-[150px]">
              {% call common::event_badge(kind = event.kind, canceled = event.canceled) -%}
            </td>
            {# End event type -#}

            {# Date & Time -#}
            <td class="hidden xl:table-cell px-3 xl:px-5 py-4 whitespace-nowrap min-w-[150px] max-w-[200px]">
              {% if let Some(start_time) = event.starts_at -%}
                <div class="max-w-full truncate">{{ start_time.with_timezone(event.timezone).format("%b %d, %Y") }}</div>
                <div class="max-w-full truncate text-xs text-stone-400">
                  {{ start_time.with_timezone(event.timezone).format("%I:%M %p") }}
                </div>
              {% else -%}
                <span class="text-stone-400">TBD</span>
              {% endif -%}
            </td>
            {# End date & time -#}

            {# Location -#}
            <td class="hidden 2xl:table-cell px-3 xl:px-5 py-4 whitespace-nowrap min-w-[100px] max-w-[200px]">
              {# TODO - fix comparison #}
              {% if event.kind.to_string() != "virtual" -%}
                {% if let Some(venue_city) = event.venue_city -%}
                  <div class="max-w-full truncate">{{ venue_city }}</div>
                {% else -%}
                  <span class="text-stone-400">-</span>
                {% endif -%}
              {% else -%}
                <span class="text-stone-500">Virtual</span>
              {% endif -%}
            </td>
            {# End location -#}

            {# Actions -#}
            <td class="px-3 xl:px-5 py-4 w-32 xl:w-40 w-27">
              <div class="flex items-center gap-x-1 xl:gap-x-3">
                {# Update event button -#}
                <div>
                  <button hx-get="/dashboard/group/events/{{ event.event_id }}/update"
                          hx-target="#dashboard-content"
                          hx-indicator="#dashboard-spinner"
                          hx-swap="innerHTML show:body:top"
                          hx-disabled-elt="this"
                          class="btn-tertiary p-2
                                 {% if event.canceled %}opacity-50 cursor-not-allowed{% endif %}"
                          {% if event.canceled %}disabled title="Event is canceled"{% endif %}
                          aria-label="Edit event: {{ event.name }}">
                    <div class="svg-icon size-4 icon-pencil"></div>
                  </button>
                </div>
                {# End update event button -#}

                <div class="group relative">
                  <button data-event-id="{{ event.event_id }}"
                          class="btn-actions btn-tertiary p-2 group-has-[.dropdown:not(.hidden)]:bg-stone-50">
                    <div class="svg-icon size-4 icon-vertical-dots"></div>
                  </button>

                  {# Dropdown actions -#}
                  <div id="dropdown-actions-{{ event.event_id }}"
                       class="dropdown absolute hidden z-10 end-0 top-8 w-[200px] bg-white divide-y divide-stone-100 rounded-lg shadow border border-stone-200">
                    <ul class="py-2 text-sm text-stone-700"
                        aria-labelledby="dropdownDefaultButton">
                      {# Cancel button -#}
                      {% if !event.canceled -%}
                        <li>
                          <button id="cancel-event-{{ event.event_id }}"
                                  hx-put="/dashboard/group/events/{{ event.event_id }}/cancel"
                                  hx-target="#dashboard-content"
                                  hx-indicator="#dashboard-spinner"
                                  hx-trigger="confirmed"
                                  class="cursor-pointer w-full text-start px-4 py-2 hover:bg-stone-100">
                            <div class="flex items-center">
                              <div class="svg-icon size-4 icon-cancel bg-stone-600"></div>
                              <div class="ms-2">Cancel</div>
                            </div>
                          </button>
                          <script type="module">
                            import {
                              showConfirmAlert,
                              showErrorAlert,
                              showSuccessAlert,
                            } from '/static/js/common/alerts.js';
                            import {
                              isSuccessfulXHRStatus
                            } from '/static/js/common/common.js';

                            const cancelEventButton = document.getElementById('cancel-event-{{ event.event_id }}');
                            if (cancelEventButton) {
                              cancelEventButton.addEventListener('click', (event) => {
                                showConfirmAlert("Are you sure you wish to cancel this event? This action is not reversible.", "cancel-event-{{ event.event_id }}", "Yes");
                              });

                              cancelEventButton.addEventListener("htmx:afterRequest", (e) => {
                                if (isSuccessfulXHRStatus(e.detail.xhr.status)) {
                                  showSuccessAlert("You have successfully canceled the event.");
                                } else {
                                  showErrorAlert("An error occurred canceling this event, please try again later.");
                                }
                              });
                            }
                          </script>
                        </li>
                      {% endif -%}
                      {# End cancel button -#}
                      {# Delete button -#}
                      <li>
                        <button id="delete-event-{{ event.event_id }}"
                                hx-delete="/dashboard/group/events/{{ event.event_id }}/delete"
                                hx-target="#dashboard-content"
                                hx-indicator="#dashboard-spinner"
                                hx-trigger="confirmed"
                                class="cursor-pointer w-full text-start px-4 py-2 hover:bg-stone-100">
                          <div class="flex items-center">
                            <div class="svg-icon size-4 icon-trash bg-stone-600"></div>
                            <div class="ms-2">Delete</div>
                          </div>
                        </button>
                        <script type="module">
                          import {
                            showConfirmAlert,
                            showErrorAlert,
                            showSuccessAlert,
                          } from '/static/js/common/alerts.js';
                          import {
                            isSuccessfulXHRStatus
                          } from '/static/js/common/common.js';

                          const deleteEventButton = document.getElementById('delete-event-{{ event.event_id }}');
                          if (deleteEventButton) {
                            deleteEventButton.addEventListener('click', (event) => {
                              showConfirmAlert("Are you sure you wish to delete this event?", "delete-event-{{ event.event_id }}", "Yes");
                            });

                            deleteEventButton.addEventListener("htmx:afterRequest", (e) => {
                              if (isSuccessfulXHRStatus(e.detail.xhr.status)) {
                                showSuccessAlert("You have successfully deleted the event.");
                              } else {
                                showErrorAlert("An error occurred deleting this event, please try again later.");
                              }
                            });
                          }
                        </script>
                      </li>
                      {# End delete button -#}
                    </ul>
                  </div>
                  {# End dropdown actions -#}
                </div>
              </div>
            </td>
            {# End actions -#}
          </tr>
        {% endfor -%}
      {% endif -%}
    </tbody>
  </table>

  <script type="module">
    const btnActions = document.querySelectorAll('.btn-actions');
    btnActions.forEach((btnAction) => {
      btnAction.addEventListener('click', () => {
        const eventId = btnAction.dataset.eventId;

        const dropdownActions = document.getElementById(`dropdown-actions-${eventId}`);
        if (dropdownActions) {
          const isOpen = dropdownActions.classList.contains('hidden');
          dropdownActions.classList.toggle('hidden');
          if (isOpen) {
            // Close dropdown actions when clicking outside
            document.addEventListener('click', (event) => {
              if (!dropdownActions.contains(event.target) && !btnAction.contains(event.target)) {
                dropdownActions.classList.add('hidden');
              }
            });
          } else {
            // Remove event listener when dropdown is closed
            document.removeEventListener('click', () => {});
          }
        }
      });
    });
  </script>
</div>
{# End Events Table -#}
