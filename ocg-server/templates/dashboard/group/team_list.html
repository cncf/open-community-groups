{% import "macros/badges.html" as badges -%}
{% import "macros/dashboard.html" as dashboard -%}
{% import "macros/pagination.html" as pagination -%}

{# Header -#}
{{ dashboard::form_title(title = "Group Team") -}}

<div class="flex justify-between items-end my-5">
  <div class="text-sm text-stone-600">
    {{ pagination::range_display(offset = offset.unwrap_or(0) , count = members.len(), total = total, label = "member") }}
  </div>
  <div>
    <team-add-member dashboard-type="group" selected-users='{{ members|json }}'></team-add-member>
  </div>
</div>

{# Team Table -#}
<div class="relative overflow-visible">
  <table class="table-auto w-full text-xs lg:text-sm text-left text-stone-500 mb-8">
    <thead class="text-xs text-stone-700 uppercase bg-stone-100 border-b border-stone-200">
      <tr>
        <th scope="col" class="px-3 xl:px-5 py-3">Member</th>
        <th scope="col" class="hidden xl:table-cell px-3 xl:px-5 py-3">Position</th>
        <th scope="col" class="px-3 xl:px-5 py-3 w-40">Role</th>
        <th scope="col" class="p-4 w-12"></th>
      </tr>
    </thead>
    <tbody id="team-list">
      {% if members.is_empty() -%}
        <tr class="bg-white border-b border-stone-200">
          {# Mobile: 3 columns (Member, Role, Actions) -#}
          <td class="xl:hidden px-8 py-12 text-center" colspan="3">
            {% include "dashboard/placeholders/group_team_table.html" -%}
          </td>
          {# xl: 4 columns (adds Position) -#}
          <td class="hidden xl:table-cell px-8 py-12 text-center" colspan="4">
            {% include "dashboard/placeholders/group_team_table.html" -%}
          </td>
        </tr>
      {% else -%}
        {% for member in members -%}
          <tr class="odd:bg-white even:bg-stone-50/50 border-b border-stone-200">
            {# Member -#}
            <td class="px-3 xl:px-5 py-4">
              <div class="flex items-center space-x-5">
                <avatar-image
                {% if let Some(photo_url) = &member.photo_url -%}
                  image-url="{{ photo_url }}"
                {% endif -%}
                size="size-10" placeholder="{{ self::user_initials(member.name.as_deref() , member.username.as_str()) }}">
                </avatar-image>
                <div class="min-w-0">
                  <div class="flex items-center space-x-3 mb-1">
                    <div class="font-medium text-stone-900 truncate">{{ member.name|assigned_or(member.username) }}</div>
                    {% if !member.accepted -%}
                      <div class="bg-yellow-100 text-yellow-800 text-xs px-2.5 py-0.5 rounded-full tracking-wide">
                        Invitation sent
                      </div>
                    {% endif -%}
                  </div>
                  {% if member.name.is_some() -%}
                    <div class="text-xs text-stone-600 truncate">{{ member.username }}</div>
                  {% endif -%}
                </div>
              </div>
            </td>
            {# End member -#}

            {# Position -#}
            <td class="hidden xl:table-cell px-3 xl:px-5 py-4">
              <div class="flex flex-col space-y-1">
                <div class="font-medium text-stone-900 truncate">{{ member.company|assigned_or("-") }}</div>
                {% if let Some(title) = &member.title -%}
                  <div class="text-xs text-stone-600 truncate">{{ title }}</div>
                {% endif -%}
              </div>
            </td>
            {# End Position -#}

            {# Role -#}
            <td class="px-3 xl:px-5 py-4 whitespace-nowrap">
              {% if let Some(role) = &member.role -%}
                {{ badges::common_badge(content = role, extra_styles = Some("px-2.5 py-0.5") ) -}}
              {% endif -%}
            </td>
            {# End role -#}

            {# Actions -#}
            <td class="w-12">
              <div>
                {% let disabledButton = approved_members_count == 1 && member.accepted -%}
                <button id="remove-member-{{ member.user_id }}"
                        hx-delete="/dashboard/group/team/{{ member.user_id }}/delete"
                        hx-target="#dashboard-content"
                        hx-indicator="#dashboard-spinner"
                        hx-trigger="confirmed"
                        class="btn-tertiary p-2
                               {% if disabledButton -%}
                                 disabled opacity-50
                               {% endif -%}"
                        {% if disabledButton -%}
                          title="When a team has only one member, it cannot be deleted." disabled
                        {% endif -%}>
                  <div class="svg-icon size-4 icon-trash"></div>
                </button>
                <script type="module">
                  import {
                    showConfirmAlert,
                    handleHtmxResponse,
                  } from '/static/js/common/alerts.js';
                  const removeMemberButton = document.getElementById('remove-member-{{ member.user_id }}');
                  if (removeMemberButton) {
                    removeMemberButton.addEventListener('click', () => {
                      showConfirmAlert(
                        "Are you sure you would like to delete this team member?",
                        "remove-member-{{ member.user_id }}",
                        "Yes",
                      );
                    });
                    removeMemberButton.addEventListener('htmx:afterRequest', (e) => {
                      const xhr = e.detail?.xhr;
                      handleHtmxResponse({
                        xhr,
                        successMessage: 'You have successfully deleted the team member.',
                        errorMessage: 'Something went wrong deleting this team member. Please try again later.'
                      });
                    });
                  }
                </script>
              </div>
            </td>
            {# End actions -#}
          </tr>
        {% endfor -%}
      {% endif -%}
    </tbody>
  </table>
</div>
{# End Team Table -#}

{# Pagination -#}
{% if total > members.len() -%}
  {{ pagination::navigation_links(links = navigation_links, hx_target = "#dashboard-content", hx_indicator = "#dashboard-spinner") }}
{% endif -%}
{# End pagination -#}
