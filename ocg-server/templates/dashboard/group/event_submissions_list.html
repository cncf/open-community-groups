{% import "macros/dashboard.html" as dashboard -%}
{% import "macros/badges.html" as badges -%}
{% import "macros/pagination.html" as pagination -%}

{{ dashboard::form_title(title = "Submissions",
description = "Review and manage call for speakers submissions.") -}}

<div id="submissions-refresh"
     hx-get="{{ refresh_url }}"
     hx-trigger="refresh-event-submissions from:body"
     hx-target="#submissions-content"
     hx-swap="innerHTML"></div>

<div class="mt-6">
  <form id="submissions-filters-form"
        class="w-full"
        hx-get="/dashboard/group/events/{{ event_id }}/submissions"
        hx-target="#submissions-content"
        hx-swap="innerHTML"
        hx-indicator="#dashboard-spinner">
    <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      {% if !event_cfs_labels.is_empty() -%}
        <div class="min-w-0 w-full md:w-1/2 md:pe-6">
          <label for="submissions-label-filter" class="sr-only">Filter by labels</label>
          <cfs-label-selector id="submissions-label-filter" name="label_ids" labels="{{ event_cfs_labels|json }}" selected="{{ selected_event_cfs_label_ids|json }}" placeholder="Search labels" compact selected-in-input></cfs-label-selector>
        </div>
      {% endif -%}
      <div class="flex items-center justify-end gap-2 whitespace-nowrap">
        <label for="submissions-sort"
               class="font-semibold text-[0.775rem] text-nowrap text-black leading-6">Sort by</label>
        <select id="submissions-sort"
                name="sort"
                class="block w-48 px-3 text-sm h-[42px] text-stone-900 bg-white border border-stone-200 rounded-full focus:outline-none focus:ring-0 focus:border-stone-200 hover:border-primary-500 focus:hover:border-primary-500 transition-colors">
          <option value="created-desc"
                  {% if sort == "created-desc" %}selected{% endif %}>Submitted (newest)</option>
          <option value="created-asc" {% if sort == "created-asc" %}selected{% endif %}>Submitted (oldest)</option>
          <option value="ratings-count-desc"
                  {% if sort == "ratings-count-desc" %}selected{% endif %}>Ratings count (high to low)</option>
          <option value="ratings-count-asc"
                  {% if sort == "ratings-count-asc" %}selected{% endif %}>Ratings count (low to high)</option>
          <option value="stars-desc" {% if sort == "stars-desc" %}selected{% endif %}>Stars (high to low)</option>
          <option value="stars-asc" {% if sort == "stars-asc" %}selected{% endif %}>Stars (low to high)</option>
        </select>
      </div>
    </div>
  </form>
</div>
<script type="module">
  const submissionsFiltersForm = document.getElementById("submissions-filters-form");
  const submissionsSort = document.getElementById("submissions-sort");
  const submissionsLabelFilter = document.getElementById("submissions-label-filter");
  const submitFilters = () => {
    if (!submissionsFiltersForm) {
      return;
    }
    window.requestAnimationFrame(() => submissionsFiltersForm.requestSubmit());
  };

  if (submissionsFiltersForm && submissionsSort) {
    submissionsSort.addEventListener("change", () => submitFilters());
  }

  if (submissionsFiltersForm && submissionsLabelFilter) {
    submissionsLabelFilter.addEventListener("change", () => submitFilters());
  }
</script>

<div class="mt-10">
  <div class="relative overflow-visible">
    <table class="table-fixed w-full text-xs lg:text-sm text-left text-stone-500">
      <colgroup>
        <col class="xl:w-[250px]" />
        <col />
        <col class="w-[190px]" />
        <col class="hidden xl:table-column w-[150px]" />
        <col class="hidden 2xl:table-column w-[110px]" />
        <col class="w-20" />
      </colgroup>
      <thead class="text-xs text-stone-700 uppercase bg-stone-100 border-b border-stone-200">
        <tr>
          <th scope="col" class="px-3 xl:px-5 py-3">Speaker</th>
          <th scope="col" class="px-3 xl:px-5 py-3">Proposal</th>
          <th scope="col" class="px-3 xl:px-5 py-3">Status</th>
          <th scope="col" class="hidden xl:table-cell px-3 xl:px-5 py-3">Ratings</th>
          <th scope="col" class="hidden 2xl:table-cell px-3 xl:px-5 py-3">Submitted</th>
          <th scope="col" class="px-3 xl:px-5 py-3"></th>
        </tr>
      </thead>
      <tbody>
        {% if submissions.is_empty() -%}
          <tr class="bg-white border-b border-stone-200">
            <td class="px-8 py-16 text-center" colspan="6">
              <div class="flex flex-col items-center justify-center min-h-[125px]">
                <div class="text-lg lg:text-xl">No submissions have been received yet.</div>
              </div>
            </td>
          </tr>
        {% else -%}
          {% for submission in submissions -%}
            <tr class="odd:bg-white even:bg-stone-50/50 border-b border-stone-200">
              <td class="px-3 xl:px-5 py-4">
                <div class="flex items-center space-x-3">
                  <logo-image
                  {% if let Some(photo_url) = &submission.speaker.photo_url -%}
                    image-url="{{ photo_url }}"
                  {% endif -%}
                  size="size-8" placeholder="{{ self::user_initials(submission.speaker.name.as_deref() , submission.speaker.username.as_str()) }}">
                  </logo-image>
                  <div class="font-medium text-stone-900 truncate">
                    {{ submission.speaker.name.as_deref().unwrap_or(&submission.speaker.username) }}
                  </div>
                </div>
              </td>
              <td class="px-3 xl:px-5 py-4">
                <div class="font-medium text-stone-900 line-clamp-2 xl:line-clamp-1">
                  {{ submission.session_proposal.title }}
                </div>
                {% if !submission.labels.is_empty() -%}
                  <div class="hidden mt-2 xl:flex flex-wrap gap-1.5 min-w-0">
                    {% for label in submission.labels -%}
                      {{ badges::cfs_label_chip(name = &label.name, color = &label.color) -}}
                    {% endfor -%}
                  </div>
                {% endif -%}
              </td>
              <td class="px-3 xl:px-5 py-4">
                {{ badges::submission_status_badge(status_id = submission.status_id, label = submission.status_name, extra_styles = Some("px-2.5 py-0.5 uppercase") ) -}}
              </td>
              <td class="hidden xl:table-cell px-3 xl:px-5 py-4 whitespace-nowrap">
                {% if let Some(average_rating) = submission.average_rating -%}
                  <div class="inline-flex items-center gap-2 text-stone-700">
                    <rating-stars average-rating="{{ average_rating }}" size="size-3"></rating-stars>
                    <span class="text-xs/3 font-semibold -mb-1">{{ average_rating }}</span>
                  </div>
                {% else -%}
                  <div class="inline-flex items-center gap-2 text-stone-500">
                    <rating-stars average-rating="0" size="size-3"></rating-stars>
                  </div>
                {% endif -%}
                <div class="mt-1 text-xs text-stone-500">
                  {{ submission.ratings_count }}
                  {% if submission.ratings_count == 1 -%}
                    rating
                  {% else -%}
                    ratings
                  {% endif -%}
                </div>
              </td>
              <td class="hidden 2xl:table-cell px-3 xl:px-5 py-4 whitespace-nowrap">
                {{ submission.created_at.format("%b %d, %Y") }}
              </td>
              <td class="px-3 xl:px-5 py-4">
                <button type="button"
                        class="btn-tertiary p-2"
                        data-action="open-cfs-submission-modal"
                        data-submission='{{ submission|json }}'
                        data-proposal-description-html='{% if let Some(description) = &submission.session_proposal.description %}
                                                          {{ description|md_to_html|json }}
                                                        {% else %}
                                                          ""
                                                        {% endif %}'
                        title="Review submission">
                  <div class="svg-icon size-3 md:size-4 icon-pencil"></div>
                </button>
              </td>
            </tr>
          {% endfor -%}
        {% endif -%}
      </tbody>
    </table>
  </div>
</div>

{% if total > submissions.len() -%}
  {{ pagination::navigation_links(links = navigation_links, hx_target = "#submissions-content", hx_indicator = "#dashboard-spinner") }}
{% endif -%}
