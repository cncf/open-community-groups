{% import "macros/dashboard.html" as dashboard -%}
{% import "macros/badges.html" as badges -%}
{% import "macros/pagination.html" as pagination -%}

{{ dashboard::form_title(title = "Submissions",
description = "Review and manage call for speakers submissions.") -}}

<div id="submissions-refresh"
     hx-get="{{ refresh_url }}"
     hx-trigger="refresh-event-submissions from:body"
     hx-target="#submissions-content"
     hx-swap="innerHTML"></div>

<div class="mt-10">
  <div class="relative overflow-visible">
    <table class="table-auto w-full text-xs lg:text-sm text-left text-stone-500">
      <thead class="text-xs text-stone-700 uppercase bg-stone-100 border-b border-stone-200">
        <tr>
          <th scope="col" class="px-3 xl:px-5 py-3">Speaker</th>
          <th scope="col" class="px-3 xl:px-5 py-3">Proposal</th>
          <th scope="col" class="px-3 xl:px-5 py-3">Status</th>
          <th scope="col" class="px-3 xl:px-5 py-3">Updated</th>
          <th scope="col" class="px-3 xl:px-5 py-3 w-24"></th>
        </tr>
      </thead>
      <tbody>
        {% if submissions.is_empty() -%}
          <tr class="bg-white border-b border-stone-200">
            <td class="px-8 py-16 text-center" colspan="5">
              <div class="flex flex-col items-center justify-center min-h-[125px]">
                <div class="text-lg lg:text-xl">No submissions have been received yet.</div>
              </div>
            </td>
          </tr>
        {% else -%}
          {% for submission in submissions -%}
            <tr class="odd:bg-white even:bg-stone-50/50 border-b border-stone-200">
              <td class="px-3 xl:px-5 py-4">
                <div class="font-medium text-stone-900">
                  {{ submission.speaker.name.as_deref().unwrap_or(&submission.speaker.username) }}
                </div>
                <div class="text-xs text-stone-400">@{{ submission.speaker.username }}</div>
              </td>
              <td class="px-3 xl:px-5 py-4">
                <div class="font-medium text-stone-900 line-clamp-1">{{ submission.session_proposal.title }}</div>
                {% if let Some(level) = &submission.session_proposal.session_proposal_level_name -%}
                  <div class="mt-1">{{ badges::common_badge(content = level, extra_styles = Some("uppercase") ) -}}</div>
                {% endif -%}
                {% if let Some(message) = &submission.action_required_message -%}
                  <div class="mt-2 text-xs text-amber-700 line-clamp-2">Action required: {{ message }}</div>
                {% endif -%}
              </td>
              <td class="px-3 xl:px-5 py-4">
                {{ badges::common_badge(content = submission.status_name, extra_styles = Some("uppercase") ) -}}
              </td>
              <td class="px-3 xl:px-5 py-4 whitespace-nowrap">
                {% if let Some(updated_at) = &submission.updated_at -%}
                  {{ updated_at.format("%b %d, %Y") }}
                {% else -%}
                  {{ submission.created_at.format("%b %d, %Y") }}
                {% endif -%}
              </td>
              <td class="px-3 xl:px-5 py-4">
                <button type="button"
                        class="btn-tertiary p-2"
                        data-action="open-cfs-submission-modal"
                        data-submission='{{ submission|json }}'
                        title="Review submission">
                  <div class="svg-icon size-3 md:size-4 icon-pencil"></div>
                </button>
              </td>
            </tr>
          {% endfor -%}
        {% endif -%}
      </tbody>
    </table>
  </div>
</div>

{% if total > submissions.len() -%}
  {{ pagination::navigation_links(links = navigation_links, hx_target = "#submissions-content", hx_indicator = "#dashboard-spinner") }}
{% endif -%}

{# Review modal -#}
<div id="cfs-submission-modal"
     role="dialog"
     aria-modal="true"
     aria-labelledby="cfs-submission-modal-title"
     data-event-id="{{ event_id }}"
     class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 max-h-full flex z-[1000]">
  <div id="overlay-cfs-submission-modal"
       class="modal-overlay absolute w-full h-full bg-stone-950 opacity-[0.35]"></div>
  <div class="relative p-4 w-full max-w-4xl max-h-full">
    <div class="relative bg-white rounded-lg shadow">
      <div class="flex items-center justify-between p-4 md:p-5 border-b border-stone-200 rounded-t">
        <h3 id="cfs-submission-modal-title"
            class="text-xl font-semibold text-stone-900">Review submission</h3>
        <button id="close-cfs-submission-modal"
                type="button"
                class="group text-stone-400 bg-transparent hover:bg-stone-200 hover:text-stone-900 transition-colors rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center">
          <div class="svg-icon w-5 h-5 bg-stone-500 group-hover:bg-stone-900 transition-colors icon-close"></div>
          <span class="sr-only">Close modal</span>
        </button>
      </div>
      <div class="p-4 md:p-6 grid grid-cols-1 gap-6 lg:grid-cols-2">
        <div class="space-y-5">
          <div>
            <div class="text-xs uppercase text-stone-400">Speaker</div>
            <div id="cfs-submission-speaker-name"
                 class="text-lg font-semibold text-stone-900"></div>
            <div id="cfs-submission-speaker-username" class="text-sm text-stone-500"></div>
          </div>

          <div>
            <div class="text-xs uppercase text-stone-400">Proposal</div>
            <div id="cfs-submission-proposal-title"
                 class="text-lg font-semibold text-stone-900"></div>
            <div id="cfs-submission-proposal-meta" class="text-sm text-stone-500"></div>
          </div>

          <div>
            <div class="text-xs uppercase text-stone-400">Description</div>
            <div id="cfs-submission-proposal-description"
                 class="text-sm/6 text-stone-600 whitespace-pre-wrap"></div>
          </div>

          <div id="cfs-submission-co-speaker" class="hidden">
            <div class="text-xs uppercase text-stone-400">Co-speaker</div>
            <div id="cfs-submission-co-speaker-name" class="text-sm text-stone-600"></div>
          </div>
        </div>

        <div>
          <form id="cfs-submission-form"
                hx-swap="none"
                hx-indicator="#dashboard-spinner"
                hx-disabled-elt="#cfs-submission-submit, #cfs-submission-cancel">
            <div class="space-y-5">
              <div>
                <label for="cfs-submission-status" class="form-label">
                  Status <span class="asterisk">*</span>
                </label>
                <div class="mt-2">
                  <select id="cfs-submission-status"
                          name="status_id"
                          class="select-primary"
                          required>
                    <option value="">Select status</option>
                    {% for status in statuses -%}
                      <option value="{{ status.cfs_submission_status_id }}">{{ status.display_name }}</option>
                    {% endfor -%}
                  </select>
                </div>
              </div>

              <div>
                <label for="cfs-submission-message" class="form-label">Action required message</label>
                <div class="mt-2">
                  <textarea id="cfs-submission-message"
                            name="action_required_message"
                            class="textarea-primary"
                            maxlength="{{ crate::validation::MAX_LEN_DESCRIPTION }}"
                            rows="6"
                            placeholder="Optional message for the speaker"></textarea>
                </div>
              </div>

              <div class="flex items-center justify-end gap-3">
                <button id="cfs-submission-cancel" type="button" class="btn-primary-outline">Cancel</button>
                <button id="cfs-submission-submit" type="submit" class="btn-primary">Update</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
