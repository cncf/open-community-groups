{% import "dashboard/dashboard_macros.html" as dashboard_macros -%}
{% import "common.html" as common -%}

{# Update user details form -#}
<form id="user-details-form"
      hx-put="/dashboard/account/update/details"
      hx-ext="no-empty-vals"
      hx-trigger="submit"
      hx-indicator="#dashboard-spinner, #user-details-spinner"
      hx-disabled-elt="button[type=submit]">
  <div class="space-y-12">
    {# Personal Details section -#}
    <div class="border-b border-stone-900/10 pb-12">
      {% call dashboard_macros::form_title(title = "Personal Details", description = "Your basic profile information.") -%}
      <div class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 md:grid-cols-6 max-w-5xl">
        {# Name -#}
        <div class="col-span-3">
          <label for="name" class="form-label">
            Name <span class="asterisk">*</span>
          </label>
          <div class="mt-2">
            <input type="text"
                   name="name"
                   id="name"
                   value="{{ user.name }}"
                   class="input-primary"
                   autocomplete="off"
                   autocorrect="off"
                   autocapitalize="off"
                   spellcheck="false"
                   required>
          </div>
          <p class="form-legend">Your display name visible to other users.</p>
        </div>
        {# End name -#}

        {# Timezone -#}
        <div class="col-span-3">
          <label for="timezone" class="form-label">Timezone</label>
          <div class="mt-2 grid grid-cols-1">
            <select id="timezone" name="timezone" class="select-primary">
              <option value="">Select a timezone</option>
              {% for timezone in timezones %}
                <option value="{{ timezone }}"
                        {% if let Some(user_timezone) = user.timezone %}
                          {% if timezone.as_str() == user_timezone.as_str() %}selected{% endif %}
                        {% endif %}>{{ timezone }}</option>
              {% endfor %}
            </select>
          </div>
          <p class="form-legend">Your preferred timezone.</p>
        </div>
        {# End timezone -#}

        {# Company -#}
        <div class="col-span-3">
          <label for="company" class="form-label">Company</label>
          <div class="mt-2">
            <input type="text"
                   name="company"
                   id="company"
                   value="{%- if let Some(company) = user.company -%}{{ company }}{%- endif -%}"
                   class="input-primary"
                   autocomplete="off"
                   autocorrect="off"
                   autocapitalize="off"
                   spellcheck="false">
          </div>
          <p class="form-legend">The organization or company you work for.</p>
        </div>
        {# End company -#}

        {# Title -#}
        <div class="col-span-3">
          <label for="title" class="form-label">Title</label>
          <div class="mt-2">
            <input type="text"
                   name="title"
                   id="title"
                   value="{%- if let Some(title) = user.title -%}{{ title }}{%- endif -%}"
                   class="input-primary"
                   autocomplete="off"
                   autocorrect="off"
                   autocapitalize="off"
                   spellcheck="false">
          </div>
          <p class="form-legend">Your professional title or role (e.g. Software Engineer, Product Manager).</p>
        </div>
        {# End title -#}

        {# Photo URL -#}
        <div class="col-span-full">
          <image-field label="Photo" name="photo_url" value="{%- if let Some(photo_url) = user.photo_url -%}{{ photo_url }}{%- endif -%}" image-kind="avatar">
        </image-field>
      </div>
      {# End photo URL -#}

      {# Bio -#}
      <div class="col-span-full">
        <label for="bio" class="form-label">Bio</label>
        <div class="mt-2">
          <textarea id="bio" name="bio" rows="6" class="input-primary">{% if let Some(bio) = user.bio -%}{{ bio }}{% endif %}</textarea>
        </div>
        <p class="form-legend">A description about yourself and your background.</p>
      </div>
      {# End bio -#}

      {# Interests -#}
      <div class="col-span-3">
        <label for="interests" class="form-label">Interests (topics and technologies you're interested in)</label>
        <div class="mt-2">
          <multiple-inputs field-name="interests" input-type="text" label="Interest" items="{%- if let Some(interests) = user.interests -%}{{ interests|json }}{%- endif -%}">
          </multiple-inputs>
        </div>
      </div>
      {# End interests -#}
    </div>
  </div>
  {# End Personal Details section -#}

  {# Location section -#}
  <div class="border-b border-stone-900/10 pb-12">
    {% call dashboard_macros::form_title(title = "Location", description = "Optional location information.") -%}
    <div class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 md:grid-cols-6 max-w-5xl">
      {# City -#}
      <div class="col-span-3">
        <label for="city" class="form-label">City</label>
        <div class="mt-2">
          <input type="text"
                 name="city"
                 id="city"
                 value="{%- if let Some(city) = user.city -%}{{ city }}{%- endif -%}"
                 class="input-primary"
                 autocomplete="off"
                 autocorrect="off"
                 autocapitalize="off"
                 spellcheck="false">
        </div>
        <p class="form-legend">The city where you're based.</p>
      </div>
      {# End city -#}

      {# Country -#}
      <div class="col-span-3">
        <label for="country" class="form-label">Country</label>
        <div class="mt-2">
          <input type="text"
                 name="country"
                 id="country"
                 value="{%- if let Some(country) = user.country -%}{{ country }}{%- endif -%}"
                 class="input-primary"
                 autocomplete="off"
                 autocorrect="off"
                 autocapitalize="off"
                 spellcheck="false">
        </div>
        <p class="form-legend">Your country of residence.</p>
      </div>
      {# End country -#}
    </div>
  </div>
  {# End Location section -#}

  {# Social links section -#}
  <div class="border-b border-stone-900/10 pb-12">
    {% call dashboard_macros::form_title(title = "Social links", description = "Optional social media profiles and website links.") -%}
    <div class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 md:grid-cols-6 max-w-5xl">
      {# Website URL -#}
      <div class="col-span-full lg:col-span-3">
        <label for="website_url" class="form-label">Website</label>
        <div class="mt-2 relative">
          <div class="absolute inset-y-0 rtl:inset-r-0 start-0 flex items-center ps-3 pointer-events-none">
            <div class="svg-icon size-4 icon-link bg-stone-300"></div>
          </div>
          <input type="url"
                 name="website_url"
                 id="website_url"
                 value="{%- if let Some(website_url) = user.website_url -%}{{ website_url }}{%- endif -%}"
                 class="input-primary ps-10"
                 placeholder="https://example.com">
        </div>
      </div>
      {# End Website URL -#}

      {# LinkedIn URL -#}
      <div class="col-span-full lg:col-span-3">
        <label for="linkedin_url" class="form-label">LinkedIn</label>
        <div class="mt-2 relative">
          <div class="absolute inset-y-0 rtl:inset-r-0 start-0 flex items-center ps-3 pointer-events-none">
            <div class="svg-icon size-4 icon-linkedin bg-stone-300"></div>
          </div>
          <input type="url"
                 name="linkedin_url"
                 id="linkedin_url"
                 value="{%- if let Some(linkedin_url) = user.linkedin_url -%}{{ linkedin_url }}{%- endif -%}"
                 class="input-primary ps-10"
                 placeholder="https://linkedin.com/in/username">
        </div>
      </div>
      {# End LinkedIn URL -#}

      {# Twitter URL -#}
      <div class="col-span-full lg:col-span-3">
        <label for="twitter_url" class="form-label">X (formerly Twitter)</label>
        <div class="mt-2 relative">
          <div class="absolute inset-y-0 rtl:inset-r-0 start-0 flex items-center ps-3 pointer-events-none">
            <div class="svg-icon size-4 icon-twitter bg-stone-300"></div>
          </div>
          <input type="url"
                 name="twitter_url"
                 id="twitter_url"
                 value="{%- if let Some(twitter_url) = user.twitter_url -%}{{ twitter_url }}{%- endif -%}"
                 class="input-primary ps-10"
                 placeholder="https://x.com/username">
        </div>
      </div>
      {# End Twitter URL -#}

      {# Facebook URL -#}
      <div class="col-span-full lg:col-span-3">
        <label for="facebook_url" class="form-label">Facebook</label>
        <div class="mt-2 relative">
          <div class="absolute inset-y-0 rtl:inset-r-0 start-0 flex items-center ps-3 pointer-events-none">
            <div class="svg-icon size-4 icon-facebook bg-stone-300"></div>
          </div>
          <input type="url"
                 name="facebook_url"
                 id="facebook_url"
                 value="{%- if let Some(facebook_url) = user.facebook_url -%}{{ facebook_url }}{%- endif -%}"
                 class="input-primary ps-10"
                 placeholder="https://facebook.com/username">
        </div>
      </div>
      {# End Facebook URL -#}
    </div>
  </div>
  {# End social links section -#}

  <div class="mt-6">
    <button type="submit" class="btn-primary relative">
      {% call common::btn_spinner(id = "user-details-spinner", spinner_type = "2") -%}
      Save
    </button>
  </div>
</div>
</form>
{# End update user details -#}

{% if has_password -%}
  <hr class="w-full h-1 mx-auto my-12 bg-stone-200 border-0">

  {# Update user password form -#}
  <form id="password-form"
        hx-put="/dashboard/account/update/password"
        hx-ext="no-empty-vals"
        hx-trigger="submit"
        hx-target="body"
        hx-indicator="#dashboard-spinner, #password-update-spinner"
        hx-disabled-elt="button[type=submit]">
    <div class="space-y-12">
      <div>
        {% call dashboard_macros::form_title(title = "Update password", description = "After updating your password all your current sessions will be terminated and you will need to log back in.") -%}

        <div class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 md:grid-cols-6 max-w-5xl">
          <div class="col-span-3">
            <label for="old_password" class="form-label">
              Current password <span class="asterisk">*</span>
            </label>
            <div class="mt-2">
              <input type="password"
                     id="old_password"
                     name="old_password"
                     class="input-primary"
                     required>
            </div>
          </div>

          <div class="col-span-3"></div>

          <div class="col-span-3">
            <label for="new_password" class="form-label">
              New password <span class="asterisk">*</span>
            </label>
            <div class="mt-2">
              <input type="password"
                     id="new_password"
                     name="new_password"
                     class="input-primary"
                     required>
            </div>
          </div>

          <div class="col-span-3">
            <label for="password_confirmation" class="form-label">
              Repeat new password <span class="asterisk">*</span>
            </label>
            <div class="mt-2">
              <input type="password"
                     id="password_confirmation"
                     name="password_confirmation"
                     class="input-primary"
                     required>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-6 items-center">
        <button type="submit" class="btn-primary relative">
          {% call common::btn_spinner(id = "password-update-spinner", spinner_type = "2") -%}
          Save
        </button>
      </div>
    </div>
  </form>
  {# End update user password form -#}
{% endif -%}

<script type="module" src="/static/js/common/image-field.js"></script>

<script type="module">
  import {
    handleHtmxResponse
  } from '/static/js/common/alerts.js';

  const userDetailsForm = document.getElementById('user-details-form');
  const passwordForm = document.getElementById('password-form');

  if (userDetailsForm) {
    userDetailsForm.addEventListener('htmx:afterRequest', (e) => {
      const xhr = e.detail?.xhr;
      handleHtmxResponse({
        xhr,
        successMessage: 'You have successfully updated your details.',
        errorMessage: 'Something went wrong updating the user details, please try again later.'
      });
    });
  }

  if (passwordForm) {
    const password = document.getElementById('new_password');
    const passwordConfirmation = document.getElementById('password_confirmation');

    const isValidPassword = () => {
      // Check if passwords match
      if (password.value !== passwordConfirmation.value) {
        passwordConfirmation.setCustomValidity('Passwords do not match');
      } else {
        passwordConfirmation.setCustomValidity('');
      }
    };

    password.addEventListener('input', isValidPassword);
    passwordConfirmation.addEventListener('input', isValidPassword);

    passwordForm.addEventListener('htmx:afterRequest', (e) => {
      const xhr = e.detail?.xhr;
      handleHtmxResponse({
        xhr,
        successMessage: 'You have successfully updated your password.',
        errorMessage: 'Something went wrong updating the password, please try again later.'
      });
    });
  }
</script>
