{% import "macros/ui.html" as ui -%}
{% import "macros/feedback.html" as feedback -%}
{% import "macros/search.html" as search -%}
{% import "macros/pagination.html" as pagination -%}

{% let view_mode = self.view_mode.clone().unwrap_or_default() -%}

{% match view_mode -%}
{% when ViewMode::Calendar -%}
{# Calendar view -#}
<div class="mt-5 border-t border-stone-100 md:mt-7 p-5 md:p-7">
  <div class="flex justify-between items-center mb-8">
    <div id="calendar-date"
         class="text-xl font-semibold text-stone-600 md:text-2xl lg:text-[2rem]"></div>

    <div class="flex items-center">
      {# Loading spinner -#}
      <div id="loading-calendar" class="me-3 w-6 group">{{ ui::spinner(htmx = false) -}}</div>
      {# End loading spinner -#}

      {# Today button -#}
      <button id="current-month-btn" class="btn-primary-outline btn-mini h-[30px]">Today</button>
      {# End today button -#}

      {# Next/Prev buttons -#}
      <div class="inline-flex ml-4" role="group">
        <button id="prev-month-btn"
                type="button"
                class="group cursor-pointer inline-flex items-center pr-4 pl-3 py-1 text-xs font-medium text-primary-500 bg-transparent border border-primary-500 rounded-s-full hover:bg-primary-500 hover:text-white transition-colors focus:z-10 focus:ring-4 focus:ring-primary-300 focus:bg-primary-500 focus:text-white active:ring-4 active:ring-primary-300 active:bg-primary-500 active:text-white">
          <div class="svg-icon h-5 w-5 bg-primary-500 group-hover:bg-white group-focus:bg-white transition-colors icon-arrow-left">
          </div>
        </button>
        <button id="next-month-btn"
                type="button"
                class="group cursor-pointer inline-flex items-center -ml-px pl-4 pr-3 py-1 text-xs font-medium text-primary-500 bg-transparent border border-primary-500 rounded-e-full hover:bg-primary-500 hover:text-white transition-colors focus:z-10 focus:ring-2 focus:ring-primary-300 focus:bg-primary-500 focus:text-white active:ring-4 active:ring-primary-300 active:bg-primary-500 active:text-white">
          <div class="svg-icon h-5 w-5 bg-primary-500 group-hover:bg-white group-focus:bg-white transition-colors icon-arrow-right">
          </div>
        </button>
      </div>
      {# End next/prev buttons -#}
    </div>
  </div>

  <div class="relative">
    {# Placeholder calendar -#}
    {% if events.len() == 0 -%}
      <div class="absolute mt-10 z-[10] no-results-default hidden">
        {{ feedback::alert(title = "No events found", content = "By default, only upcoming events are displayed. You can adjust the date range in the filters to search for past events, or try different search criteria.") -}}
      </div>
      <div class="absolute mt-10 z-[10] no-results-filtered hidden">
        {{ feedback::alert(title = "No events found", content = "We can't seem to find any events that match your search criteria. You can reset your filters or try a different search.") -}}
      </div>
    {% endif -%}
    {# End placeholder calendar -#}
    <div id="calendar-box"
         class="min-h-[500px] fc fc-media-screen fc-direction-ltr fc-theme-standard
                {% if events.len() == 0 -%}opacity-30{%- endif %}">
      {# Main loading spinner -#}
      <div id="main-loading-calendar"
           role="status"
           class="absolute inset-0 flex items-center justify-center hidden">
        {{ ui::main_loading() -}}
        <span class="sr-only">Loading...</span>
      </div>
      {# End main loading spinner -#}
    </div>
  </div>

</div>
{# djlint:off #}
<script type="module">
  import {
    Calendar
  } from '/static/js/community/explore/calendar.js';

  const calendar = new Calendar({ events: {{ events|json|safe }} });

  const currentMonthBtn = document.getElementById('current-month-btn');
  if (currentMonthBtn) {
    currentMonthBtn.addEventListener('click', () => {
      calendar.currentMonth()
      currentMonthBtn.blur();
    });
  }

  const prevMonthBtn = document.getElementById('prev-month-btn');
  if (prevMonthBtn) {
    prevMonthBtn.addEventListener('click', () => {
      calendar.previousMonth();
      prevMonthBtn.blur();
    });
  }

  const nextMonthBtn = document.getElementById('next-month-btn');
  if (nextMonthBtn) {
    nextMonthBtn.addEventListener('click', () => {
      calendar.nextMonth();
      nextMonthBtn.blur();
    });
  }
</script>
{# djlint:on #}
{# End calendar view -#}

{% when ViewMode::List -%}
{# List view -#}
<div class="flex flex-col divide-y divide-stone-200 mt-5 border-t border-stone-200 md:mt-7
            {% if events.len() > 0 %}border-b{% endif %}">
  {# Placeholder cards -#}
  {% if events.len() == 0 -%}
    <div class="no-results-default hidden">
      {{ feedback::alert(title = "No events found", content = "By default, only upcoming events are displayed. You can adjust the date range in the filters to search for past events, or try different search criteria.") -}}
    </div>
    <div class="no-results-filtered hidden">
      {{ feedback::alert(title = "No events found", content = "We can't seem to find any events that match your search criteria. You can reset your filters or try a different search.") -}}
    </div>
  {% endif -%}
  {# End placeholder cards -#}

  {# Cards -#}
  {% for event in events %}<div class="p-5 md:p-7 h-full">{{ event|safe }}</div>{% endfor %}
  {# End cards -#}
</div>

{# Pagination -#}
{% if events.len() > 0 -%}
  {{ pagination::navigation_links(links = navigation_links, hx_target = "#cards-list", hx_swap = "innerHTML show:#header:top", hx_indicator = "#loading-filters, #loading-filters-mobile") }}
{% endif %}
{# End pagination -#}

<script type="module">
  import {
    updateResults
  } from '/static/js/community/explore/explore.js';

  updateResults('{{ search::current_page(total, events.len(), offset) }}');
</script>
{# End list view -#}

{% when ViewMode::Map -%}
{# Map view -#}
<div class="mt-5 border-t border-stone-100 md:mt-7 p-5 md:p-7">
  <div class="relative w-full border border-stone-200 h-[600px] md:h-[820px] overflow-hidden">
    {# Loading spinner -#}
    <div id="loading-map" class="absolute top-3 start-3 w-6 z-[450] group">{{ ui::spinner(htmx = false) -}}</div>
    {# End loading spinner -#}

    {# Placeholder map -#}
    {% if events.len() == 0 -%}
      <div class="absolute mt-10 z-[425] no-results-default hidden">
        {{ feedback::alert(title = "No events found", content = "By default, only upcoming events are displayed. You can adjust the date range in the filters to search for past events, or try different search criteria.") -}}
      </div>
      <div class="absolute mt-10 z-[425] no-results-filtered hidden">
        {{ feedback::alert(title = "No events found", content = "We can't seem to find any events that match your search criteria. You can reset your filters or try a different search.") -}}
      </div>
    {% endif -%}
    {# End placeholder map -#}

    <div id="map-box"
         class="relative w-full h-full leaflet-container leaflet-touch leaflet-retina leaflet-fade-anim leaflet-grab leaflet-touch-drag leaflet-touch-zoom
                {% if events.len() == 0 -%}opacity-30{%- endif %}">
      {# Main loading spinner -#}
      <div id="main-loading-map"
           role="status"
           class="absolute inset-0 flex items-center justify-center hidden">
        {{ ui::main_loading() -}}
        <span class="sr-only">Loading...</span>
      </div>
      {# End main loading spinner -#}
    </div>
  </div>
</div>

{# djlint:off #}
<script type="module">
  import {
    Map
  } from '/static/js/community/explore/map.js';

  const map = new Map('events', { events: {{ events|json|safe }}, bbox: {{ bbox|json|safe }} });
</script>
{# djlint:on #}
{# End map view -#}

{% endmatch -%}

{% if events.len() == 0 -%}
  {# djlint:off #}
<script type="module">
  import { hasActiveFilters } from '/static/js/community/explore/filters.js';

  const filtered = hasActiveFilters('events-form');
  document.querySelectorAll('.no-results-default')
    .forEach((el) => el.classList.toggle('hidden', filtered));
  document.querySelectorAll('.no-results-filtered')
    .forEach((el) => el.classList.toggle('hidden', !filtered));
</script>
  {# djlint:on #}
{% endif -%}
