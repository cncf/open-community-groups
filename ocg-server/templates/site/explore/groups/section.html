{% extends "site/explore/entity_section_base.html" -%}
{% import "macros/search.html" as search -%}

{# Filters -#}
{% block filters_desktop -%}
  {% include "site/explore/groups/filters.html" -%}
{% endblock filters_desktop -%}

{% block filters_mobile -%}
  {% include "site/explore/groups/filters.html" -%}
{% endblock filters_mobile -%}
{# End filters -#}

{# Sort options -#}
{% block sort_options -%}
  {% let current_sort_by = filters.sort_by.clone().unwrap_or("name".to_string()) -%}
  <select id="sort_selector"
          name="sort_by"
          class="block w-24 py-1 px-3 text-[0.775rem] leading-none h-[30px] text-stone-900 bg-white border border-stone-200 rounded-full focus:outline-none focus:ring-0 focus:border-stone-200 hover:border-primary-500 focus:hover:border-primary-500 transition-colors">
    <option value="date" {% if current_sort_by == "date" %}selected{% endif %}>Date</option>
    {% if filters.longitude.is_some() && filters.latitude.is_some() -%}
      <option value="distance"
              {% if current_sort_by == "distance" %}selected{% endif %}>Distance</option>
    {% endif -%}
    <option value="name" {% if current_sort_by == "name" %}selected{% endif %}>Name</option>
  </select>
{% endblock sort_options -%}
{# End sort options -#}

{# Current page status -#}
{% block current_page -%}
  {% if results_section.groups.len() > 0 -%}
    {{ search::current_page(total = results_section.total, items_number = results_section.groups.len() , offset_value = filters.offset) -}}
  {% endif -%}
{% endblock current_page -%}
{# End current page status -#}

{# Search bar -#}
{% block search_bar -%}
  {{ search::search_bar(placeholder = "Search groups", input_styles = "w-full md:w-3/4", container_styles = "justify-center", with_help = true, value = filters.ts_query) -}}
  <script type="module">
    import {
      cleanInputField,
      searchOnEnter,
      triggerChangeOnForm
    } from '/static/js/community/explore/filters.js';

    const searchBtn = document.getElementById('search-btn');
    if (searchBtn) {
      searchBtn.addEventListener('click', () => triggerChangeOnForm("groups-form", true));
    }

    const searchInput = document.getElementById('ts_query');
    if (searchInput) {
      searchInput.addEventListener('keydown', () => searchOnEnter(event, "groups-form"));
    }

    const cleanSearch = document.getElementById('clean-search');
    if (cleanSearch) {
      cleanSearch.addEventListener('click', () => cleanInputField('ts_query', 'groups-form'));
    }
  </script>
{% endblock search_bar -%}
{# End search bar -#}

{# Main content -#}
{% block content -%}
  {{ results_section|safe }}
{% endblock content -%}
{# End main content -#}

{# Trigger re-fetch with default sort when no sort_by was provided -#}
{% if filters.sort_by.is_none() -%}
  <script type="module">
    import {
      triggerChangeOnForm
    } from '/static/js/community/explore/filters.js';
    triggerChangeOnForm("groups-form");
  </script>
{% endif -%}
