{% extends "common/base.html" -%}
{% import "macros/feedback.html" as feedback -%}
{% import "macros/search.html" as search -%}

{% block scripts -%}
  <script type="module" src="/static/js/common/images-gallery.js"></script>
{% endblock scripts -%}

{% block jumbotron -%}
  {# Jumbotron -#}
  <div class="relative container mx-auto max-w-7xl px-4 pt-2 xl:pt-5 pb-10 sm:px-6 lg:px-8">
    <section>
      <div class="relative z-10 max-w-screen-xl pb-7 lg:pb-14">
        {# Site title -#}
        <h1 class="text-center mb-8 text-[1.4rem] font-semibold tracking-tight leading-8 sm:leading-none md:text-2xl lg:text-4xl xl:text-5xl">
          {{ site_settings.title }}
        </h1>
        {# End site title -#}

        {# Community description -#}
        {% if let Some(c) = &community -%}
          <div class="mb-8 font-normal text-stone-600 jumbotron-description">{{ c.description|md_to_html|safe }}</div>
        {% endif -%}
        {# End community description -#}

        {# Search bar -#}
        <div>
          {{ search::search_bar(placeholder = "Search groups and events", input_styles = "w-[100%] lg:w-[50%]", container_styles = "mb-6", with_help = false) -}}
          <script type="module">
            import {
              loadExplorePage
            } from '/static/js/community/home/home.js';
            import {
              cleanInputField,
              searchOnEnter
            } from '/static/js/community/explore/filters.js';

            const searchHomeBtn = document.getElementById('search-btn');
            if (searchHomeBtn) {
              searchHomeBtn.addEventListener('click', loadExplorePage);
            }

            const searchInput = document.getElementById('ts_query');
            if (searchInput) {
              searchInput.addEventListener('keydown', () => searchOnEnter(event));
            }

            const cleanSearch = document.getElementById('clean-search');
            if (cleanSearch) {
              cleanSearch.addEventListener('click', () => cleanInputField('ts_query'));
            }
          </script>
        </div>
        {# End search bar -#}

        <div class="flex flex-wrap gap-4">
          <a href="/explore"
             hx-boost="true"
             hx-target="body"
             class="btn-primary-anchor">Explore all</a>
          {% if let Some(c) = &community -%}
            {% if c.new_group_details.is_some() -%}
              <button id="open-new-group-btn"
                      class="btn-secondary cursor-pointer">
                New group
              </button>
            {% endif -%}
          {% endif -%}
        </div>
      </div>

    </section>
  </div>
  {# End jumbotron -#}

  {# New group modal -#}
  {% include "common/new_group_modal.html" -%}
  {# End new group modal -#}

  {# New group button script -#}
  {% if let Some(c) = &community -%}
    {% if c.new_group_details.is_some() -%}
      <script type="module">
        import {
          toggleModalVisibility
        } from '/static/js/common/common.js';

        const openNewGroupBtn = document.getElementById('open-new-group-btn');
        if (openNewGroupBtn) {
          openNewGroupBtn.addEventListener('click', () => toggleModalVisibility('new-group-modal'));
        }
      </script>
    {% endif -%}
  {% endif -%}
  {# End new group button script -#}
{% endblock jumbotron -%}

{% block content -%}
  {# Main content -#}
  <div class="container mx-auto max-w-7xl px-4 pb-6 lg:pb-12 sm:px-6 lg:px-8 pt-10">
    {# Stats -#}
    {{ stats|safe }}
    {# End stats -#}

    <div class="pt-3 xl:pt-8">
      {# Events in-person -#}
      {{ events_list(title = "upcoming in-person events", link = "/explore?entity=events&kind=in-person", events = upcoming_in_person_events) -}}
      {# End events in-person -#}

      {# Events online -#}
      {{ events_list(title = "upcoming virtual events", link = "/explore?entity=events&kind=virtual", events = upcoming_virtual_events) -}}
      {# End events online -#}

      {# Banner -#}
      {% if let Some(c) = &community -%}
        {% if let Some(ad_banner_url) = &c.ad_banner_url -%}
          <div class="hidden pb-2 lg:pb-8 xl:pb-16 md:flex">
            {% if let Some(ad_banner_link_url) = &c.ad_banner_link_url -%}
              <a rel="noopener noreferrer"
                 href="{{ ad_banner_link_url }}"
                 target="_blank"
                 aria-label="Open external link">
              {% endif -%}
              <div class="mx-auto my-4 lg:my-8 border-4 border-stone-100 w-[85%] lg:[w-80%] xl:w-[70%]">
                <img class="h-auto max-w-[100%]"
                     height="auto"
                     width="auto"
                     alt="Decorator"
                     src="{{ ad_banner_url }}"
                     title="Banner">
              </div>
              {% if let Some(ad_banner_link_url) = &c.ad_banner_link_url -%}
              </a>
            {% endif -%}
          </div>
        {% endif -%}
      {% endif -%}
      {# End banner -#}

      {# Latest groups added -#}
      <div class="flex items-center justify-between mb-2 md:mb-6">
        <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-10">Latest groups added</div>
        {# See all groups on desktop -#}
        <div class="hidden justify-self-end md:flex">
          <a href="/explore?entity=groups" class="btn-secondary-anchor ms-4">See all groups</a>
        </div>
        {# End see all groups on desktop -#}
      </div>
      <div class="mt-5 mb-3 lg:mt-10 lg:mb-10">
        {# Groups cards -#}
        {% if recently_added_groups.len() > 0 -%}
          <div class="grid-1 grid gap-8 lg:gap-12 md:grid-cols-2 xl:grid-cols-3 [&>a:nth-child(n+6)]:hidden md:[&>a:nth-child(n+6)]:flex md:[&>a:nth-child(n+9)]:hidden xl:[&>a:nth-child(n+9)]:flex">
            {% for group in recently_added_groups -%}
              {{ group|safe }}
            {% endfor -%}
          </div>
        {% else -%}
          {{ feedback::placeholder(title = "Groups coming soon",
                    content = "Community organizers are still setting this up, check back soon for new groups.") -}}
        {% endif -%}
        {# End groups cards -#}
        {# See all groups mobile button -#}
        <div class="flex mt-9 justify-self-center md:hidden md:mt-0">
          <a href="/explore?entity=groups" class="btn-secondary-anchor">See all groups</a>
        </div>
        {# End see all groups mobile button -#}
      </div>
      {# End latest groups added -#}
    </div>
  </div>
  {# End main content -#}

  {# Gallery -#}
  {% if let Some(c) = &community -%}
    {% if let Some(photos_urls) = &c.photos_urls -%}
      {% if !photos_urls.is_empty() -%}
        <div class="bg-stone-100 pt-2 lg:pt-10 pb-6 lg:pb-12">
          <div class="container mx-auto max-w-7xl px-4 py-3 lg:py-10 lg:px-6 lg:px-8">
            <!-- Title -->
            <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-10 pb-6 lg:pb-10">Gallery</div>
            <!-- End title -->
            <images-gallery title="Gallery" altImage="Community {{ c.display_name }}" images="{{ photos_urls|json }}"></images-gallery>
          </div>
        </div>
      {% endif -%}
    {% endif -%}
  {% endif -%}
  {# End gallery -#}

  {# Community social links and extra links -#}
  {% if let Some(c) = &community -%}
    {% let has_social_links = c.twitter_url.is_some() || c.github_url.is_some() || c.linkedin_url.is_some() || c.instagram_url.is_some() || c.wechat_url.is_some() || c.youtube_url.is_some() || c.flickr_url.is_some() || c.facebook_url.is_some() || c.slack_url.is_some() -%}
    {% let has_extra_links = c.extra_links.is_some() -%}
    {% if has_social_links || has_extra_links -%}
      <div class="bg-stone-900 text-white py-8 lg:py-12">
        <div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
          {# Social network links -#}
          {% if has_social_links -%}
            <nav class="flex flex-wrap justify-center gap-4 mb-8"
                 aria-label="Social media links">
              {{ social_icon_link(kind = "twitter", url = &c.twitter_url) -}}
              {{ social_icon_link(kind = "github", url = &c.github_url) -}}
              {{ social_icon_link(kind = "linkedin", url = &c.linkedin_url) -}}
              {{ social_icon_link(kind = "instagram", url = &c.instagram_url) -}}
              {{ social_icon_link(kind = "wechat", url = &c.wechat_url) -}}
              {{ social_icon_link(kind = "youtube", url = &c.youtube_url) -}}
              {{ social_icon_link(kind = "flickr", url = &c.flickr_url) -}}
              {{ social_icon_link(kind = "facebook", url = &c.facebook_url) -}}
              {{ social_icon_link(kind = "slack", url = &c.slack_url) -}}
            </nav>
          {% endif -%}
          {# End social network links -#}

          {# Extra links -#}
          {% if let Some(extra_links) = &c.extra_links -%}
            <div class="text-center">
              <div class="font-bold text-sm uppercase text-stone-300 mb-2">Quick links</div>
              <div class="text-sm/6 md:text-base">
                {% for (name, url) in extra_links -%}
                  {% if !loop.first -%}
                    <span class="px-2 text-stone-300 md:px-3">Â·</span>
                  {% endif -%}
                  <a href="{{ url }}"
                     class="tracking-wider text-sm text-white hover:text-primary-500 transition-colors"
                     target='{%- if url.starts_with("/") -%}_self{%- else -%}_blank{%- endif -%}'
                     rel="noopener noreferrer">{{ name }}</a>
                {% endfor -%}
              </div>
            </div>
          {% endif -%}
          {# End extra links -#}
        </div>
      </div>
    {% endif -%}
  {% endif -%}
  {# End community social links and extra links -#}
{% endblock content -%}

{# Events list -#}
{% macro events_list(title, link, events) -%}
  <div class="my-5 pb-0 lg:pb-1 xl:pb-5 lg:my-6 xl:my-8">
    <div class="flex items-center justify-between mb-3 lg:mb-6">
      {# Title -#}
      <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-10">{{ title }}</div>
      {# End title -#}

      {# See all events on desktop -#}
      <div class="hidden justify-self-end md:flex">
        <a href="{{ link }}"
           hx-boost="true"
           hx-target="body"
           class="btn-secondary-anchor ms-4">See all events</a>
      </div>
      {# End see all events on desktop -#}
    </div>
    <div class="my-5 xl:my-10">
      {# Cards list -#}
      {% if events.len() > 0 -%}
        <div class="grid-1 grid gap-8 lg:gap-12 md:grid-cols-2 xl:grid-cols-3 [&>a:nth-child(n+6)]:hidden md:[&>a:nth-child(n+6)]:flex md:[&>a:nth-child(n+9)]:hidden xl:[&>a:nth-child(n+9)]:flex">
          {% for event in events -%}
            {{ event|safe }}
          {% endfor -%}
        </div>
      {% else -%}
        {% let base_title = title -%}
        {{ feedback::placeholder(title = "No " ~ base_title,
                content = "We don't have any " ~ base_title ~ " yet, check back soon for fresh listings.") -}}
      {% endif -%}
      {# End cards list -#}

      {# See all events on mobile -#}
      <div class="flex mt-9 justify-self-center md:hidden md:mt-0">
        <a href="{{ link }}"
           hx-boost="true"
           hx-target="body"
           class="btn-secondary-anchor">See all events</a>
      </div>
      {# See all events on mobile -#}
    </div>
  </div>
{% endmacro events_list -%}
{# End events list -#}

{# Social icon link -#}
{% macro social_icon_link(kind, url) -%}
  {% if let Some(url) = &url -%}
    <a href="{{ url }}"
       class="content-center"
       target="_blank"
       rel="noopener noreferrer"
       aria-label="{{ kind | title }} (opens in new window)">
      <div class="svg-icon h-8 w-8 bg-white hover:bg-primary-500 transition-colors icon-{{ kind }}"></div>
    </a>
  {% endif -%}
{% endmacro social_icon_link -%}
{# End social icon link -#}
