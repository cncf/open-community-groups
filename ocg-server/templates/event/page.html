{% extends "common/base.html" -%}
{% import "common.html" as common -%}

{% block scripts -%}
  <script type="module" src="/static/js/common/images-gallery.js"></script>
  <script type="module" src="/static/js/common/people-list.js"></script>
  <script type="module" src="/static/js/common/user-chip.js"></script>
{% endblock scripts -%}

{% block content -%}
  {% let has_social_links = event.meetup_url.is_some() -%}
  {# Community title -#}
  <div class="text-center pt-2 xl:pt-5">
    <h1 class="mb-2 xl:mb-6 mx-3 md:mx-5 text-[1.15rem] font-semibold tracking-tight leading-none md:text-2xl lg:text-4xl xl:text-5xl">
      {{ community.title }}
    </h1>
  </div>
  {# End community title -#}
  <div class="relative container mx-auto max-w-7xl p-4 pb-8 sm:p-6 lg:p-8 lg:pb-16 flex grow h-full">
    <div class="bg-white border border-stone-200 rounded-lg flex flex-col gap-y-8 py-8 w-full">
      {# Event header with name and group -#}
      <div class="px-4 sm:px-6 lg:px-8">
        {# Main flex container for logo, name/group, and social networks -#}
        <div class="flex flex-1 flex-row items-stretch gap-6">
          {# Event logo -#}
          {% call common::logo(logo_url = event.logo_url, classes = "hidden sm:block h-20 w-20 md:h-28 md:w-28", size = 112, color = event.color, name = Some(event.group.name)) -%}
          {# End event logo -#}

          <div class="flex-1 flex flex-col justify-between">
            <div class="flex-1 flex justify-between">
              <div class="flex flex-col justify-between">
                <div>
                  {# Group/Category legend -#}
                  <div>
                    <span class="text-sm font-semibold tracking-wide uppercase text-stone-400">{{ event.group.name }}</span>
                  </div>
                  {# End group/category legend -#}

                  {# Event name -#}
                  <h1 class="text-xl lg:text-[1.65rem]/[1.2] font-semibold text-stone-900 line-clamp-1 lg:line-clamp-2">
                    {{ event.name|demoji }}
                  </h1>
                  {# End event name -#}
                </div>
              </div>

              {# Event status and social networks -#}
              <div class="hidden md:flex flex-col items-end gap-2">
                {# Event status badge -#}
                {% if event.canceled -%}
                  {% call common::event_badge(kind = event.kind, canceled = true, extra_styles = Some("px-2.5 py-0.5")) -%}
                {% endif -%}
                {# End event status badge -#}

                {# Social networks -#}
                {% if has_social_links -%}
                  <div class="flex flex-wrap gap-2">
                    {% if let Some(meetup_url) = event.meetup_url -%}
                      {% call common::social_link(url = meetup_url, icon_name = "meetup", platform_name = "Meetup") -%}
                    {% endif -%}
                  </div>
                {% endif -%}
                {# End social networks -#}
              </div>
              {# End event status and social networks -#}
            </div>

            <div class="mt-auto flex items-center justify-between">
              {# Event details and date -#}
              <div class="flex items-center gap-4 text-stone-600">
                {% if let Some(starts_at) = event.starts_at -%}
                  <div class="flex items-center">
                    <div class="svg-icon size-3.5 mr-2 bg-stone-600 icon-date"></div>
                    <span class="text-sm">{{ starts_at.with_timezone(event.timezone).format("%B %e, %Y") }}</span>
                  </div>
                {% endif -%}
                {% if let Some(capacity) = event.capacity -%}
                  <div class="flex items-center">
                    <div class="svg-icon size-4 mr-2 bg-stone-600 icon-people"></div>
                    <span class="text-sm">{{ capacity }} capacity</span>
                  </div>
                {% endif -%}
                {% call common::event_badge(kind = event.kind, extra_styles = Some("mt-0.5 px-2.5 py-0.5")) -%}
              </div>
              {# End event details and date -#}

              <div class="hidden md:flex flex-col items-end">
                {# Attend button section -#}
                {% include "event/attend_button.html" %}
                {# End attend button section -#}
              </div>
            </div>
          </div>

        </div>
        {# End main flex container -#}

        {# Event status and social networks (mobile only) -#}
        <div class="md:hidden flex flex-wrap gap-2 mt-4">
          {# Event status badge -#}
          {% if event.canceled -%}
            <div class="px-3 py-1 text-xs font-semibold uppercase rounded-full bg-red-100 text-red-700">Cancelled</div>
          {% else if !event.published -%}
            <div class="px-3 py-1 text-xs font-semibold uppercase rounded-full bg-gray-100 text-gray-700">Draft</div>
          {% endif -%}
          {# End event status badge -#}

          {# Social networks -#}
          {% if has_social_links -%}
            <div class="flex flex-wrap gap-2">
              {% if let Some(meetup_url) = event.meetup_url -%}
                {% call common::social_link(url = meetup_url, icon_name = "meetup", platform_name = "Meetup") -%}
              {% endif -%}
            </div>
          {% endif -%}
          {# End social networks -#}
        </div>
        {# End event status and social networks (mobile) -#}

      </div>
      {# End event header -#}

      {# Main content area -#}
      <div class="px-4 sm:px-6 lg:px-8">
        <div>
          {# Event banner -#}
          {% if let Some(banner_url) = event.banner_url -%}
            <div class="w-full mb-8">
              <div class="relative w-full aspect-[4/1] overflow-hidden rounded-lg bg-white max-h-64 lg:max-h-80">
                <img src="{{ banner_url }}"
                     alt="Event banner"
                     class="absolute inset-0 w-full h-full object-cover"
                     height="auto"
                     width="auto"
                     loading="lazy" />
              </div>
            </div>
          {% endif -%}
          {# End event banner -#}

          {# Location and date section -#}
          {% if event.kind != EventKind::Virtual %}
            {% if event.latitude.is_some() && event.longitude.is_some() %}
              <div class="border border-stone-200 rounded-lg mb-8 overflow-hidden">
                <div class="grid md:grid-cols-2">
                  <div class="grid grid-cols-2">
                    {# Location details -#}
                    <div class="p-3">
                      <h2 class="text-sm uppercase font-semibold text-stone-500 mb-2">Location</h2>
                      <div class="flex items-start space-y-3">
                        <div class="svg-icon size-3 mr-2 mt-[0.175rem] bg-stone-600 icon-location shrink-0"></div>
                        <div class="space-y-1">
                          {% if let Some(venue_name) = event.venue_name -%}
                            <div class="text-sm font-medium text-stone-900">{{ venue_name }}</div>
                          {% endif -%}
                          {% if let Some(venue_address) = event.venue_address -%}
                            <div class="text-xs text-stone-700">{{ venue_address }}</div>
                          {% endif -%}
                          {% if let Some(venue_city) = event.venue_city -%}
                            <div class="text-xs text-stone-700">
                              {% if let Some(venue_zip_code) = event.venue_zip_code -%}
                                <span>{{ venue_zip_code }},</span>
                              {% endif -%}
                              <span>{{ venue_city }}</span>
                            </div>
                          {% endif -%}
                        </div>
                      </div>
                    </div>
                    {# End location details -#}

                    {# Map -#}
                    <div class="h-full overflow-hidden border-l border-stone-200">
                      <div id="event-map"
                           class="w-full h-full cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary-500"
                           role="button"
                           tabindex="0"
                           aria-label="Open full map view"></div>
                    </div>
                    {# End map -#}
                  </div>

                  <div class="border-t md:border-t-0 md:border-l border-stone-200">
                    <div class="p-4">
                      <h2 class="text-sm uppercase font-semibold text-stone-500 mb-2">Event Date</h2>
                      {% if let Some(starts_at) = event.starts_at -%}
                        <div class="text-xl xl:text-3xl font-semibold text-stone-900">
                          {{ starts_at.with_timezone(event.timezone).format("%B %e, %G") }}
                        </div>
                        <div class="mt-2 text-base text-stone-600">
                          {{ starts_at.with_timezone(event.timezone).format("%I:%M %p %Z") }}
                        </div>
                      {% endif -%}
                      {% if let Some(streaming_url) = event.streaming_url -%}
                        <div class="mt-4">
                          <a href="{{ streaming_url }}"
                             target="_blank"
                             rel="noopener noreferrer"
                             class="text-sm text-primary-500 hover:text-primary-600 transition-colors">Join virtual event</a>
                        </div>
                      {% endif -%}
                    </div>
                  </div>
                </div>
              </div>

              {# Event map modal -#}
              <div id="event-map-modal"
                   tabindex="-1"
                   aria-hidden="true"
                   aria-modal="true"
                   role="dialog"
                   class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-[1200] justify-center items-center w-full md:inset-0 h-full max-h-full flex">
                <div id="backdrop-event-map-modal"
                     class="modal-overlay absolute w-full h-full bg-stone-950 opacity-[.35]"></div>
                <div class="relative p-4 w-full max-w-3xl max-h-full">
                  <div class="relative bg-white rounded-lg shadow">
                    <div class="flex items-center justify-between p-4 md:p-5 border-b border-stone-200 rounded-t">
                      <h3 id="event-map-modal-title"
                          class="text-xl font-semibold text-stone-900">{{ event.name|demoji }} location</h3>
                      <button id="close-event-map-modal"
                              type="button"
                              class="group bg-transparent hover:bg-stone-200 transition-colors rounded-full text-sm size-8 ms-auto inline-flex justify-center items-center">
                        <div class="svg-icon h-5 w-5 bg-stone-400 group-hover:bg-stone-900 transition-colors icon-close"></div>
                        <span class="sr-only">Close modal</span>
                      </button>
                    </div>
                    <div class="p-4 md:p-6">
                      <div id="event-map-modal-map"
                           class="w-full h-[400px] md:h-[500px] rounded-lg overflow-hidden border border-stone-200">
                      </div>
                      <div class="flex items-center gap-3 mt-4 text-stone-700 text-sm">
                        <div class="svg-icon size-3 bg-stone-700 icon-location"></div>
                        <div>
                          {% if let Some(venue_name) = event.venue_name -%}
                            <span>{{ venue_name }}</span>
                            {% if event.venue_address.is_some() || event.venue_city.is_some() -%}
                              ,
                            {% endif -%}
                          {% endif -%}
                          {% if let Some(venue_address) = event.venue_address -%}
                            <span>{{ venue_address }}</span>
                            {% if event.venue_city.is_some() -%}
                              ,
                            {% endif -%}
                          {% endif -%}
                          {% if let Some(venue_city) = event.venue_city -%}
                            {% if let Some(venue_zip_code) = event.venue_zip_code -%}
                              <span>{{ venue_zip_code }},</span>
                            {% endif -%}
                            <span>{{ venue_city }}</span>
                          {% endif -%}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              {# End event map modal -#}

              {# Map initialization script -#}
              {# djlint:off #}
                <script type="module">
                  import {
                    loadMap,
                    toggleModalVisibility
                  } from "/static/js/common/common.js";

                  const mapContainer = document.getElementById('event-map');
                  const modalId = 'event-map-modal';
                  const modalMapId = 'event-map-modal-map';
                  let modalMapLoaded = false;

                  const ensureModalMap = () => {
                    if (modalMapLoaded) {
                      return;
                    }
                    modalMapLoaded = true;
                    requestAnimationFrame(() => {
                      loadMap(modalMapId, {{ event.latitude.unwrap() }}, {{ event.longitude.unwrap() }});
                    });
                  };

                  const openEventMapModal = () => {
                    toggleModalVisibility(modalId);
                    ensureModalMap();
                  };

                  loadMap('event-map', {{ event.latitude.unwrap() }}, {{ event.longitude.unwrap() }});

                  if (mapContainer) {
                    mapContainer.addEventListener('click', openEventMapModal);
                    mapContainer.addEventListener('keydown', (event) => {
                      if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        openEventMapModal();
                      }
                    });
                  }

                  const closeEventMapModal = document.getElementById('close-event-map-modal');
                  if (closeEventMapModal) {
                    closeEventMapModal.addEventListener('click', () => toggleModalVisibility(modalId));
                  }

                  const backdropEventMapModal = document.getElementById('backdrop-event-map-modal');
                  if (backdropEventMapModal) {
                    backdropEventMapModal.addEventListener('click', () => toggleModalVisibility(modalId));
                  }
</script>
              {# djlint:on #}
              {# End map initialization script -#}
            {% endif -%}
          {% endif -%}
          {# End location and date section -#}

          {# Event description -#}
          <div>
            <div class="pt-2 pb-8">
              <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-10 pb-6">About this event</div>
              <div class="text-stone-500 text-sm/6 markdown">{{ event.description|md_to_html|safe }}</div>
            </div>
          </div>
          {# End event description -#}

          {# Tags if available -#}
          {% if let Some(tags) = event.tags -%}
            {% if !tags.is_empty() -%}
              <div class="pt-2 pb-8">
                <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-10 pb-6">Topics</div>
                <div class="flex flex-wrap gap-2">
                  {% for tag in tags -%}
                    <span class="inline-block px-3 py-1 bg-stone-50 text-stone-700 text-sm rounded-full uppercase">{{ tag }}</span>
                  {% endfor -%}
                </div>
              </div>
            {% endif -%}
          {% endif -%}
          {# End tags -#}

        </div>
      </div>
      {# End main content area -#}

      {# Sessions section - Full width -#}
      {% if !event.sessions.is_empty() -%}
        {% let days_count = event.sessions.len() -%}
        <div class="px-4 sm:px-6 lg:px-8">
          <div class="pt-2 pb-8">
            <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-10 pb-6">Agenda</div>

            {# Single-day agenda: no date title -#}
            {% if days_count == 1 -%}
              {% for day in event.sessions -%}
                <ol class="relative border-s border-stone-200">
                  {% for session in day.1 %}
                    {% call session_item(session = session, is_last = loop.last) -%}
                  {% endfor %}
                </ol>
              {% endfor -%}
            {% else -%}
              {# Multi-day agenda: tabs with one day per tab -#}
              <ul class="flex flex-wrap space-x-2 -mb-px text-sm font-medium text-center border-b border-stone-200">
                {% for day in event.sessions -%}
                  <li>
                    <button type="button"
                            data-day-tab="day-{{ loop.index }}"
                            data-active="{%- if loop.first -%}true{%- else -%}false{%- endif -%}"
                            class="cursor-pointer inline-flex items-center justify-center p-2 sm:p-3 border-b-2 border-transparent rounded-t-lg hover:text-stone-600 hover:border-stone-300 data-[active=true]:text-primary-500 data-[active=true]:border-primary-500 text-nowrap">
                      {{ day.0.format("%A, %B %e, %Y") }}
                    </button>
                  </li>
                {% endfor -%}
              </ul>

              {% for day in event.sessions -%}
                <div data-day-content="day-{{ loop.index }}"
                     {% if !loop.first -%}
                       hidden
                     {% endif -%}
                     class="pt-6">
                  <ol class="relative border-s border-stone-200">
                    {% for session in day.1 %}
                      {% call session_item(session = session, is_last = loop.last) -%}
                    {% endfor %}
                  </ol>
                </div>
              {% endfor -%}

              <script type="module">
                const dayTabs = document.querySelectorAll('[data-day-tab]');
                const dayPanels = document.querySelectorAll('[data-day-content]');
                dayTabs.forEach((btn) => {
                  btn.addEventListener('click', () => {
                    const target = btn.getAttribute('data-day-tab');
                    dayTabs.forEach(b => b.setAttribute('data-active', b === btn ? 'true' : 'false'));
                    dayPanels.forEach(panel => {
                      const isTarget = panel.getAttribute('data-day-content') === target;
                      panel.toggleAttribute('hidden', !isTarget);
                    });
                  });
                });
              </script>
            {% endif -%}
          </div>
        </div>
      {% endif -%}
      {# End sessions section -#}

      {# Organizers section - Full width -#}
      {% if !event.organizers.is_empty() -%}
        <div class="px-4 sm:px-6 lg:px-8">
          <div class="pt-2 pb-8">
            <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-10 pb-6">Organizers</div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {% for organizer in event.organizers -%}
                {% if organizer.name.is_some() -%}
                  <user-chip name="{{ organizer.name|display_some }}" username="{{ organizer.username }}" image-url="{{ organizer.photo_url|display_some }}" title="{{ organizer.title|display_some }}">
                  </user-chip>
                {% endif -%}
              {% endfor -%}
            </div>
          </div>
        </div>
      {% endif -%}
      {# End organizers section -#}

      {# Sponsors section - Full width -#}
      {% if !event.sponsors.is_empty() -%}
        <div class="px-4 sm:px-6 lg:px-8">
          <div class="pt-2 pb-8">
            <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-10 pb-6">Sponsors</div>
            <div class="flex flex-wrap gap-4">
              {% for sponsor in event.sponsors -%}
                {% call common::sponsor_badge(name = sponsor.name, logo_url = sponsor.logo_url, website_url = sponsor.website_url, level = sponsor.level, with_level = true) -%}
              {% endfor -%}
            </div>
          </div>
        </div>
      {% endif -%}
      {# End sponsors section -#}

      {# Speakers section (legacy data) - Full width -#}
      {% if let Some(legacy_speakers) = event.legacy_speakers -%}
        {% if !legacy_speakers.is_empty() -%}
          <div class="px-4 sm:px-6 lg:px-8">
            <div class="pt-2 pb-8">
              <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-10 pb-6">Speakers</div>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for speaker in legacy_speakers -%}
                  {% if speaker.name.is_some() -%}
                    <user-chip name="{{ speaker.name|display_some }}" username="" image-url="{{ speaker.photo_url|display_some }}" title="{{ speaker.title|display_some }}" bio-is-html bio="{{ speaker.bio.as_deref().unwrap_or("")|md_to_html }}">
                    </user-chip>
                  {% endif -%}
                {% endfor -%}
              </div>
            </div>
          </div>
        {% endif -%}
      {% endif -%}
      {# End speakers section (legacy data) -#}

      {# Hosts section (legacy data) - Full width -#}
      {% if let Some(legacy_hosts) = event.legacy_hosts -%}
        {% if !legacy_hosts.is_empty() -%}
          <div class="px-4 sm:px-6 lg:px-8">
            <div class="pt-2 pb-8">
              <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-10 pb-6">Hosts</div>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for host in legacy_hosts -%}
                  {% if host.name.is_some() -%}
                    <user-chip name="{{ host.name|display_some }}" username="" image-url="{{ host.photo_url|display_some }}" title="{{ host.title|display_some }}" bio-is-html bio="{{ host.bio.as_deref().unwrap_or("")|md_to_html }}">
                    </user-chip>
                  {% endif -%}
                {% endfor -%}
              </div>
            </div>
          </div>
        {% endif -%}
      {% endif -%}
      {# End hosts section (legacy data) -#}

      {# Hosts section - Full width -#}
      {% if !event.hosts.is_empty() -%}
        <div class="px-4 sm:px-6 lg:px-8">
          <div class="pt-2 pb-8">
            <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-10 pb-6">Hosts</div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {% for host in event.hosts -%}
                {% if host.name.is_some() -%}
                  <user-chip name="{{ host.name|display_some }}" username="{{ host.username }}" image-url="{{ host.photo_url|display_some }}" title="{{ host.title|display_some }}">
                  </user-chip>
                {% endif -%}
              {% endfor -%}
            </div>
          </div>
        </div>
      {% endif -%}
      {# End hosts section -#}

      {# Gallery -#}
      {% if let Some(photos_urls) = event.photos_urls -%}
        {% if !photos_urls.is_empty() -%}
          <div class="px-4 sm:px-6 lg:px-8">
            <div class="pt-2 pb-8">
              <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-10 pb-6">Gallery</div>
              <images-gallery title="Gallery" altImage="Event {{ event.name }}" images="{{ photos_urls|json }}"></images-gallery>
            </div>
          </div>
        {% endif -%}
      {% endif -%}
      {# End gallery -#}

    </div>
  </div>
{% endblock content -%}

{# Macro for rendering venue address details -#}
{% macro venue_address(venue_name, venue_address, venue_city, venue_zip_code) -%}
  {% if let Some(name) = venue_name -%}
    <div class="text-sm font-medium text-stone-900 mb-1">{{ name }}</div>
  {% endif -%}
  {% if let Some(address) = venue_address -%}
    <div class="text-xs text-stone-600 mb-0.5">{{ address }}</div>
  {% endif -%}
  {% if let Some(city) = venue_city -%}
    <div class="text-xs text-stone-600">
      {% if let Some(zip_code) = venue_zip_code -%}
        <span>{{ zip_code }},</span>
      {% endif -%}
      <span class="text-xs text-stone-600">{{ city }}</span>
    </div>
  {% endif -%}
{% endmacro -%}

{# Macro for rendering a single host social link -#}
{% macro host_social_link(url, label, icon) -%}
  <a href="{{ url }}"
     target="_blank"
     rel="noopener noreferrer"
     class="group p-1.5 bg-stone-100 hover:bg-primary-500 rounded-full transition-colors"
     aria-label="{{ label }}">
    <div class="svg-icon size-3 bg-stone-600 group-hover:bg-white icon-{{ icon }}"></div>
  </a>
{% endmacro -%}
{# End macro for rendering a single host social link -#}

{# Macro for rendering a single session item -#}
{% macro session_item(session, is_last = false) -%}
  <li class="{% if !is_last %}mb-5 {% endif %}ms-4">
    <div class="absolute size-3 bg-stone-300 rounded-full mt-1 -start-1.5 border border-white"></div>
    <div class="mb-2 text-sm text-stone-500/75">
      {% if let Some(ends_at) = session.ends_at -%}
        {{ session.starts_at.with_timezone(event.timezone).format("%l:%M %p") }} - {{ ends_at.with_timezone(event.timezone).format("%l:%M %p %Z") }}
      {% else -%}
        {{ session.starts_at.with_timezone(event.timezone).format("%l:%M %p %Z") }}
      {% endif -%}
    </div>
    <div class="flex items-center gap-2">
      <h3 class="md:text-lg font-semibold text-stone-900">{{ session.name|demoji }}</h3>
      {% call common::event_badge(kind = session.kind ) -%}
    </div>
    {% if let Some(location) = session.location -%}
      <div class="text-sm/6 text-stone-500 italic mb-3">{{ location }}</div>
    {% endif -%}
    {% if let Some(description) = session.description -%}
      <div class="text-sm/6 text-stone-600 markdown">{{ description|md_to_html|safe }}</div>
    {% endif -%}
    {% if !session.speakers.is_empty() -%}
      <div class="mt-4">
        <div class="text-xs font-semibold text-stone-500 mb-2">SPEAKERS</div>
        <div class="flex flex-grap gap-4">
          {% for speaker in session.speakers -%}
            {% if speaker.name.is_some() -%}
              <user-chip name="{{ speaker.name|display_some }}" username="{{ speaker.username }}" image-url="{{ speaker.photo_url|display_some }}" title="{{ speaker.title|display_some }}" small>
              </user-chip>
            {% endif -%}
          {% endfor -%}
        </div>
      </div>
    {% endif -%}
  </li>
{% endmacro -%}
{# End macro for rendering a single session item -#}
