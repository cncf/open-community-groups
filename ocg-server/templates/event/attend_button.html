{# Attend button section -#}
<div id="attendance-container"
     {% if let Some(starts_at) = &event.starts_at %}data-starts="{{ starts_at.to_rfc3339() }}"{% endif %}
     {% if let Some(remaining_capacity) = &event.remaining_capacity %}
       data-remaining-capacity="{{ remaining_capacity }}"
     {% endif %}
     data-is-live="{{ event.is_live() }}"
     data-has-recording="{{ event.meeting_recording_url.is_some() }}"
     class="flex flex-row flex-wrap gap-2">

  <!-- Loading spinner (shown initially) -->
  <button id="loading-btn"
          disabled
          class="group relative is-loading btn-primary-outline w-52 h-10 sm:h-[30px] opacity-50 cursor-not-allowed flex items-center justify-center">
    {% import "macros/ui.html" as ui -%}
    {{ ui::spinner(size = "size-4") -}}
    <span class="ms-2">Checking...</span>
  </button>

  <!-- Sign in prompt (hidden initially) -->
  <button id="signin-btn"
          data-path="{{ path }}"
          class="hidden group btn-primary-outline-anchor w-52 h-10 sm:h-[30px] flex items-center justify-center space-x-2">
    <div class="svg-icon size-3 icon-user-plus"></div>
    <span>Attend event</span>
  </button>

  <!-- Attend button (hidden initially) -->
  <button id="attend-btn"
          hx-post="/{{ event.community.name }}/event/{{ event.event_id }}/attend"
          hx-swap="none"
          class="hidden group btn-primary-outline w-52 h-10 sm:h-[30px] flex items-center justify-center space-x-2">
    <div class="svg-icon size-3 icon-user-plus"></div>
    <span>Attend event</span>
  </button>

  <!-- Join meeting button (hidden initially, shown for attendees when live) -->
  {% if let Some(meeting_join_url) = &event.meeting_join_url %}
    <a id="join-meeting-btn"
       href="{{ meeting_join_url }}"
       data-join-link
       target="_blank"
       rel="noopener noreferrer"
       class="hidden group btn-primary-outline-anchor w-52 h-10 sm:h-[30px] flex items-center justify-center space-x-2">
      <div class="svg-icon size-3 icon-meeting"></div>
      <span>Join meeting</span>
    </a>
  {% endif %}

  <!-- Leave button (hidden initially) -->
  <button id="leave-btn"
          hx-delete="/{{ event.community.name }}/event/{{ event.event_id }}/leave"
          hx-trigger="confirmed"
          hx-swap="none"
          class="hidden group btn-primary-outline w-52 h-10 sm:h-[30px] flex items-center justify-center space-x-2">
    <div class="svg-icon size-3 icon-logout"></div>
    <span>Cancel attendance</span>
  </button>

  <!-- Hidden element that checks attendance status -->
  <div id="attendance-checker"
       hx-get="/{{ event.community.name }}/event/{{ event.event_id }}/attendance"
       hx-trigger="load, attendance-changed from:body"
       hx-swap="none"></div>
</div>

<script type="module">
  import {
    showConfirmAlert,
    showInfoAlert,
    handleHtmxResponse,
  } from '/static/js/common/alerts.js';
  import {
    isSuccessfulXHRStatus
  } from '/static/js/common/common.js';

  const attendanceContainer = document.getElementById('attendance-container');
  const startsAtValue = attendanceContainer?.dataset?.starts ?? null;
  const remainingCapacityAttr = attendanceContainer?.dataset?.remainingCapacity;
  const remainingCapacity = (() => {
    if (!remainingCapacityAttr) {
      return null;
    }
    const parsedCapacity = Number(remainingCapacityAttr);
    return Number.isFinite(parsedCapacity) ? parsedCapacity : null;
  })();
  const isSoldOut = remainingCapacity !== null && remainingCapacity <= 0;
  const eventIsLive = attendanceContainer?.dataset?.isLive === 'true';
  const hasRecording = attendanceContainer?.dataset?.hasRecording === 'true';
  const isPastEvent = (() => {
    if (!startsAtValue) {
      return false;
    }
    const parsedDate = new Date(startsAtValue);
    if (Number.isNaN(parsedDate.valueOf())) {
      return false;
    }
    const now = new Date();
    return parsedDate < now;
  })();
  const pastEventTitle =
    'You cannot change attendance because the event has already started.';
  const updateButtonStateForEventDate = (button) => {
    if (!button) {
      return;
    }
    if (isPastEvent) {
      button.disabled = true;
      button.title = pastEventTitle;
      button.classList.add('cursor-not-allowed', 'opacity-50');
    } else {
      button.disabled = false;
      button.removeAttribute('title');
      button.classList.remove('cursor-not-allowed', 'opacity-50');
    }
  };

  const applySoldOutState = (button) => {
    if (!button) {
      return;
    }
    if (isSoldOut) {
      button.disabled = true;
      button.title = 'This event is sold out.';
      button.classList.add('cursor-not-allowed', 'opacity-50');
    } else if (!isPastEvent) {
      button.removeAttribute('title');
      button.classList.remove('cursor-not-allowed', 'opacity-50');
    }
  };

  // Toggle visibility of meeting details and join links based on attendance
  // status. Meeting details visible to all attendees. Recordings visible to
  // everyone. Join links: always for attendees in meeting details, only when
  // live for quick-access buttons.
  const toggleMeetingDetailsVisibility = (isAttendee) => {
    const sections = document.querySelectorAll('[data-meeting-details]');

    sections.forEach((section) => {
      const sectionHasRecording = section.dataset?.hasRecording === 'true';

      // Show if: has recording (everyone) OR is attendee
      const showSection = sectionHasRecording || isAttendee;

      section.classList.toggle('hidden', !showSection);
    });

    // Join links in meeting details: visible to all attendees
    const joinLinksAlways = document.querySelectorAll('[data-join-link-always]');
    joinLinksAlways.forEach((link) => {
      link.classList.toggle('hidden', !isAttendee);
    });

    // Quick-access join links: only for attendees when event is live
    const joinLinksLive = document.querySelectorAll('[data-join-link]');
    joinLinksLive.forEach((link) => {
      link.classList.toggle('hidden', !(isAttendee && eventIsLive));
    });
  };

  let userIsAttendee = false;

  updateButtonStateForEventDate(document.getElementById('attend-btn'));
  applySoldOutState(document.getElementById('attend-btn'));
  updateButtonStateForEventDate(document.getElementById('leave-btn'));

  const attendanceHandler = document.getElementById('attendance-checker');

  // Handle attendance check response
  attendanceHandler.addEventListener('htmx:afterRequest', (evt) => {
    const loadingBtn = document.getElementById('loading-btn');
    const signinBtn = document.getElementById('signin-btn');
    const attendBtn = document.getElementById('attend-btn');
    const leaveBtn = document.getElementById('leave-btn');

    // Ensure all buttons exist
    if (!loadingBtn || !signinBtn || !attendBtn || !leaveBtn) {
      return;
    }

    // Hide all buttons first
    loadingBtn.classList.add('hidden');
    signinBtn.classList.add('hidden');
    attendBtn.classList.add('hidden');
    leaveBtn.classList.add('hidden');

    if (isSuccessfulXHRStatus(evt.detail.xhr.status)) {
      // User is authenticated, parse response
      try {
        const response = JSON.parse(evt.detail.xhr.responseText);

        if (response.is_attendee) {
          leaveBtn.classList.remove('hidden');
          updateButtonStateForEventDate(leaveBtn);
          userIsAttendee = true;
          toggleMeetingDetailsVisibility(userIsAttendee);
        } else {
          attendBtn.classList.remove('hidden');
          if (isSoldOut) {
            applySoldOutState(attendBtn);
          } else {
            updateButtonStateForEventDate(attendBtn);
          }
          userIsAttendee = false;
          toggleMeetingDetailsVisibility(userIsAttendee);
        }
      } catch (error) {
        if (isSoldOut) {
          attendBtn.classList.remove('hidden');
          applySoldOutState(attendBtn);
        } else {
          signinBtn.classList.remove('hidden');
          updateButtonStateForEventDate(signinBtn);
        }
        userIsAttendee = false;
        toggleMeetingDetailsVisibility(userIsAttendee);
      }
    } else {
      // User not authenticated or error
      if (isSoldOut) {
        attendBtn.classList.remove('hidden');
        applySoldOutState(attendBtn);
      } else {
        signinBtn.classList.remove('hidden');
        updateButtonStateForEventDate(signinBtn);
      }
      userIsAttendee = false;
      toggleMeetingDetailsVisibility(userIsAttendee);
    }
  });

  // Handle attend button
  document.getElementById('attend-btn').addEventListener('htmx:beforeRequest', () => {
    // Show loading while posting
    document.getElementById('attend-btn').classList.add('hidden');
    document.getElementById('loading-btn').classList.remove('hidden');
  });

  document.getElementById('attend-btn').addEventListener('htmx:afterRequest', (evt) => {
    const xhr = evt.detail?.xhr;
    const ok = handleHtmxResponse({
      xhr,
      successMessage: 'You have successfully registered for this event.',
      errorMessage: 'Something went wrong registering for this event. Please try again later.'
    });
    if (ok) {
      document.body.dispatchEvent(new Event('attendance-changed'));
    } else {
      document.getElementById('loading-btn').classList.add('hidden');
      document.getElementById('attend-btn').classList.remove('hidden');
    }
  });

  // Handle leave button
  document.getElementById('leave-btn').addEventListener('htmx:beforeRequest', () => {
    // Show loading while deleting
    document.getElementById('leave-btn').classList.add('hidden');
    document.getElementById('loading-btn').classList.remove('hidden');
  });

  document.getElementById('leave-btn').addEventListener('htmx:afterRequest', (evt) => {
    const xhr = evt.detail?.xhr;
    const ok = handleHtmxResponse({
      xhr,
      successMessage: 'You have successfully canceled your attendance.',
      errorMessage: 'Something went wrong canceling your attendance. Please try again later.'
    });
    if (ok) {
      document.body.dispatchEvent(new Event('attendance-changed'));
    } else {
      document.getElementById('loading-btn').classList.add('hidden');
      document.getElementById('leave-btn').classList.remove('hidden');
    }
  });

  // Handle sign in button
  const signinBtn = document.getElementById("signin-btn");
  if (signinBtn) {
    signinBtn.addEventListener("click", () => {
      const path = signinBtn.dataset.path || window.location.pathname;
      showInfoAlert(
        `You need to be <a href='/log-in?next_url=${path}' class='underline font-medium' hx-boost='true'>logged in</a> to attend this event.`,
        true,
      );
    });
  }

  // Ask for confirmation before canceling attendance
  const leaveBtnEl = document.getElementById('leave-btn');
  if (leaveBtnEl) {
    leaveBtnEl.addEventListener('click', () => {
      showConfirmAlert(
        'Are you sure you want to cancel your attendance?',
        'leave-btn',
        'Yes'
      );
    });
  }
</script>
