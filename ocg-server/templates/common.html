{# Search bar -#}
{% macro search_bar(placeholder, input_styles, container_styles, with_help, value = None) -%}
  {% let value_ = value.clone().unwrap_or("".to_string()) -%}

  <div class="flex items-center {{ container_styles }}">
    <div class="relative {{ input_styles }}
                {% if with_help -%}
                  md:-ml-[0.75rem]{%- endif -%}">
      <input type="text"
             id="ts_query"
             name="ts_query"
             value="{{ value_ }}"
             class="peer w-[100%] rounded-full border border-stone-200 text-stone-900 placeholder-stone-400 focus:ring-transparent focus:border-primary-500 focus:ring block flex-1 min-w-0 w-60 text-md p-2.5 ps-4 pe-14"
             placeholder="{{ placeholder }}"
             autocomplete="off" />
      <div class="absolute right-[40px] top-[10px] block peer-placeholder-shown:hidden">
        <button id="clean-search"
                class="mr-2 mt-[2px] block peer-placeholder-shown:hidden">
          <div class="svg-icon h-5 w-5 bg-stone-400 hover:bg-stone-700 transition-colors icon-close"></div>
        </button>
      </div>
      <div class="absolute right-[6px] top-[5px]">
        <button id="search-btn"
                class="btn-secondary group p-1.5 h-[30px] w-[30px] mt-[3px] mr-[3px]">
          <div class="svg-icon h-4 w-4 mx-auto bg-primary-500 group-hover:bg-white transition-colors icon-magnifying-glass">
          </div>
        </button>
      </div>

      {% if with_help -%}
        <div class="absolute hidden -right-[1.5rem] top-0 md:block">
          <button id="open-search-tips-modal">
            <div class="svg-icon w-4 h-4 bg-stone-300 hover:bg-stone-700 transition-colors icon-question-mark"></div>
          </button>
        </div>

        {# Search tips modal -#}
        <div id="search-tips"
             tabindex="-1"
             aria-hidden="true"
             class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 max-h-full flex z-1000">
          <div id="overlay-search-tips"
               class="modal-overlay absolute w-full h-full bg-stone-950 opacity-[0.35]"></div>
          <div class="relative p-4 w-full max-w-2xl max-h-full">
            <div class="relative bg-white rounded-lg shadow">
              {# Modal header -#}
              <div class="flex items-center justify-between p-4 md:p-5 border-b border-stone-200 rounded-t">
                <h3 class="text-xl font-semibold text-stone-900">Search tips</h3>
                <button id="close-search-tips-modal"
                        type="button"
                        class="group text-stone-400 bg-transparent hover:bg-stone-200 hover:text-stone-900 transition-colors rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center">
                  <div class="svg-icon w-5 h-5 bg-stone-500 group-hover:bg-stone-900 transition-colors icon-close"></div>
                  <span class="sr-only">Close modal</span>
                </button>
              </div>
              {# End modal header -#}
              {# Modal content -#}
              <div class="p-4 md:p-5 space-y-4">
                <ul class="list-disc text-sm ps-8 pe-4 py-6 leading-8">
                  <li>Use multiple words to refine your search. Example: budapest meeting</li>
                  <li>Use - to exclude words from your search. Example: austin -virtual</li>
                  <li>Put a phrase inside double quotes for an exact match. Example: "Community Group"</li>
                  <li>Use or to combine multiple searches. Example: webAssembly or wasm</li>
                </ul>
              </div>
              {# End modal content -#}
            </div>
          </div>
        </div>
        {# End search tips modal -#}

        <script type="module">
          import {
            toggleModalVisibility
          } from '/static/js/common/common.js';

          const openSearchTipsModal = document.getElementById('open-search-tips-modal');
          if (openSearchTipsModal) {
            openSearchTipsModal.addEventListener('click', () => toggleModalVisibility('search-tips'));
          }

          const overlaySearchTips = document.getElementById('overlay-search-tips');
          if (overlaySearchTips) {
            overlaySearchTips.addEventListener('click', () => toggleModalVisibility('search-tips'));
          }

          const closeSearchTipsModal = document.getElementById('close-search-tips-modal');
          if (closeSearchTipsModal) {
            closeSearchTipsModal.addEventListener('click', () => toggleModalVisibility('search-tips'));
          }
        </script>
      {% endif -%}
    </div>
  </div>
{% endmacro search_bar -%}
{# End search bar -#}

{# Alert -#}
{% macro alert(title, content) -%}
  <div class="p-10 md:p-14">
    <div class="border border-primary-300 p-10 text-sm text-stone-800 rounded-lg bg-primary-50 text-center"
         role="alert">
      <div class="text-xl mb-6">{{ title }}</div>
      {{ content }}
    </div>
  </div>
{% endmacro alert -%}
{# End alert -#}

{# Current page -#}
{% macro current_page(total, items_number, offset_value) -%}
  {%- if items_number + 0 > 0 -%}
    {%- if let Some(offset) = offset_value -%}
      {{ offset + 1 }} - {{ items_number + offset }}
    {%- else -%}
      1 - {{ items_number }}
    {%- endif -%}
    {{ "" }} of {{ total }} results
  {%- endif -%}
{%- endmacro current_page -%}
{# End current page -#}

{# Logo -#}
{% macro logo(logo_url, classes, size, color, border = true, name = None) -%}
  {% if let Some(logo_url) = logo_url -%}
    {% let bg_image = logo_url.replace("c_fill,dpr_2,f_auto,g_center,q_auto:good", &format!("c_scale,w_{}", *size * 2) ) -%}

    <div class="md:my-auto bg-white overflow-hidden bg-no-repeat bg-center bg-contain
                {% if border -%}
                  rounded-lg outline outline-1 outline-stone-300 border border-stone-200 border-[5px] border-white
                {% endif -%}
                {{ classes }}"
         style="background-image: url('{{ bg_image }}')"></div>
  {% else -%}
    <div class="relative md:my-auto bg-white overflow-hidden bg-no-repeat bg-center bg-contain
                {% if border -%}
                  rounded-lg outline outline-1 outline-stone-300 border border-stone-200 border-[5px] border-white
                {% endif -%}
                {{ classes }}">
      <div class="relative h-full w-full flex place-items-center text-[0.78rem] text-stone-600 font-bold leading-5 capitalize z-10
                  {% if border -%}
                    p-2
                  {% endif -%}">
        <p class="w-full text-ellipsis overflow-hidden text-center">{{ name.unwrap_or(&"".to_string() ) }}</p>
      </div>
      <div class="absolute w-full h-full top-0 placeholder-logo"
           style="background-color: {{ color }}"></div>
    </div>
  {% endif -%}
{% endmacro logo -%}
{# End logo -#}

{# Small spinner -#}
{% macro spinner(size = "size-6", spinner_type = "1", extra_styles = "", htmx = true) -%}
  <div role="status"
       class="{% if htmx -%}
                flex
              {% else -%}
                hidden group-[.is-loading]:flex
              {% endif -%}
              {{ extra_styles }}">
    <img src="/static/images/spinner/spinner_{{ spinner_type }}.svg"
         height="auto"
         width="auto"
         alt="Loading spinner"
         class="{{ size }} animate-spin" />
    <span class="sr-only">Loading...</span>
  </div>
{% endmacro spinner -%}
{# End small spinner -#}

{# Button spinner -#}
{% macro btn_spinner(id, size = "size-5", spinner_type = "1", htmx = true) -%}
  <div id="{{ id }}"
       class="absolute inset-0 bg-inherit {%- if htmx %} hx-spinner{%- endif -%}">
    <div class="flex items-center justify-center h-full w-full">
      {% call spinner(size = size, spinner_type = spinner_type) -%}
    </div>
  </div>
{% endmacro btn_spinner -%}
{# End button spinner -#}

{# Main loading -#}
{% macro main_loading() -%}
  <div class="w-20 h-20 text-stone-200 animate-spin">
    <img src="/static/images/icons/main_loading.svg"
         height="20"
         width="20"
         alt="Loading icon"
         class="w-full h-full object-contain" />
  </div>
{% endmacro main_loading -%}
{# End main loading -#}

{# Icon text -#}
{% macro icon_text(icon_name, text, extra_styles = None) -%}
  {% let extra_styles_ = extra_styles.unwrap_or("") -%}

  <div class="icon-text {{ extra_styles_ }}">
    <div class="svg-icon w-3 h-3 mr-2 bg-stone-700 icon-{{ icon_name }}"></div>
    <span>{{ text }}</span>
  </div>
{% endmacro icon_text -%}
{# End icon text -#}

{# Event badge -#}
{% macro event_badge(kind, canceled = false, extra_styles = None) -%}
  {% let extra_styles_ = extra_styles.unwrap_or("") -%}

  {% if canceled -%}
    <span class="event-badge canceled {{ extra_styles_ }}">Canceled</span>
  {% else -%}
    {% call badge(content = kind, extra_styles = extra_styles) -%}
  {% endif -%}
{% endmacro event_badge -%}
{# End event badge -#}

{# Status badge -#}
{% macro status_badge(label, canceled = false, published = false, extra_styles = None) -%}
  {% let extra_styles_ = extra_styles.unwrap_or("") -%}

  {% if canceled -%}
    <span class="event-badge bg-red-100 border-red-800 text-red-800 px-2.5 py-0.5 {{ extra_styles_ }}">{{ label }}</span>
  {% else if published -%}
    <span class="event-badge bg-green-100 border-green-800 text-green-800 px-2.5 py-0.5 {{ extra_styles_ }}">{{ label }}</span>
  {% else -%}
    <span class="event-badge bg-amber-100 border-amber-800 text-amber-800 px-2.5 py-0.5 {{ extra_styles_ }}">{{ label }}</span>
  {% endif -%}
{% endmacro status_badge -%}
{# End status badge -#}

{# Common badge -#}
{% macro badge(content, extra_styles = None) -%}
  {% let extra_styles_ = extra_styles.unwrap_or("") -%}

  <span class="event-badge {{ extra_styles_ }}">{{ content }}</span>
{% endmacro badge -%}
{# End common badge -#}

{# Social network link -#}
{% macro social_link(url, icon_name, platform_name) -%}
  <a href="{{ url }}"
     target="_blank"
     rel="noopener noreferrer"
     class="group btn-secondary-anchor p-1.5 h-[30px] w-[30px] flex items-center justify-center"
     title="{{ platform_name }}">
    <div class="svg-icon size-4 bg-primary-500 group-hover:bg-white transition-colors icon-{{ icon_name }}">
    </div>
  </a>
{% endmacro social_link -%}
{# End social network link -#}

{# Alerts #}
{# djlint:off #}
{% macro alerts(messages) -%}
  <script type="module">
    import { showErrorAlert, showSuccessAlert } from '/static/js/common/alerts.js';

    {% for message in messages -%}
      {% match message.level -%}
        {% when Level::Success -%}
          showSuccessAlert('{{ message }}');
        {% when Level::Error -%}
          showErrorAlert('{{ message }}');
        {% when _ -%}
          {# Do nothing #}
      {% endmatch -%}
    {% endfor -%}
</script>
{% endmacro alerts -%}
{# djlint:on #}
{# End alerts #}

{# Sponsor badge -#}
{% macro sponsor_badge(name, logo_url, website_url, level = "", with_level = false) -%}
  {% if let Some(website_url) = website_url -%}
    <a href="{{ website_url }}"
       target="_blank"
       rel="noopener noreferrer"
       class="inline-flex items-center gap-3 rounded-xl border border-stone-200 bg-white p-4 w-full focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500">
      <div class="relative flex items-center justify-center size-18 shrink-0 rounded-lg bg-white border border-stone-200 overflow-hidden">
        <img src="{{ logo_url }}"
             alt="{{ name }} logo"
             class="size-16 object-contain"
             width="auto"
             height="auto"
             loading="lazy" />
        <div class="fallback-icon hidden absolute inset-0 flex items-center justify-center">
          <div class="svg-icon size-6 bg-amber-500 icon-handshake"></div>
        </div>
      </div>
      <div class="leading-tight min-w-0">
        <div class="text-sm md:text-base font-semibold text-stone-900 truncate">{{ name }}</div>
        {% if with_level -%}
          <div class="text-xs uppercase tracking-wide text-stone-600 truncate mt-1.5">{{ level }}</div>
        {% endif -%}
      </div>
    </a>
  {% else -%}
    <div class="inline-flex items-center gap-3 rounded-xl border border-stone-200 bg-stone-50 px-4 py-3 min-w-[200px]">
      <div class="relative flex items-center justify-center h-9 w-9 shrink-0 rounded-full bg-white border border-stone-200 overflow-hidden">
        <img src="{{ logo_url }}"
             alt="{{ name }} logo"
             class="h-6 w-6 object-contain"
             width="auto"
             height="auto"
             loading="lazy" />
        <div class="fallback-icon hidden absolute inset-0 flex items-center justify-center">
          <div class="svg-icon size-5 bg-amber-500 icon-handshake"></div>
        </div>
      </div>
      <div class="leading-tight min-w-0">
        <div class="text-sm md:text-base font-semibold text-stone-900">{{ name }}</div>
        {% if with_level -%}
          <div class="text-xs uppercase tracking-wide text-stone-600">{{ level }}</div>
        {% endif -%}
      </div>
    </div>
  {% endif -%}
{% endmacro sponsor_badge -%}
{# End sponsor badge -#}

{# djlint:off #}
{# Map with modal -#}
{% macro map_with_modal(base_id, lat, lng, overlay_text = "", small_overlay_text = "", modal_title = "") -%}
  <div id="{{ base_id }}-map"
        class="w-full h-full min-h-25 cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary-500"
        role="button"
        tabindex="0"
        aria-label="Open full map view"></div>
  {% if let Some(text) = overlay_text -%}
    <div class="absolute bottom-2 left-2 bg-white/80 text-stone-700 text-xs rounded-full px-3 py-1 z-1000 pointer-events-none hidden sm:block md:hidden xl:block">
      {{ text }}
    </div>
  {% endif -%}
  {% if let Some(text) = small_overlay_text -%}
    <div class="absolute bottom-2 left-2 bg-white/80 text-stone-700 text-xs rounded-full px-3 py-1 z-1000 pointer-events-none block sm:hidden md:block xl:hidden">
      {{ text }}
    </div>
  {% endif -%}

  <div id="{{ base_id }}-map-modal"
       tabindex="-1"
       aria-hidden="true"
       aria-modal="true"
       role="dialog"
       class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-[1200] justify-center items-center w-full md:inset-0 h-full max-h-full flex">
    <div id="backdrop-{{ base_id }}-map-modal"
         class="modal-overlay absolute w-full h-full bg-stone-950 opacity-[.35]"></div>
    <div class="relative p-4 w-full max-w-4xl max-h-full">
      <div class="relative bg-white rounded-lg shadow">
        <div class="flex items-center justify-between p-4 md:p-5 border-b border-stone-200 rounded-t">
          <h3 id="{{ base_id }}-map-modal-title"
              class="text-xl font-semibold text-stone-900">{{ modal_title }} location</h3>
          <button id="close-{{ base_id }}-map-modal"
                  type="button"
                  class="group bg-transparent hover:bg-stone-200 transition-colors rounded-full text-sm size-8 ms-auto inline-flex justify-center items-center">
            <div class="svg-icon h-5 w-5 bg-stone-400 group-hover:bg-stone-900 transition-colors icon-close"></div>
            <span class="sr-only">Close modal</span>
          </button>
        </div>
        <div class="p-4 md:p-6">
          <div class="relative">
            <div id="{{ base_id }}-map-modal-map"
                 class="w-full h-[500px] md:h-[600px] rounded-lg overflow-hidden border border-stone-200">
            </div>
            {% if let Some(text) = overlay_text -%}
              <div class="absolute bottom-2 left-2 bg-white/80 text-stone-700 text-xs rounded-full px-3 py-1 z-1000 pointer-events-none hidden sm:block md:hidden xl:block">
                {{ text }}
              </div>
            {% endif -%}
            {% if let Some(text) = small_overlay_text -%}
              <div class="absolute bottom-2 left-2 bg-white/80 text-stone-700 text-xs rounded-full px-3 py-1 z-1000 pointer-events-none md:block xl:hidden">
                {{ text }}
              </div>
            {% endif -%}
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import {
      loadMap,
      toggleModalVisibility
    } from "/static/js/common/common.js";

    const mapContainer = document.getElementById('{{ base_id }}-map');
    const modalId = '{{ base_id }}-map-modal';
    const modalMapId = '{{ base_id }}-map-modal-map';
    const closeButtonId = 'close-{{ base_id }}-map-modal';
    const backdropId = 'backdrop-{{ base_id }}-map-modal';
    let modalMapLoaded = false;

    const ensureModalMap = () => {
      if (modalMapLoaded) {
        return;
      }
      modalMapLoaded = true;
      requestAnimationFrame(() => {
        loadMap(modalMapId, {{ lat }}, {{ lng }});
      });
    };

    const openModal = () => {
      toggleModalVisibility(modalId);
      ensureModalMap();
    };

    loadMap('{{ base_id }}-map', {{ lat }}, {{ lng }}, {
      interactive: false
    });

    if (mapContainer) {
      mapContainer.addEventListener('click', openModal);
      mapContainer.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          openModal();
        }
      });
    }

    const closeButton = document.getElementById(closeButtonId);
    if (closeButton) {
      closeButton.addEventListener('click', () => toggleModalVisibility(modalId));
    }

    const backdrop = document.getElementById(backdropId);
    if (backdrop) {
      backdrop.addEventListener('click', () => toggleModalVisibility(modalId));
    }
</script>
{% endmacro map_with_modal -%}
{# End map with modal -#}
{# djlint:on #}
