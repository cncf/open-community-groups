{# Membership button section -#}
<div class="mb-6" id="membership-container">

  <!-- Loading spinner (shown initially) -->
  <button id="loading-btn"
          disabled
          class="group is-loading btn-primary w-full opacity-50 cursor-not-allowed flex items-center justify-center">
    {% import "common.html" as common -%}
    {% call common::small_spinner(size = "size-4") -%}
    <span class="ms-2">Checking...</span>
  </button>

  <!-- Sign in prompt (hidden initially) -->
  <a id="signin-btn"
     href="/log-in?next_url={{ path|urlencode }}"
     hx-boost="true"
     class="hidden btn-primary-anchor w-full text-center">Sign in to Join</a>

  <!-- Join button (hidden initially) -->
  <button id="join-btn"
          hx-post="/group/{{ group.group_id }}/join"
          hx-swap="none"
          class="hidden btn-primary w-full">Join Group</button>

  <!-- Leave button (hidden initially) -->
  <button id="leave-btn"
          hx-delete="/group/{{ group.group_id }}/leave"
          hx-trigger="confirmed"
          hx-swap="none"
          class="hidden btn-secondary w-full">Leave Group</button>

  <!-- Hidden element that checks membership status -->
  <div id="membership-checker"
       hx-get="/group/{{ group.group_id }}/membership"
       hx-trigger="load, membership-changed from:body"
       hx-swap="none"></div>
</div>

<script type="module">
  import {
    showConfirmAlert,
    showErrorAlert,
    showSuccessAlert,
  } from '/static/js/common/alerts.js';
  import { isSuccessfulXHRStatus } from '/static/js/common/common.js';

  const membershipHandler = document.getElementById('membership-checker');

  // Handle membership check response
  membershipHandler.addEventListener('htmx:afterRequest', (evt) => {
    const loadingBtn = document.getElementById('loading-btn');
    const signinBtn = document.getElementById('signin-btn');
    const joinBtn = document.getElementById('join-btn');
    const leaveBtn = document.getElementById('leave-btn');

    // Ensure all buttons exist
    if (!loadingBtn || !signinBtn || !joinBtn || !leaveBtn) {
      return;
    }

    // Hide all buttons first
    loadingBtn.classList.add('hidden');
    signinBtn.classList.add('hidden');
    joinBtn.classList.add('hidden');
    leaveBtn.classList.add('hidden');

    if (isSuccessfulXHRStatus(evt.detail.xhr.status)) {
      // User is authenticated, parse response
      try {
        const response = JSON.parse(evt.detail.xhr.responseText);

        if (response.is_member) {
          leaveBtn.classList.remove('hidden');
        } else {
          joinBtn.classList.remove('hidden');
        }
      } catch (error) {
        signinBtn.classList.remove('hidden');
      }
    } else {
      // User not authenticated or error
      signinBtn.classList.remove('hidden');
    }
  });

  // Handle join button
  document.getElementById('join-btn').addEventListener('htmx:beforeRequest', function () {
    this.classList.add('hidden');
    document.getElementById('loading-btn').classList.remove('hidden');
  });

  document.getElementById('join-btn').addEventListener('htmx:afterRequest', (evt) => {
    if (isSuccessfulXHRStatus(evt.detail.xhr.status)) {
      showSuccessAlert('You have successfully joined this group.');
      // Fire custom event to trigger membership check
      document.body.dispatchEvent(new Event('membership-changed'));
    } else {
      showErrorAlert('Something went wrong joining this group. Please try again later.');
      // Restore buttons state
      document.getElementById('loading-btn').classList.add('hidden');
      document.getElementById('join-btn').classList.remove('hidden');
    }
  });

  // Handle leave button
  document.getElementById('leave-btn').addEventListener('htmx:beforeRequest', function () {
    this.classList.add('hidden');
    document.getElementById('loading-btn').classList.remove('hidden');
  });

  document.getElementById('leave-btn').addEventListener('htmx:afterRequest', (evt) => {
    if (isSuccessfulXHRStatus(evt.detail.xhr.status)) {
      showSuccessAlert('You have successfully left this group.');
      // Fire custom event to trigger membership check
      document.body.dispatchEvent(new Event('membership-changed'));
    } else {
      showErrorAlert('Something went wrong leaving this group. Please try again later.');
      // Restore buttons state
      document.getElementById('loading-btn').classList.add('hidden');
      document.getElementById('leave-btn').classList.remove('hidden');
    }
  });

  // Ask for confirmation before leaving the group
  const leaveBtnEl = document.getElementById('leave-btn');
  if (leaveBtnEl) {
    leaveBtnEl.addEventListener('click', () => {
      showConfirmAlert('Are you sure you want to leave this group?', 'leave-btn', 'Yes');
    });
  }
</script>
