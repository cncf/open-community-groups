{% import "common.html" as common -%}
{% extends "group/base.html" -%}

{% block content -%}
  {# Scripts -#}
  <script type="text/javascript" src="/static/vendor/js/leaflet.v1.9.4.min.js"></script>
  <script type="text/javascript"
          src="/static/vendor/js/leaflet.markercluster.v1.5.3.min.js"></script>
  {# End scripts -#}

  <div class="max-w-7xl bg-white border border-stone-200 rounded-lg mx-4 lg:mx-5 xl:mx-auto my-5 md:my-7">
    {# Group header with name and region -#}
    <div>
      <div class="px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex flex-1 flex-row items-stretch gap-6">
          {# Group logo -#}
          {% call common::logo(logo_url = group.logo_url, classes = "h-20 w-20 md:h-28 md:w-28", size = 112, color = group.color, name = Some(group.name)) -%}
          {# End group logo -#}

          <div class="flex-1 flex flex-col justify-between">
            <div>
              {# Region/Category legend -#}
              <div>
                <span class="text-sm font-semibold tracking-wide uppercase text-stone-400">
                  {% if let Some(region_name) = group.region_name -%}
                    {{ region_name }}
                  {% else -%}
                    {{ group.category_name }}
                  {% endif -%}
                </span>
              </div>
              {# End region/category legend -#}

              {# Group name -#}
              <h1 class="text-3xl md:text-4xl font-semibold text-stone-900 line-clamp-2">{{ group.name|demoji }}</h1>
              {# End group name -#}
            </div>

            {# Members count and founded date -#}
            <div class="flex items-center gap-4 text-stone-600">
              <div class="flex items-center">
                <div class="svg-icon size-4 mr-2 bg-stone-600 icon-people"></div>
                <span class="text-sm">{{ group.members_count }} members</span>
              </div>
              <div class="flex items-center">
                <div class="svg-icon size-4 mr-2 bg-stone-600 icon-date"></div>
                <span class="text-sm">Founded {{ group.created_at.format("%B %Y") }}</span>
              </div>
            </div>
            {# End members count and founded date -#}
          </div>

          {# Social networks -#}
          {% let has_social_links = group.website_url.is_some() || group.twitter_url.is_some() || group.facebook_url.is_some() || group.linkedin_url.is_some() || group.github_url.is_some() || group.instagram_url.is_some() || group.youtube_url.is_some() || group.slack_url.is_some() || group.wechat_url.is_some() || group.flickr_url.is_some() || group.extra_links.is_some() -%}
          {% if has_social_links -%}
            <div class="flex flex-col items-end gap-2">
              <div class="flex flex-wrap gap-2">
                {% if let Some(website_url) = group.website_url -%}
                  {% call common::social_link(url = website_url, icon_name = "website", platform_name = "Website") -%}
                {% endif -%}
                {% if let Some(twitter_url) = group.twitter_url -%}
                  {% call common::social_link(url = twitter_url, icon_name = "twitter", platform_name = "Twitter") -%}
                {% endif -%}
                {% if let Some(facebook_url) = group.facebook_url -%}
                  {% call common::social_link(url = facebook_url, icon_name = "facebook", platform_name = "Facebook") -%}
                {% endif -%}
                {% if let Some(linkedin_url) = group.linkedin_url -%}
                  {% call common::social_link(url = linkedin_url, icon_name = "linkedin", platform_name = "LinkedIn") -%}
                {% endif -%}
                {% if let Some(github_url) = group.github_url -%}
                  {% call common::social_link(url = github_url, icon_name = "github", platform_name = "GitHub") -%}
                {% endif -%}
                {% if let Some(instagram_url) = group.instagram_url -%}
                  {% call common::social_link(url = instagram_url, icon_name = "instagram", platform_name = "Instagram") -%}
                {% endif -%}
                {% if let Some(youtube_url) = group.youtube_url -%}
                  {% call common::social_link(url = youtube_url, icon_name = "youtube", platform_name = "YouTube") -%}
                {% endif -%}
                {% if let Some(slack_url) = group.slack_url -%}
                  {% call common::social_link(url = slack_url, icon_name = "slack", platform_name = "Slack") -%}
                {% endif -%}
                {% if let Some(wechat_url) = group.wechat_url -%}
                  {% call common::social_link(url = wechat_url, icon_name = "wechat", platform_name = "WeChat") -%}
                {% endif -%}
                {% if let Some(flickr_url) = group.flickr_url -%}
                  {% call common::social_link(url = flickr_url, icon_name = "flickr", platform_name = "Flickr") -%}
                {% endif -%}
                {% if let Some(extra_links) = group.extra_links -%}
                  {% for (name, url) in extra_links -%}
                    <a href="{{ url }}"
                       target="_blank"
                       rel="noopener noreferrer"
                       class="group btn-secondary-anchor p-1.5 h-[30px] w-[30px] flex items-center justify-center"
                       title="{{ name }}">
                      <div class="svg-icon size-4 bg-primary-500 group-hover:bg-white icon-link"></div>
                    </a>
                  {% endfor -%}
                {% endif -%}
              </div>
            </div>
          {% endif -%}
          {# End social networks -#}
        </div>
      </div>
    </div>
    {# End group header -#}

    {# Two column layout -#}
    <div class="px-4 sm:px-6 lg:px-8 py-8">
      <div class="grid grid-cols-1 lg:grid-cols-10 gap-10">
        {# Left column (70%) -#}
        <div class="lg:col-span-7">
          {# Group banner -#}
          {% if let Some(banner_url) = group.banner_url -%}
            <div class="w-full mb-8">
              <div>
                <img src="{{ banner_url }}"
                     alt="Group banner"
                     class="w-full h-auto max-h-64 lg:max-h-80 object-contain rounded-lg mx-auto"
                     width="auto"
                     height="auto" />
              </div>
            </div>
          {% endif -%}
          {# End group banner -#}

          {# Group description -#}
          {% if let Some(description) = group.description -%}
            <div>
              <div class="pb-8">
                <h2 class="text-2xl font-semibold text-stone-900 mb-6">About this group</h2>
                <div class="prose prose-stone max-w-none">
                  <div class="text-stone-700 text-base/6 markdown">{{ description|demoji|safe }}</div>
                </div>
              </div>
            </div>
          {% endif -%}
          {# End group description -#}
        </div>
        {# End left column -#}

        {# Right column (30%) -#}
        <div class="lg:col-span-3">
          {# Location and map section -#}
          {% if group.latitude.is_some() && group.longitude.is_some() -%}
            <h2 class="text-lg uppercase font-semibold text-stone-500 mb-4">Location</h2>
            <div class="border border-stone-200 rounded-lg mb-6 overflow-hidden">
              <div class="grid grid-cols-1 md:grid-cols-2">
                {# Location details -#}
                <div class="space-y-3">
                  <div class="flex items-start p-3">
                    <div class="svg-icon size-3 mr-2 mt-[0.175rem] bg-stone-600 icon-location shrink-0"></div>
                    <div class="space-y-1">
                      {% if let Some(city) = group.city -%}
                        <div class="text-sm font-medium text-stone-900">{{ city }}</div>
                      {% endif -%}
                      {% if let Some(state) = group.state -%}
                        <div class="text-xs text-stone-700">{{ state }}</div>
                      {% endif -%}
                      {% if let Some(country_name) = group.country_name -%}
                        <div class="text-xs text-stone-700">{{ country_name }}</div>
                      {% endif -%}
                    </div>
                  </div>
                </div>
                {# End location details -#}

                {# Map -#}
                <div class="h-full overflow-hidden border-l border-stone-200">
                  <div id="group-map"
                       class="w-full h-full"
                       data-lat="{{ group.latitude.unwrap() }}"
                       data-lng="{{ group.longitude.unwrap() }}"
                       data-name="{{ group.name|demoji }}"></div>
                </div>
                {# End map -#}
              </div>
            </div>

            {# Map initialization script -#}
            <script type="module">
              import {
                loadMap
              } from "/static/js/common/common.js";

              // Initialize the map with group coordinates
              const mapElement = document.getElementById('group-map');
              if (mapElement) {
                const lat = parseFloat(mapElement.dataset.lat);
                const lng = parseFloat(mapElement.dataset.lng);
                const name = mapElement.dataset.name;

                loadMap('group-map', name, lat, lng);
              }
            </script>
            {# End map initialization script -#}
          {% endif -%}
          {# End location and map section -#}

          {# Organizers section -#}
          <div>
            {% if !group.organizers.is_empty() -%}
              <h2 class="text-lg uppercase font-semibold text-stone-500 mb-4 mt-8">Organizers</h2>
              <div class="border border-stone-200 rounded-lg divide-y divide-stone-200">
                {% for organizer in group.organizers -%}
                  <div class="flex items-center gap-3 p-3">
                    {# Avatar -#}
                    {% if let Some(photo_url) = organizer.photo_url -%}
                      <img src="{{ photo_url }}"
                           alt="Organizer photo"
                           class="size-10 rounded-full object-cover flex-shrink-0 border-2 border-gray-400"
                           width="40"
                           height="40" />
                    {% else -%}
                      <div class="size-10 rounded-full bg-stone-200 flex items-center justify-center flex-shrink-0 border-2 border-gray-400">
                        <span class="text-stone-600 font-semibold text-sm">
                          {% if let Some(first_name) = organizer.first_name -%}
                            {{ first_name.chars().next().unwrap_or('?').to_uppercase() }}
                          {% else if let Some(last_name) = organizer.last_name -%}
                            {{ last_name.chars().next().unwrap_or('?').to_uppercase() }}
                          {% else -%}
                            -
                          {% endif -%}
                        </span>
                      </div>
                    {% endif -%}
                    {# End avatar -#}

                    {# Name and position -#}
                    <div class="flex-1 min-w-0">
                      <h3 class="text-sm font-semibold text-stone-900 truncate">
                        {% if let Some(first_name) = organizer.first_name -%}
                          {% if let Some(last_name) = organizer.last_name -%}
                            {{ first_name }} {{ last_name }}
                          {% else -%}
                            {{ first_name }}
                          {% endif -%}
                        {% else if let Some(last_name) = organizer.last_name -%}
                          {{ last_name }}
                        {% else -%}
                          Organizer
                        {% endif -%}
                      </h3>
                      {% if let Some(title) = organizer.title -%}
                        <p class="text-xs text-stone-600 mt-1 truncate">{{ title }}</p>
                      {% endif -%}
                    </div>
                    {# End name and position -#}
                  </div>
                {% endfor -%}
              </div>
            {% endif -%}
          </div>
          {# End organizers section -#}

          {# Tags if available -#}
          {% if let Some(tags) = group.tags -%}
            {% if !tags.is_empty() -%}
              <div class="mt-8">
                <h3 class="text-lg font-semibold text-stone-900 mb-4">Topics</h3>
                <div class="flex flex-wrap gap-2">
                  {% for tag in tags -%}
                    <span class="inline-block px-3 py-1 bg-stone-50 text-stone-700 text-sm rounded-full uppercase">{{ tag }}</span>
                  {% endfor -%}
                </div>
              </div>
            {% endif -%}
          {% endif -%}
          {# End tags -#}
        </div>
        {# End right column -#}
      </div>
    </div>
    {# End two column layout -#}

    {# Next events section -#}
    {# TODO - create a big card for upcoming events -#}
    {% if !upcoming_events.is_empty() -%}
      <div>
        <div class="px-4 sm:px-6 lg:px-8 py-8">
          <h2 class="text-2xl font-semibold text-stone-900 mb-6">Upcoming Events</h2>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {% for event in upcoming_events -%}
              {{ event|safe }}
            {% endfor -%}
          </div>
        </div>
      </div>
    {% endif -%}
    {# End next events section -#}

    {# Past events section -#}
    {% if !past_events.is_empty() -%}
      <div>
        <div class="px-4 sm:px-6 lg:px-8 py-8">
          <h2 class="text-2xl font-semibold text-stone-900 mb-6">Past Events</h2>
          <div class="grid grid-cols-1 gap-6 md:gap-10 md:grid-cols-2 xl:grid-cols-3">
            {% for event in past_events -%}
              <div class="flex flex-col rounded-lg p-4 border border-stone-200 hover:bg-stone-50 bg-white">
                {{ event|safe }}
              </div>
            {% endfor -%}
          </div>
        </div>
      </div>
    {% endif -%}
    {# End past events section -#}
  </div>
{% endblock content -%}
