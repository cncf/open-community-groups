{% import "common.html" as common -%}
{% extends "common/base.html" -%}

{% block scripts -%}
  <script type="module" src="/static/js/common/images-gallery.js"></script>
  <script type="module" src="/static/js/common/people-list.js"></script>
  <script type="module" src="/static/js/common/user-chip.js"></script>
  <script type="module" src="/static/js/common/banner-image.js"></script>
{% endblock scripts -%}

{% block content -%}
  {% let has_social_links = group.website_url.is_some() || group.twitter_url.is_some() || group.facebook_url.is_some() || group.linkedin_url.is_some() || group.github_url.is_some() || group.instagram_url.is_some() || group.youtube_url.is_some() || group.slack_url.is_some() || group.wechat_url.is_some() || group.flickr_url.is_some() || group.extra_links.is_some() -%}

  {# Community title -#}
  <div class="text-center pt-2 xl:pt-5">
    <h1 class="mb-2 xl:mb-6 mx-3 md:mx-5 text-[1.15rem] font-semibold tracking-tight leading-none md:text-2xl lg:text-4xl xl:text-5xl">
      {{ community.title }}
    </h1>
  </div>
  {# End community title -#}
  <div class="relative container mx-auto max-w-7xl p-4 pb-8 sm:p-6 lg:p-8 lg:pb-16 flex grow h-full">
    <div class="bg-white border border-stone-200 rounded-lg flex flex-col gap-y-8 py-8 w-full">
      {# Group header with name and region -#}
      <div class="px-4 sm:px-6 lg:px-8">
        {# Main flex container for logo, name/region, and social networks -#}
        <div class="flex flex-1 flex-row items-stretch gap-6">
          {# Group logo -#}
          {% call common::logo(logo_url = group.logo_url, classes = "hidden sm:block h-20 w-20 md:h-28 md:w-28", size = 112, color = group.color, name = Some(group.name)) -%}
          {# End group logo -#}

          <div class="flex-1 flex flex-col justify-between">
            <div class="flex-1 flex justify-between">
              <div class="flex flex-col justify-between">
                <div>
                  {# Region/Category legend -#}
                  <div>
                    <span class="text-sm font-semibold tracking-wide uppercase text-stone-400">
                      {% if let Some(region) = &group.region -%}
                        {{ region.name }}
                      {% else -%}
                        {{ group.category.name }}
                      {% endif -%}
                    </span>
                  </div>
                  {# End region/category legend -#}

                  {# Group name -#}
                  <h1 class="text-xl lg:text-[1.65rem]/[1.2] font-semibold text-stone-900 line-clamp-1 lg:line-clamp-2">
                    {{ group.name|demoji }}
                  </h1>
                  {# End group name -#}
                </div>
              </div>

              {# Social networks -#}
              {% if has_social_links -%}
                <div class="hidden md:flex flex-col items-end gap-2">
                  <div class="flex flex-wrap gap-2">{% include "group/social_networks.html" -%}</div>
                </div>
              {% endif -%}
              {# End social networks -#}
            </div>

            <div class="mt-auto flex items-center justify-between">
              {# Members count and founded date -#}
              <div class="flex items-center gap-4 text-stone-600">
                <div class="flex items-center">
                  <div class="svg-icon size-4 mr-2 bg-stone-600 icon-people"></div>
                  <span class="text-sm">{{ group.members_count }} members</span>
                </div>
                <div class="flex items-center">
                  <div class="svg-icon size-4 mr-2 bg-stone-600 icon-date"></div>
                  <span class="text-sm">{{ group.created_at.format("%B %Y") }}</span>
                </div>
              </div>
              {# End members count and founded date -#}

              <div class="hidden md:flex flex-col items-end">
                {# Membership button section -#}
                {% include "group/membership_button.html" %}
                {# End membership button section -#}
              </div>
            </div>
          </div>
        </div>
        {# End main flex container -#}

      </div>
      {# End group header -#}

      <div class="px-4 sm:px-6 lg:px-8">
        <div class="grid md:grid-cols-2 gap-4 md:gap-8">
          <div class="border border-stone-200 rounded-lg">
            <div class="p-4">
              <div class="text-base/3 uppercase font-semibold text-stone-400 mb-4">Next event</div>
              {% let next_event = upcoming_events.first() -%}

              <div class="rounded-lg border border-dashed border-stone-200 bg-white p-4 text-stone-400">
                {% if let Some(next_event_card) = next_event -%}
                  {% if let Some(starts_at) = next_event_card.event.starts_at -%}
                    <div class="flex items-start gap-2 text-lg/5 xl:text-xl/6 font-semibold text-stone-500">
                      <div class="svg-icon size-4 bg-stone-500 icon-date mt-0.5"></div>
                      <span>{{ starts_at.with_timezone(next_event_card.event.timezone).format("%B %e, %G Â· %I:%M %p %Z") }}</span>
                    </div>
                  {% endif -%}
                  <div class="mt-3 text-xl font-semibold text-stone-900 line-clamp-3">
                    {{ next_event_card.event.name|demoji }}
                  </div>
                  <div class="flex justify-end mt-4">
                    <a href="/group/{{ next_event_card.event.group_slug }}/event/{{ next_event_card.event.slug }}"
                       class="btn-secondary-anchor btn-mini ml-auto"
                       hx-boost="true"
                       hx-target="body">See details</a>
                  </div>
                {% else -%}
                  <div class="flex flex-col gap-3 relative">
                    <div class="h-3 w-3/5 rounded bg-stone-100"></div>
                    <div class="h-4 w-full rounded bg-stone-100"></div>
                    <div class="h-4 w-2/3 rounded bg-stone-100"></div>
                    <div class="flex justify-end mt-4">
                      <div class="h-3 w-1/5 rounded bg-stone-100"></div>
                    </div>

                    <div class="absolute inset-0 flex items-center justify-center">
                      <div class="text-base text-stone-600 bg-white/30 rounded-lg px-4 py-2">No upcoming events</div>
                    </div>
                  </div>
                {% endif -%}
              </div>
            </div>
          </div>

          {# Location and event section -#}
          <div class="border border-stone-200 rounded-lg flex flex-col">
            {# Location details -#}
            <div class="flex flex-col p-4 h-full">
              <div class="text-base/3 uppercase font-semibold text-stone-400 mb-4">Location</div>
              <div class="relative rounded-lg border border-dashed border-stone-200 bg-white overflow-hidden flex-grow min-h-25">
                {% let location_text = self.group.location(150) -%}
                {% if let Some(lat) = group.latitude %}
                  {% if let Some(lng) = group.longitude %}
                    {% call common::map_with_modal(base_id = "group", lat = lat, lng = lng, overlay_text = location_text, modal_title = group.name|demoji) -%}
                  {% else -%}
                    <div class="relative flex min-h-25 h-full w-full items-center justify-center p-4 text-center text-sm text-stone-500">
                      <div class="absolute inset-0 bg-[url('/static/images/map.png')] bg-cover bg-center bg-no-repeat opacity-30">
                      </div>
                      <div class="relative text-base text-stone-600">Location not provided</div>
                    </div>
                  {% endif -%}
                {% else -%}
                  <div class="relative flex min-h-25 h-full w-full items-center justify-center p-4 text-center text-sm text-stone-500">
                    <div class="absolute inset-0 bg-[url('/static/images/map.png')] bg-cover bg-center bg-no-repeat opacity-30">
                    </div>
                    <div class="relative text-base text-stone-600">Location not provided</div>
                  </div>
                {% endif -%}
              </div>
            </div>
            {# End location details -#}
          </div>

          {# End location and map section -#}
        </div>

        {# Group description -#}
        {% if let Some(description) = group.description -%}
          <div class="pt-2 pb-8">
            <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-10 pb-6">About this group</div>

            {# Group banner -#}
            {% if let Some(banner_url) = group.banner_url -%}
              <div class="max-w-1/2 mb-8 h-20 lg:h-40">
                <banner-image image-url="{{ banner_url }}" alt="Group banner"></banner-image>
              </div>
            {% endif -%}
            {# End group banner -#}

            <div class="text-stone-500 text-sm/6 markdown">{{ description|md_to_html|safe }}</div>
          </div>
        {% endif -%}
        {# End group description -#}

        {# Social networks (mobile only) -#}
        {% if has_social_links -%}
          <div class="md:hidden mb-8 md:mb-0">
            <div class="flex flex-wrap gap-2">{% include "group/social_networks.html" -%}</div>
          </div>
        {% endif -%}
        {# End social networks (mobile) -#}

        {# Next events section -#}
        {% if !upcoming_events.is_empty() -%}
          <div class="pt-2 pb-8">
            <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-10 pb-6">Upcoming Events</div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {% for event in upcoming_events -%}
                {% if loop.index <= 6 -%}
                  {{ event|safe }}
                {% endif -%}
              {% endfor -%}
            </div>
          </div>
        {% endif -%}
        {# End next events section -#}

        {# Past events section -#}
        {% if !past_events.is_empty() -%}
          <div class="pt-2 pb-8">
            <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-10 pb-6">Past Events</div>
            <div class="grid grid-cols-1 gap-6 md:gap-8 md:grid-cols-2 xl:grid-cols-3">
              {% for event in past_events -%}
                {% if loop.index <= 6 -%}
                  {{ event|safe }}
                {% endif -%}
              {% endfor -%}
            </div>
          </div>
        {% endif -%}
        {# End past events section -#}

        {# Organizers section - Full width -#}
        {% if !group.organizers.is_empty() -%}
          <div class="pt-2 pb-8">
            <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-10 pb-6">Organizers</div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {% for organizer in group.organizers -%}
                {% if organizer.name.is_some() -%}
                  <user-chip name="{{ organizer.name|display_some }}" username="{{ organizer.username }}" image-url="{{ organizer.photo_url|display_some }}" title="{{ organizer.title|display_some }}">
                  </user-chip>
                {% endif -%}
              {% endfor -%}
            </div>
          </div>
        {% endif -%}
        {# End organizers section -#}

        {# Sponsors section -#}
        {% if !group.sponsors.is_empty() -%}
          <div class="pt-2 pb-8">
            <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-10 pb-6">Sponsors</div>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
              {% for sponsor in group.sponsors -%}
                {% call common::sponsor_badge(name = sponsor.name, logo_url = sponsor.logo_url, website_url = sponsor.website_url) -%}
              {% endfor -%}
            </div>
          </div>
        {% endif -%}
        {# End sponsors section -#}

        {# Tags if available -#}
        {% if let Some(tags) = group.tags -%}
          {% if !tags.is_empty() -%}
            <div class="pt-2 pb-8">
              <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-10 pb-6">Topics</div>
              <div class="flex flex-wrap gap-2">
                {% for tag in tags -%}
                  <span class="inline-block px-3 py-1 bg-stone-50 text-stone-700 text-sm rounded-full uppercase">{{ tag }}</span>
                {% endfor -%}
              </div>
            </div>
          {% endif -%}
        {% endif -%}
        {# End tags -#}

        {# Photo gallery -#}
        {% if let Some(photos_urls) = group.photos_urls -%}
          {% if !photos_urls.is_empty() -%}
            <div class="pt-2 pb-8">
              <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-10 pb-6">Gallery</div>
              <images-gallery title="Gallery" altImage="Group {{ group.name }}" images="{{ photos_urls|json }}"></images-gallery>
            </div>
          {% endif -%}
        {% endif -%}
        {# End photo gallery -#}

      </div>

    </div>
  </div>
{% endblock content -%}
