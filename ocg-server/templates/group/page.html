{% extends "common/base.html" -%}
{% import "macros/ui.html" as ui -%}
{% import "macros/badges.html" as badges -%}
{% import "macros/maps.html" as maps -%}
{% import "macros/social.html" as social -%}

{% block scripts -%}
  <script type="module" src="/static/js/common/breadcrumb-nav.js"></script>
  <script type="module" src="/static/js/common/images-gallery.js"></script>
  <script type="module" src="/static/js/common/people-list.js"></script>
  <script type="module" src="/static/js/common/user-chip.js"></script>
  <script type="module" src="/static/js/common/user-info-modal.js"></script>
  <script type="module" src="/static/js/common/share-modal.js"></script>
{% endblock scripts -%}

{% block content -%}
  {% let has_social_links = group.website_url.is_some() || group.twitter_url.is_some() || group.facebook_url.is_some() || group.linkedin_url.is_some() || group.github_url.is_some() || group.instagram_url.is_some() || group.youtube_url.is_some() || group.slack_url.is_some() || group.wechat_url.is_some() || group.flickr_url.is_some() || group.extra_links.is_some() -%}

  {# Breadcrumb -#}
  <breadcrumb-nav banner-url="{{ group.banner_url.as_ref().unwrap_or(&group.community.banner_url) }}" banner-mobile-url="{{ group.banner_mobile_url.as_ref().unwrap_or(&group.community.banner_mobile_url) }}" items='[{"label": "Home", "href": "/", "icon": "home"}, {"label": {{ group.community.display_name|json }}, "href": "/{{ group.community.name }}", "icon": "community"}, {"label": {{ group.name|demoji|json }}, "icon": "groups", "current": true}]'></breadcrumb-nav>
  {# End breadcrumb -#}

  <div class="relative container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8 pb-8 md:pb-10 lg:pb-16 flex grow h-full">
    <div class="bg-white border border-stone-200 rounded-lg flex flex-col w-full">
      <div class="flex gap-y-6 sm:gap-y-8 lg:gap-y-12 flex-col px-4 sm:px-6 lg:px-10 py-4 sm:py-6 lg:py-10">
        {# Group header with name and region -#}
        <div>
          {# Main flex container for logo, name/region, and social networks -#}
          <div class="flex flex-1 flex-row items-stretch gap-6">
            {# Group logo -#}
            {{ ui::logo(logo_url = group.logo_url, classes = "hidden md:block size-24 md:size-28", size = 112) -}}
            {# End group logo -#}

            <div class="flex-1 flex flex-col justify-between">
              <div class="flex-1 flex justify-between">
                <div class="flex flex-col">
                  {# Region/Category legend -#}
                  <span class="text-sm font-semibold tracking-wide uppercase text-stone-400 lg:-mt-1 md:mb-0.5">
                    {% if let Some(region) = &group.region -%}
                      {{ region.name }}
                    {% else -%}
                      {{ group.category.name }}
                    {% endif -%}
                  </span>
                  {# End region/category legend -#}

                  {# Group name: use smaller font size for long titles (>68 chars) -#}
                  {% if group.name.len() > 68 -%}
                    <h1 class="text-[0.95rem]/5 xl:text-[1.45rem]/[1.35] font-semibold text-stone-900 line-clamp-2 mt-2 md:mt-1 xl:mt-0">
                      {{ group.name|demoji }}
                    </h1>
                  {% else -%}
                    <h1 class="text-[1.05rem]/6 xl:text-[1.65rem]/[1.2] font-semibold text-stone-900 line-clamp-2 mt-2 md:mt-1 xl:mt-0">
                      {{ group.name|demoji }}
                    </h1>
                  {% endif -%}
                  {# End group name -#}
                </div>

                {# Social networks -#}
                {% if has_social_links -%}
                  <div class="hidden md:flex flex-col items-end gap-2">
                    <div class="flex flex-wrap gap-2">{% include "group/social_networks.html" -%}</div>
                  </div>
                {% endif -%}
                {# End social networks -#}
              </div>

              <div class="mt-2 md:mt-auto flex flex-col md:flex-row md:items-end md:justify-between w-full">
                {# Members count and founded date -#}
                <div class="flex items-center gap-4 text-stone-600">
                  <div class="flex items-center">
                    <div class="svg-icon size-4 mr-2 bg-stone-600 icon-people"></div>
                    <span class="text-sm">{{ group.members_count }} members</span>
                  </div>
                  <div class="flex items-center">
                    <div class="svg-icon size-4 mr-2 bg-stone-600 icon-date"></div>
                    <span class="text-sm">{{ group.created_at.format("%B %Y") }}</span>
                  </div>
                </div>
                {# End members count and founded date -#}

                {# Social networks (mobile only) -#}
                {% if has_social_links -%}
                  <div class="md:hidden mt-4 md:mb-0">
                    <div class="flex flex-wrap gap-2">{% include "group/social_networks.html" -%}</div>
                  </div>
                {% endif -%}
                {# End social networks (mobile) -#}

                <div class="mt-4 md:mt-0 flex flex-row flex-wrap gap-4 items-end md:ml-auto">
                  {# Share button -#}
                  <share-modal title="{{ group.name }}" url="/{{ group.community.name }}/group/{{ group.slug }}">
                  </share-modal>
                  {# End share button -#}

                  {# Membership button section -#}
                  {% include "group/membership_button.html" %}
                  {# End membership button section -#}
                </div>
              </div>
            </div>
          </div>
          {# End main flex container -#}

        </div>
        {# End group header -#}

        {# Next event and location -#}
        <div class="py-4">
          <div class="grid md:grid-cols-2 gap-5 sm:gap-8 md:gap-5 lg:gap-8">
            {# Next event section -#}
            <div class="border border-stone-200 rounded-lg flex flex-col bg-white">
              <div class="flex flex-col p-4 h-full">
                {% let next_event = upcoming_events.first() -%}
                <div class="flex items-center justify-between mb-4 min-h-[25px]">
                  <div class="text-base/3 uppercase font-semibold text-stone-400">Next event</div>
                  {% if let Some(next_event_card) = &next_event -%}
                    <a href="/{{ group.community.name }}/group/{{ next_event_card.event.group_slug }}/event/{{ next_event_card.event.slug }}"
                       class="btn-secondary-anchor btn-mini"
                       hx-boost="true"
                       hx-target="body">See details</a>
                  {% endif -%}
                </div>

                <div class="rounded-lg border border-dashed border-stone-200 bg-white p-4 text-stone-400 min-h-[108px] grow">
                  {% if let Some(next_event_card) = &next_event -%}
                    {% if let Some(starts_at) = &next_event_card.event.starts_at -%}
                      <div>
                        {% let start_tz = starts_at.with_timezone(next_event_card.event.timezone) -%}
                        {% match &next_event_card.event.ends_at -%}
                        {% when Some with (ends_at) -%}
                        {% let end_tz = ends_at.with_timezone(next_event_card.event.timezone) -%}
                        {% if start_tz.date_naive() != end_tz.date_naive() -%}
                          {# Multi-day event: FROM → TO layout #}
                          <div class="flex items-start gap-8">
                            <div>
                              <div class="text-xs uppercase font-medium mb-0.5">From</div>
                              <div class="text-lg sm:text-xl xl:text-2xl font-semibold text-stone-800">
                                {{ start_tz.format("%b %e, %G") }}
                              </div>
                              <div class="mt-1 text-sm text-stone-600">{{ start_tz.format("%I:%M %p") }}</div>
                            </div>
                            <div class="text-stone-400 mt-6 xl:mt-7">→</div>
                            <div>
                              <div class="text-xs uppercase font-medium mb-0.5">To</div>
                              <div class="text-lg sm:text-xl xl:text-2xl font-semibold text-stone-800">
                                {{ end_tz.format("%b %e, %G") }}
                              </div>
                              <div class="mt-1 text-sm text-stone-600">{{ end_tz.format("%I:%M %p") }}</div>
                            </div>
                          </div>
                        {% else -%}
                          {# Single-day event with end time: show time range #}
                          <div class="text-lg sm:text-xl xl:text-3xl font-semibold text-stone-800">
                            {{ start_tz.format("%B %e, %G") }}
                          </div>
                          <div class="mt-2 text-base text-stone-600">
                            {{ start_tz.format("%I:%M %p") }} - {{ end_tz.format("%I:%M %p %Z") }}
                          </div>
                        {% endif -%}
                        {% when None -%}
                        {# Single-day event without end time #}
                        <div class="text-lg sm:text-xl xl:text-3xl font-semibold text-stone-800">
                          {{ start_tz.format("%B %e, %G") }}
                        </div>
                        <div class="mt-2 text-base text-stone-600">{{ start_tz.format("%I:%M %p %Z") }}</div>
                      {% endmatch -%}
                    </div>
                  {% else -%}
                    <div class="text-xl xl:text-3xl font-semibold text-stone-800 truncate">
                      {{ next_event_card.event.name|demoji }}
                    </div>
                  {% endif -%}

                {% else -%}
                  <div class="flex flex-col gap-3 relative">
                    <div class="h-4 w-3/5 rounded bg-stone-100"></div>
                    <div class="h-2 w-1/2 rounded bg-stone-100"></div>
                    <div class="flex justify-end mt-2">
                      <div class="h-3 w-1/5 rounded bg-stone-100"></div>
                    </div>

                    <div class="absolute inset-0 flex items-center justify-center">
                      <div class="text-xl font-semibold text-stone-700 text-center">No upcoming events scheduled</div>
                    </div>
                  </div>
                {% endif -%}
              </div>
            </div>
          </div>

          {# Location and event section -#}
          <div class="border border-stone-200 rounded-lg flex flex-col bg-white">
            {# Location details -#}
            <div class="flex flex-col p-4 h-full">
              <div class="flex items-center justify-between mb-4 min-h-[25px]">
                <div class="text-base/3 uppercase font-semibold text-stone-400">Location</div>
              </div>
              <div class="relative rounded-lg border border-dashed border-stone-200 bg-white overflow-hidden grow min-h-[108px]">
                {% if let Some(lat) = &group.latitude %}
                  {% if let Some(lng) = &group.longitude %}
                    {% let location_text = self.group.location(70) -%}
                    {% let location_text_small = self.group.location(35) -%}
                    {{ maps::map_with_modal(base_id = "group", lat = lat, lng = lng, overlay_text = location_text, small_overlay_text = location_text_small, modal_title = group.name|demoji) -}}
                  {% else -%}
                    <div class="relative flex h-full w-full items-center justify-center p-4 text-center text-sm text-stone-500">
                      <div class="absolute inset-0 bg-[url('/static/images/map.png')] bg-cover bg-center bg-no-repeat opacity-30">
                      </div>
                      <div class="relative flex w-full items-center justify-center">
                        <div class="text-xl font-semibold text-stone-700">Location not provided</div>
                      </div>
                    </div>
                  {% endif -%}
                {% else -%}
                  <div class="relative flex h-full w-full items-center justify-center p-4 text-center text-sm text-stone-500">
                    <div class="absolute inset-0 bg-[url('/static/images/map.png')] bg-cover bg-center bg-no-repeat opacity-30">
                    </div>
                    <div class="relative flex w-full items-center justify-center">
                      <div class="text-xl font-semibold text-stone-700">Location not provided</div>
                    </div>
                  </div>
                {% endif -%}
              </div>
            </div>
            {# End location details -#}
          </div>

          {# End location and map section -#}
        </div>
      </div>
      {# End next event and location -#}

      {# Group description -#}
      {% if let Some(description) = &group.description -%}
        <div>
          <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-6 pb-6 lg:pt-2 lg:pb-14">
            About this group
          </div>
          <div class="text-stone-500 text-sm/6 markdown">{{ description|md_to_html|safe }}</div>
        </div>
      {% endif -%}
      {# End group description -#}

      {# Tags if available -#}
      {% if let Some(tags) = &group.tags -%}
        {% if !tags.is_empty() -%}
          <div>
            <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-10 pb-8 lg:pt-2 lg:pb-14">
              Tags
            </div>
            <div class="flex flex-wrap gap-2">
              {% for tag in tags -%}
                <span class="inline-block px-3 py-1 bg-stone-50 text-stone-700 text-sm rounded-full uppercase">{{ tag }}</span>
              {% endfor -%}
            </div>
          </div>
        {% endif -%}
      {% endif -%}
      {# End tags -#}

      {# Next events section -#}
      {% if !upcoming_events.is_empty() -%}
        {% let upcoming_events_link = "/explore?entity=events&group[0]=".to_owned() + &group.slug + "&community[0]=" + &group.community.name -%}
        <div>
          <div class="flex items-center justify-between pb-8 lg:pb-12">
            <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-10 lg:py-2">Upcoming Events</div>
            {# See all events on desktop -#}
            <div class="hidden justify-self-end md:flex">
              <a href="{{ upcoming_events_link }}"
                 hx-boost="true"
                 hx-target="body"
                 class="btn-secondary-anchor ms-4">See all events</a>
            </div>
            {# End see all events on desktop -#}
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">
            {% for event in upcoming_events -%}
              {% if loop.index0 < 6 -%}
                {{ event|safe }}
              {% endif -%}
            {% endfor -%}
          </div>
          {# See all events on mobile -#}
          <div class="flex mt-9 justify-self-center md:hidden md:mt-0">
            <a href="{{ upcoming_events_link }}"
               hx-boost="true"
               hx-target="body"
               class="btn-secondary-anchor">See all events</a>
          </div>
          {# End see all events on mobile -#}
        </div>
      {% endif -%}
      {# End next events section -#}

      {# Past events section -#}
      {% if !past_events.is_empty() -%}
        {% let past_events_date_option = Some(chrono::Utc::now() - chrono::Duration::days(1)) -%}
        {% let past_events_date_to = past_events_date_option|display_some_datetime_tz("%Y-%m-%d", chrono_tz::UTC) -%}
        {% let past_events_link = "/explore?entity=events&group[0]=".to_owned() + &group.slug + "&community[0]=" + &group.community.name + "&date_from=1900-01-01&sort_direction=desc" + "&date_to=" + &past_events_date_to -%}
        <div>
          <div class="flex items-center justify-between pb-8 lg:pb-12">
            <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-10 lg:py-2">Past Events</div>
            {# See all events on desktop -#}
            <div class="hidden justify-self-end md:flex">
              <a href="{{ past_events_link }}"
                 hx-boost="true"
                 hx-target="body"
                 class="btn-secondary-anchor ms-4">See all events</a>
            </div>
            {# End see all events on desktop -#}
          </div>
          <div class="grid grid-cols-1 gap-6 md:gap-8 md:grid-cols-2">
            {% for event in past_events -%}
              {% if loop.index0 < 6 -%}
                {{ event|safe }}
              {% endif -%}
            {% endfor -%}
          </div>
          {# See all events on mobile -#}
          <div class="flex mt-9 justify-self-center md:hidden md:mt-0">
            <a href="{{ past_events_link }}"
               hx-boost="true"
               hx-target="body"
               class="btn-secondary-anchor">See all events</a>
          </div>
          {# End see all events on mobile -#}
        </div>
      {% endif -%}
      {# End past events section -#}

      {# Organizers section - Full width -#}
      {% if !group.organizers.is_empty() -%}
        <div>
          <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-10 pb-8 lg:pt-2 lg:pb-14">
            Organizers
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for organizer in group.organizers -%}
              {% if organizer.name.is_some() -%}
                <user-chip user='{{ organizer|json }}'></user-chip>
              {% endif -%}
            {% endfor -%}
          </div>
        </div>
      {% endif -%}
      {# End organizers section -#}

      {# Sponsors section -#}
      {% if !group.sponsors.is_empty() -%}
        <div>
          <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-10 pb-8 lg:pt-2 lg:pb-14">
            Sponsors
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for sponsor in group.sponsors -%}
              {{ badges::sponsor_badge(name = sponsor.name, logo_url = sponsor.logo_url, website_url = sponsor.website_url) -}}
            {% endfor -%}
          </div>
        </div>
      {% endif -%}
      {# End sponsors section -#}

      {# Photo gallery -#}
      {% if let Some(photos_urls) = &group.photos_urls -%}
        {% if !photos_urls.is_empty() -%}
          <div>
            <div class="uppercase text-lg lg:text-2xl tracking-wide font-bold leading-10 pb-8 lg:pt-2 lg:pb-14">
              Gallery
            </div>
            <images-gallery title="Gallery" altImage="Group {{ group.name }}" images="{{ photos_urls|json }}"></images-gallery>
          </div>
        {% endif -%}
      {% endif -%}
      {# End photo gallery -#}

    </div>
  </div>
</div>

{# User info modal -#}
<user-info-modal></user-info-modal>
{% endblock content -%}
