{% import "macros/ui.html" as ui -%}

{# Header -#}
<header id="header" class="w-full" role="banner">
  {# Navigation bar -#}
  <nav class="flex items-center justify-between border-b border-transparent h-20 min-h-20"
       role="navigation"
       aria-label="Main navigation">
    <div class="flex items-center gap-x-6">
      {# Logo -#}
      {% if path != "/" %}<a href="/" aria-label="Go to homepage" class="inline-flex">{% endif %}
        <div class="inline-flex items-top gap-x-3 me-5">
          <img class="w-auto max-w-[208px] h-10 mt-[5px]"
               height="40"
               width="auto"
               src="{% if let Some(c) = &community %}{{ c.logo_url }}{% else %}{% if let Some(url) = &site_settings.header_logo_url %}{{ url }}{% endif %}{% endif %}"
               alt="{% if let Some(c) = &community %}{{ c.display_name }}{% else %}{{ site_settings.title }}{% endif %} logo" />
          {# Beta badge -#}
          <div>
            <div class="relative text-[0.7rem]/5 md:text-xs/6 tracking-widest rounded-full bg-stone-400/20 px-2 font-semibold">
              BETA
            </div>
          </div>
        </div>
        {% if path != "/" %}</a>{% endif %}
      {# End logo -#}

      {# Desktop links -#}
      <div class="hidden lg:flex lg:gap-x-8 relative mt-1.5">
        {{ link(content = "Home", href = "/", current_path = path) -}}
        {{ link(content = "Explore", href = "/explore", current_path = path) -}}
        {% if let Some(c) = &community -%}{% if c.new_group_details.is_some() -%}
        <button id="open-new-group-btn"
                class="mx-3 pb-1 border-0 border-primary-500 text-base font-semibold tracking-widest text-primary-500 uppercase border-b-2 border-transparent hover:border-primary-300 transition-colors">
          New group
        </button>
        <script type="module">
          import {
            toggleModalVisibility
          } from '/static/js/common/common.js';

          const openNewGroupBtn = document.getElementById('open-new-group-btn');
          if (openNewGroupBtn) {
            openNewGroupBtn.addEventListener('click', () => toggleModalVisibility('new-group-modal'));
          }
        </script>
        {% endif -%}{% endif -%}
      </div>
      {# End desktop links -#}
    </div>

    {# Desktop user menu -#}
    <div class="flex flex-1 justify-end">
      {% if page_id == PageId::SiteHome || page_id == PageId::SiteExplore || page_id == PageId::CommunityHome || page_id == PageId::Group || page_id == PageId::Event -%}
        <div hx-get="/section/user-menu"
             hx-trigger="load"
             hx-target="this"
             hx-boost="true"
             class="relative">
          <button class="relative group rounded-full cursor-pointer bg-white border text-xl border-primary-500 text-primary-700 size-[38px] p-0.5 overflow-hidden"
                  disabled>
            {{ ui::btn_spinner(id = "user-spinner", size = "size-[2.35rem]", spinner_type = "5", htmx = false) -}}
            <div class="svg-icon size-4 mx-auto bg-primary-500 icon-user"></div>
          </button>
        </div>
      {% else -%}
        {{ user_menu(user) -}}
      {% endif -%}
    </div>
    {# End desktop user menu -#}
  </nav>
  {# End navigation bar -#}
</header>
{# End header -#}

{# Link -#}
{% macro link(content, href, current_path, extra_styles = None) -%}
  {% let extra_styles_ = extra_styles.unwrap_or("") -%}

  <a href="{{ href }}"
     hx-boost="true"
     hx-target="body"
     class="mx-3 pb-1 border-0 border-primary-500 text-base font-semibold tracking-widest text-primary-500 uppercase border-b-2 transition-colors
            {% if current_path == href -%}
              border-primary-500{%- else -%}border-transparent hover:border-primary-300{%- endif -%} {{ extra_styles_ }}">{{ content }}</a>
{% endmacro link -%}
{# End link -#}

{# Button -#}
{% macro button(id, content, extra_styles = None) -%}
  {% let extra_styles_ = extra_styles.unwrap_or("") -%}

  <button id="{{ id }}"
          class="mx-3 pb-1 border-0 border-primary-500 text-base font-semibold tracking-widest text-primary-500 uppercase border-b-2 border-transparent hover:border-primary-300 transition-colors {{ extra_styles_ }}">
    {{ content }}
  </button>
{% endmacro button -%}
{# End button -#}

{# User menu macro -#}
{% macro user_menu(user) -%}
  <div class="relative">
    {% if user.logged_in -%}
      <button id="user-dropdown-button"
              data-logged-in="true"
              class="cursor-pointer group rounded-full bg-white border text-base leading-none border-primary-500 text-primary-700 hover:text-primary-900 hover:border-primary-900 size-[38px] p-0.5 overflow-hidden">
        <div class="font-semibold uppercase mt-px">
          {{ self::user_initials(user.name.as_deref() , user.username.as_deref().unwrap_or("")) }}
        </div>
      </button>

      {# User dropdown menu -#}
      <div id="user-dropdown"
           class="dropdown absolute hidden z-100 right-0 top-10 w-[250px] bg-white divide-y divide-stone-100 rounded-lg shadow border border-stone-200"
           role="menu">
        <ul class="text-stone-700 my-2" role="none">
          <li class="border-b border-stone-200 mb-2 pb-2" role="none">
            <div class="flex flex-col px-4 py-2">
              <div class="font-medium text-sm/6 truncate text-stone-700 mb-3">{{ user.username|assigned_or("") }}</div>
              <div class="text-xs/4 truncate">{{ user.name|assigned_or("") }}</div>
              {% if let Some(auth_provider) = &user.auth_provider -%}
                {% if auth_provider == "linuxfoundation" -%}
                  <a class="text-xs/6 text-stone-500 flex items-center mt-3"
                     href="https://openprofile.dev"
                     target="_blank"
                     rel="noopener noreferrer">
                    <div class="underline">openprofile.dev account</div>
                    <div class="svg-icon size-2.5 icon-external-link bg-stone-500 ms-2"></div>
                  </a>
                {% endif -%}
              {% endif -%}
            </div>
          </li>

          <li class="lg:hidden" role="none">
            <a href="/"
               hx-boost="true"
               hx-target="body"
               class="inline-block w-full text-start px-4 py-2 hover:bg-stone-100"
               role="menuitem">
              <div class="flex items-center">
                <div class="svg-icon size-4 icon-home bg-stone-600"></div>
                <div class="ms-2 text-xs/6">Home</div>
              </div>
            </a>
          </li>

          <li class="lg:hidden" role="none">
            <a href="/explore"
               hx-boost="true"
               hx-target="body"
               class="inline-block w-full text-start px-4 py-2 hover:bg-stone-100"
               role="menuitem">
              <div class="flex items-center">
                <div class="svg-icon size-4 icon-search bg-stone-600"></div>
                <div class="ms-2 text-xs/6">Explore</div>
              </div>
            </a>
          </li>

          {# Dashboard links -#}
          {% if user.belongs_to_community_team.unwrap_or(false) -%}
            <li class="hidden lg:block" role="none">
              <a href="/dashboard/community"
                 hx-boost="true"
                 hx-target="body"
                 class="inline-block w-full text-start px-4 py-2 hover:bg-stone-100"
                 role="menuitem">
                <div class="flex items-center">
                  <div class="svg-icon size-4 icon-buildings bg-stone-600"></div>
                  <div class="ms-2 text-xs/6">Community Dashboard</div>
                  <div class="ms-auto hx-spinner">{{ ui::spinner(size = "size-4") -}}</div>
                </div>
              </a>
            </li>
          {% endif -%}

          {% if user.belongs_to_any_group_team.unwrap_or(false) -%}
            <li class="hidden lg:block" role="none">
              <a href="/dashboard/group"
                 hx-boost="true"
                 hx-target="body"
                 class="inline-block w-full text-start px-4 py-2 hover:bg-stone-100"
                 role="menuitem">
                <div class="flex items-center">
                  <div class="svg-icon size-4 icon-groups bg-stone-600"></div>
                  <div class="ms-2 text-xs/6">Group Dashboard</div>
                  <div class="ms-auto hx-spinner">{{ ui::spinner(size = "size-4") -}}</div>
                </div>
              </a>
            </li>
          {% endif -%}

          <li class="hidden lg:block" role="none">
            <a href="/dashboard/user"
               hx-boost="true"
               hx-target="body"
               class="inline-block w-full text-start px-4 py-2 hover:bg-stone-100"
               role="menuitem">
              <div class="flex items-center">
                <div class="svg-icon size-4 icon-user-small bg-stone-600"></div>
                <div class="ms-2 text-xs/6">User Dashboard</div>
                <div class="ms-auto hx-spinner">{{ ui::spinner(size = "size-4") -}}</div>
              </div>
            </a>
          </li>

          {# Logout -#}
          <li class="border-t border-stone-200 mt-2 pt-2" role="none">
            <a href="/log-out"
               hx-boost="false"
               target="_self"
               class="inline-block w-full text-start px-4 py-2 hover:bg-stone-100"
               role="menuitem">
              <div class="flex items-center">
                <div class="svg-icon size-4 icon-logout bg-stone-600"></div>
                <div class="ms-2 text-xs/6">Log out</div>
              </div>
            </a>
          </li>
        </ul>
      </div>
    {% else -%}
      <button id="user-dropdown-button"
              data-logged-in="false"
              class="cursor-pointer group rounded-full bg-white border text-xl border-primary-500 text-primary-700 hover:text-primary-900 hover:border-primary-900 size-[38px] p-0.5 overflow-hidden">
        <div class="svg-icon size-4 mx-auto bg-primary-500 group-hover:bg-primary-900 icon-user"></div>
      </button>

      {# User dropdown menu for non-logged users -#}
      <div id="user-dropdown"
           class="dropdown absolute hidden z-100 right-0 top-10 w-[250px] bg-white divide-y divide-stone-100 rounded-lg shadow border border-stone-200"
           role="menu">
        <ul class="text-stone-700 my-2" role="none">
          <li class="lg:hidden" role="none">
            <a href="/"
               hx-boost="true"
               hx-target="body"
               class="inline-block w-full text-start px-4 py-2 hover:bg-stone-100"
               role="menuitem">
              <div class="flex items-center">
                <div class="svg-icon size-4 icon-home bg-stone-600"></div>
                <div class="ms-2 text-xs/6">Home</div>
              </div>
            </a>
          </li>

          <li class="lg:hidden border-b border-stone-200 mb-2 pb-2" role="none">
            <a href="/explore"
               hx-boost="true"
               hx-target="body"
               class="inline-block w-full text-start px-4 py-2 hover:bg-stone-100"
               role="menuitem">
              <div class="flex items-center">
                <div class="svg-icon size-4 icon-search bg-stone-600"></div>
                <div class="ms-2 text-xs/6">Explore</div>
              </div>
            </a>
          </li>

          {# Sign up -#}
          <li role="none">
            <a href="/sign-up"
               hx-boost="true"
               hx-target="body"
               class="inline-block w-full text-start px-4 py-2 hover:bg-stone-100"
               role="menuitem">
              <div class="flex items-center">
                <div class="svg-icon size-4 icon-user-plus bg-stone-600"></div>
                <div class="ms-2 text-xs/6">Sign up</div>
              </div>
            </a>
          </li>

          {# Log in -#}
          <li role="none">
            <a href="/log-in"
               hx-boost="true"
               hx-target="body"
               class="inline-block w-full text-start px-4 py-2 hover:bg-stone-100"
               role="menuitem">
              <div class="flex items-center">
                <div class="svg-icon size-4 icon-login bg-stone-600"></div>
                <div class="ms-2 text-xs/6">Log in</div>
              </div>
            </a>
          </li>
        </ul>
      </div>
    {% endif -%}

    {# Dropdown script -#}
    <script type="module">
      import {
        initUserDropdown
      } from '/static/js/common/header.js';

      initUserDropdown();
    </script>
  </div>
{% endmacro user_menu -%}
{# End user menu macro -#}
